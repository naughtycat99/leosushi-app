name: Build iOS Simulator App

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'

jobs:
  build-simulator:
    name: Build iOS Simulator App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Clean iOS build (force fresh build)
        run: |
          echo "üßπ Cleaning iOS build cache and old files..."
          rm -rf ios/App/build
          rm -rf ios/App/App.xcworkspace/xcuserdata
          rm -rf ios/App/App.xcodeproj/xcuserdata
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          # CRITICAL: Remove old public folder to force fresh copy
          echo "üìÅ Removing old public folder..."
          rm -rf ios/App/App/public
          echo "‚úÖ iOS cache and old files cleaned!"
      
      - name: Sync Capacitor
        run: |
          echo "üîÑ Syncing Capacitor to iOS..."
          npx cap sync ios
          echo "‚úÖ Capacitor sync completed!"
      
      - name: Verify mobile-app.js (no bottom nav)
        run: |
          echo "üîç Verifying mobile-app.js has correct code..."
          if grep -q "bottom-nav-bar" ios/App/App/public/js/mobile-app.js; then
            echo "‚ùå ERROR: mobile-app.js still has bottom nav code!"
            exit 1
          fi
          if grep -q "No custom bottom bar injection" ios/App/App/public/js/mobile-app.js; then
            echo "‚úÖ mobile-app.js is correct (no bottom nav)"
          else
            echo "‚ö†Ô∏è WARNING: mobile-app.js may not be correct"
            cat ios/App/App/public/js/mobile-app.js
            exit 1
          fi
      
      - name: Copy App Icons (AFTER sync to prevent overwrite)
        run: |
          echo "üì± Copying app icons to iOS project..."
          if [ -d "android/AppIcons/Assets.xcassets/AppIcon.appiconset/_" ]; then
            # Remove default Capacitor icons
            rm -rf ios/App/App/Assets.xcassets/AppIcon.appiconset/*
            # Copy all icon files including Contents.json
            cp -r android/AppIcons/Assets.xcassets/AppIcon.appiconset/* ios/App/App/Assets.xcassets/AppIcon.appiconset/
            echo "‚úÖ App icons copied successfully!"
            echo "üìã Icon files:"
            ls -la ios/App/App/Assets.xcassets/AppIcon.appiconset/
          else
            echo "‚ùå ERROR: App icons not found at android/AppIcons/Assets.xcassets/AppIcon.appiconset/_"
            exit 1
          fi
      
      - name: Build for Simulator
        run: |
          cd ios/App
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            DEVELOPMENT_TEAM=""
      
      - name: Package Simulator App
        run: |
          cd ios/App/build/Build/Products/Debug-iphonesimulator
          zip -r App.app.zip App.app
          mv App.app.zip $GITHUB_WORKSPACE/
      
      - name: Upload Simulator App
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: App.app.zip
          retention-days: 7
      
      - name: Build Summary
        run: |
          echo "‚úÖ iOS Simulator app built successfully!"
          echo ""
          echo "üì¶ Download App.app.zip from Artifacts"
          echo "üåê Upload to https://appetize.io/upload to test"
          echo ""
          echo "üì± Includes:"
          echo "   ‚úÖ LEO SUSHI app icons"
          echo "   ‚úÖ Cart button fix"
          echo "   ‚úÖ Mobile app CSS fixes"
          echo "   ‚úÖ All latest code"
