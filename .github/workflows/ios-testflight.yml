name: Build iOS and Upload to TestFlight

on:
  workflow_dispatch: # Cháº¡y thá»§ cÃ´ng

jobs:
  build-and-upload:
    name: Build iOS IPA and Upload to TestFlight
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build web assets
        run: npm run build
      
      - name: Add iOS platform (if not exists)
        run: |
          if [ ! -d "ios" ]; then
            echo "Adding iOS platform..."
            npx cap add ios
          else
            echo "iOS platform already exists"
          fi
        shell: bash
      
      - name: Sync Capacitor iOS
        run: npx cap sync ios
      
      - name: Copy iOS App Icons
        run: |
          echo "ðŸ“± Copying iOS app icons..."
          mkdir -p ios/App/App/Assets.xcassets/AppIcon.appiconset
          cp -v android/AppIcons/Assets.xcassets/AppIcon.appiconset/_/*.png ios/App/App/Assets.xcassets/AppIcon.appiconset/ || true
          
          cat > ios/App/App/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
          {
            "images" : [
              {"size":"20x20","idiom":"iphone","filename":"40.png","scale":"2x"},
              {"size":"20x20","idiom":"iphone","filename":"60.png","scale":"3x"},
              {"size":"29x29","idiom":"iphone","filename":"58.png","scale":"2x"},
              {"size":"29x29","idiom":"iphone","filename":"87.png","scale":"3x"},
              {"size":"40x40","idiom":"iphone","filename":"80.png","scale":"2x"},
              {"size":"40x40","idiom":"iphone","filename":"120.png","scale":"3x"},
              {"size":"60x60","idiom":"iphone","filename":"120.png","scale":"2x"},
              {"size":"60x60","idiom":"iphone","filename":"180.png","scale":"3x"},
              {"size":"1024x1024","idiom":"ios-marketing","filename":"1024.png","scale":"1x"}
            ],
            "info" : {"version":1,"author":"xcode"}
          }
          EOF
      
      - name: Setup Ruby and Fastlane
        run: gem install fastlane
      
      - name: Create App Store Connect API Key
        run: |
          mkdir -p ~/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}" > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
      
      - name: Install CocoaPods
        run: |
          cd ios/App
          pod install
      
      - name: Build and Upload using Fastlane
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios/App
          
          # Create Gemfile
          cat > Gemfile << 'EOF'
          source "https://rubygems.org"
          gem "fastlane"
          EOF
          
          # Create Fastfile
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)
          
          platform :ios do
            desc "Build and upload to TestFlight"
            lane :beta do
              # Setup App Store Connect API
              api_key = app_store_connect_api_key(
                key_id: ENV["API_KEY_ID"],
                issuer_id: ENV["API_ISSUER_ID"],
                key_filepath: "~/private_keys/AuthKey_#{ENV['API_KEY_ID']}.p8",
                duration: 1200,
                in_house: false
              )
              
              # Update code signing to automatic
              update_code_signing_settings(
                use_automatic_signing: true,
                path: "App.xcodeproj"
              )
              
              # Increment build number
              increment_build_number(
                xcodeproj: "App.xcodeproj"
              )
              
              # Build the app
              build_app(
                workspace: "App.xcworkspace",
                scheme: "App",
                export_method: "app-store"
              )
              
              # Upload to TestFlight
              upload_to_testflight(
                api_key: api_key,
                skip_waiting_for_build_processing: true
              )
            end
          end
          EOF
          
          # Run Fastlane
          fastlane beta
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/App/*.ipa
          retention-days: 30
        if: always()
      
      - name: Build summary
        run: |
          echo "### âœ… iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Name:** LEO SUSHI" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** com.leosushi.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **IPA uploaded to TestFlight!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **To test:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Open TestFlight app on iPhone" >> $GITHUB_STEP_SUMMARY
          echo "2. Find 'LEO SUSHI' app" >> $GITHUB_STEP_SUMMARY
          echo "3. Install and test!" >> $GITHUB_STEP_SUMMARY
