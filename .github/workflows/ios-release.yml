name: Build iOS Release (App Store)

on:
  workflow_dispatch: # Chá»‰ cháº¡y thá»§ cÃ´ng (cáº§n setup certificates trÆ°á»›c)
    inputs:
      build_number:
        description: 'Build number'
        required: false
        default: '1'

jobs:
  build-ios-release:
    name: Build iOS Release
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Build web assets
        run: npm run build
      
      - name: Add iOS platform (if not exists)
        run: |
          if [ ! -d "ios" ]; then
            npx cap add ios
          fi
        shell: bash
      
      - name: Copy iOS App Icons
        run: |
          echo "ðŸ“± Copying iOS app icons..."
          mkdir -p ios/App/App/Assets.xcassets/AppIcon.appiconset
          cp android/AppIcons/Assets.xcassets/AppIcon.appiconset/_/*.png ios/App/App/Assets.xcassets/AppIcon.appiconset/ || echo "Warning: Could not copy some icons"
          
          cat > ios/App/App/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
          {
            "images" : [
              {"size":"20x20","idiom":"iphone","filename":"40.png","scale":"2x"},
              {"size":"20x20","idiom":"iphone","filename":"60.png","scale":"3x"},
              {"size":"29x29","idiom":"iphone","filename":"58.png","scale":"2x"},
              {"size":"29x29","idiom":"iphone","filename":"87.png","scale":"3x"},
              {"size":"40x40","idiom":"iphone","filename":"80.png","scale":"2x"},
              {"size":"40x40","idiom":"iphone","filename":"120.png","scale":"3x"},
              {"size":"60x60","idiom":"iphone","filename":"120.png","scale":"2x"},
              {"size":"60x60","idiom":"iphone","filename":"180.png","scale":"3x"},
              {"size":"1024x1024","idiom":"ios-marketing","filename":"1024.png","scale":"1x"}
            ],
            "info" : {"version":1,"author":"xcode"}
          }
          EOF
          
          echo "âœ… iOS app icons copied"
        shell: bash
        continue-on-error: true
      
      - name: Sync Capacitor iOS
        run: npx cap sync ios
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Install CocoaPods dependencies
        run: |
          cd ios/App
          pod install
      
      - name: Build iOS Archive (Release)
        run: |
          cd ios/App
          
          # Build archive for App Store
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath build/App.xcarchive \
            -destination 'generic/platform=iOS' \
            clean archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        continue-on-error: true
      
      - name: Create IPA (if archive succeeded)
        run: |
          cd ios/App
          
          if [ -d "build/App.xcarchive" ]; then
            # Export IPA
            xcodebuild \
              -exportArchive \
              -archivePath build/App.xcarchive \
              -exportPath build/IPA \
              -exportOptionsPlist exportOptions.plist \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO
          else
            echo "Archive not found, skipping IPA creation"
          fi
        continue-on-error: true
      
      - name: Upload iOS Archive
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: ios/App/build/App.xcarchive
          retention-days: 30
        continue-on-error: true
      
      - name: Build summary
        run: |
          echo "### âš ï¸ iOS Release Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Name:** LEO SUSHI" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** com.leosushi.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** This build is unsigned!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **To submit to App Store, you need:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Apple Developer Account (\$99/year)" >> $GITHUB_STEP_SUMMARY
          echo "2. Distribution Certificate" >> $GITHUB_STEP_SUMMARY
          echo "3. Provisioning Profile" >> $GITHUB_STEP_SUMMARY
          echo "4. Build on Mac with Xcode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Alternative: Use Fastlane or EAS Build**" >> $GITHUB_STEP_SUMMARY
          echo "- Fastlane: Automate signing & upload" >> $GITHUB_STEP_SUMMARY
          echo "- EAS Build: Expo's cloud build service" >> $GITHUB_STEP_SUMMARY
