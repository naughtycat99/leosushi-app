<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEO SUSHI - Admin Panel</title>
    <meta name="theme-color" content="#0b0b0c">
    <link rel="icon" href="assets/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            background: #0a0a0b;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Touch-friendly elements */
        button, .btn-action, .filter-btn, .admin-tab {
            -webkit-tap-highlight-color: rgba(229, 207, 142, 0.2);
            touch-action: manipulation;
        }
        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }
        .admin-header {
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.95), rgba(15, 15, 17, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 207, 142, 0.15);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(229, 207, 142, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        .admin-header > div:first-child {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(229, 207, 142, 0.5) 20%, 
                var(--gold) 50%, 
                rgba(229, 207, 142, 0.5) 80%, 
                transparent 100%);
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .admin-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(229, 207, 142, 0.03) 0%, transparent 70%);
            pointer-events: none;
        }
        .admin-header h1 {
            font-family: "Playfair Display", serif;
            font-size: 36px;
            margin: 0 0 8px 0;
            background: linear-gradient(135deg, #ffffff 0%, var(--gold) 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
        }
        .admin-header p {
            position: relative;
            z-index: 1;
        }
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }
        .stat-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.03) 0%, 
                rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 207, 142, 0.12);
            border-radius: 16px;
            padding: 28px 24px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: default;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(229, 207, 142, 0.08) 0%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, 
                rgba(229, 207, 142, 0.3), 
                rgba(251, 191, 36, 0.1));
            border-radius: 16px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: -1;
        }
        .stat-card:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(229, 207, 142, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(229, 207, 142, 0.2),
                0 4px 20px rgba(194, 163, 85, 0.15);
        }
        .stat-card:hover::before {
            opacity: 1;
        }
        .stat-card:hover::after {
            opacity: 1;
        }
        .stat-card-revenue {
            background: linear-gradient(135deg, 
                rgba(229, 207, 142, 0.12) 0%, 
                rgba(229, 207, 142, 0.05) 100%);
            border-color: rgba(229, 207, 142, 0.25);
        }
        .stat-card-revenue::before {
            background: linear-gradient(135deg, 
                rgba(229, 207, 142, 0.15) 0%, 
                transparent 100%);
        }
        .stat-icon {
            font-size: 36px;
            margin-bottom: 16px;
            opacity: 0.9;
            filter: drop-shadow(0 2px 8px rgba(229, 207, 142, 0.3));
            transition: transform 0.3s;
        }
        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .stat-sublabel {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 10px;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, var(--gold) 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            letter-spacing: -1px;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.75);
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.2px;
            text-transform: uppercase;
        }
        .admin-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .admin-sidebar {
            width: 200px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.95), rgba(15, 15, 17, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 207, 142, 0.15);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(229, 207, 142, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 24px;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
        }
        .admin-tabs {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .admin-tab {
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-left: 3px solid transparent;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            letter-spacing: 0.2px;
            text-align: left;
            width: 100%;
        }
        .admin-tab::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, 
                transparent 0%, 
                var(--gold) 50%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .admin-tab.active {
            color: var(--gold);
            background: rgba(229, 207, 142, 0.1);
            border-left-color: var(--gold);
        }
        .admin-tab.active::before {
            opacity: 1;
        }
        .admin-tab:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.05);
        }
        .admin-tab.active:hover {
            color: var(--gold);
            background: rgba(229, 207, 142, 0.15);
        }
        .admin-main-content {
            flex: 1;
            min-width: 0;
        }
        .admin-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .filter-input {
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 207, 142, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
        }
        .filter-input:focus {
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(229, 207, 142, 0.1);
        }
        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        /* Improved select dropdown styling */
        select.filter-input {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 2px solid rgba(229, 207, 142, 0.3) !important;
            color: #fff !important;
            cursor: pointer;
        }
        select.filter-input option {
            background: #1a1a1c;
            color: #fff;
            padding: 12px;
        }
        select.filter-input:focus {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: var(--gold) !important;
        }
        .filter-btn {
            padding: 12px 20px;
            background: rgba(194, 163, 85, 0.08);
            border: 1px solid rgba(194, 163, 85, 0.25);
            border-radius: 10px;
            color: rgba(229, 207, 142, 0.9);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }
        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.5s;
        }
        .filter-btn:hover::before {
            left: 100%;
        }
        .filter-btn:hover {
            background: rgba(194, 163, 85, 0.15);
            border-color: rgba(194, 163, 85, 0.4);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(194, 163, 85, 0.2);
        }
        .filter-btn.active {
            background: linear-gradient(135deg, var(--gold), #fbbf24);
            color: #1a1a1a;
            border-color: var(--gold);
            box-shadow: 0 4px 16px rgba(194, 163, 85, 0.3);
        }
        .filter-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(194, 163, 85, 0.4);
        }
        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }
        .orders-list, .reservations-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        @media (max-width: 768px) {
            .orders-list, .reservations-list {
                gap: 12px;
            }
        }
        .order-card, .reservation-card {
            background: linear-gradient(135deg, 
                rgba(18, 18, 20, 0.8) 0%, 
                rgba(15, 15, 17, 0.8) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 207, 142, 0.15);
            border-radius: 18px;
            padding: 28px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .order-card::before, .reservation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--gold) 50%, 
                transparent 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .order-card::after, .reservation-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(229, 207, 142, 0.08) 0%, 
                transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        .order-card:hover, .reservation-card:hover {
            border-color: rgba(229, 207, 142, 0.4);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(229, 207, 142, 0.2),
                0 8px 24px rgba(194, 163, 85, 0.2);
            transform: translateY(-4px);
        }
        .order-card:hover::before, .reservation-card:hover::before {
            opacity: 1;
        }
        .order-card:hover::after, .reservation-card:hover::after {
            opacity: 1;
        }
        .order-card.pending {
            border-left: 5px solid #fbbf24;
            background: linear-gradient(135deg, 
                rgba(18, 18, 20, 0.85) 0%, 
                rgba(251, 191, 36, 0.03) 100%);
        }
        .order-card.confirmed {
            border-left: 5px solid #10b981;
            background: linear-gradient(135deg, 
                rgba(18, 18, 20, 0.85) 0%, 
                rgba(16, 185, 129, 0.03) 100%);
        }
        .order-card.cancelled {
            border-left: 5px solid #ef4444;
            background: linear-gradient(135deg, 
                rgba(18, 18, 20, 0.85) 0%, 
                rgba(239, 68, 68, 0.03) 100%);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(229, 207, 142, 0.1);
        }
        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }
        .card-title::before {
            content: var(--icon, 'üìã');
            font-size: 20px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        .card-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending {
            background: rgba(251, 191, 36, .2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, .3);
        }
        .status-confirmed {
            background: rgba(16, 185, 129, .2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, .3);
        }
        .status-cancelled {
            background: rgba(239, 68, 68, .2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, .3);
        }
        .card-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .card-info {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        .info-item {
            font-size: 14px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(229, 207, 142, 0.05);
            transition: all 0.3s ease;
        }
        .info-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(229, 207, 142, 0.15);
        }
        .info-label {
            color: rgba(255,255,255,.6);
            margin-right: 8px;
            font-weight: 500;
            display: inline-block;
            min-width: 100px;
        }
        .info-value {
            color: #fff;
            font-weight: 600;
            word-break: break-word;
        }
        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-action {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }
        .btn-action::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-action:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-confirm {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        .btn-confirm:active {
            transform: translateY(0);
        }
        .btn-cancel {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .btn-cancel:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .btn-view {
            background: rgba(194, 163, 85, 0.12);
            color: var(--gold);
            border: 1px solid rgba(194, 163, 85, 0.3);
        }
        .btn-view:hover {
            background: rgba(194, 163, 85, 0.2);
            border-color: rgba(194, 163, 85, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(194, 163, 85, 0.3);
        }
        .items-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(229,207,142,.1);
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        .item-name {
            color: rgba(255,255,255,.9);
        }
        .item-price {
            color: var(--gold);
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 100px 40px;
            color: rgba(255, 255, 255, 0.5);
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.02) 0%, 
                rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 2px dashed rgba(229, 207, 142, 0.15);
            position: relative;
            overflow: hidden;
        }
        .empty-state::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(229, 207, 142, 0.05) 0%, 
                transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.7;
            filter: drop-shadow(0 4px 12px rgba(229, 207, 142, 0.2));
            position: relative;
            z-index: 1;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(229,207,142,.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #fbbf24);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #1a1a1a;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 
                0 8px 24px rgba(194, 163, 85, 0.4),
                0 0 0 0 rgba(194, 163, 85, 0.5);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 
                0 12px 32px rgba(194, 163, 85, 0.5),
                0 0 0 8px rgba(194, 163, 85, 0.1);
        }
        .refresh-btn:active {
            transform: rotate(180deg) scale(0.95);
        }
        /* New Order Notification */
        .new-order-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.98), rgba(15, 15, 17, 0.98));
            backdrop-filter: blur(20px);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 20px 24px;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(229, 207, 142, 0.3),
                0 8px 24px rgba(194, 163, 85, 0.3);
            z-index: 10000;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            transition: all 0.3s;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        .new-order-notification.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }
        .new-order-notification:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(229, 207, 142, 0.4),
                0 12px 32px rgba(194, 163, 85, 0.4);
        }
        .notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .notification-icon {
            font-size: 32px;
            animation: bounce 0.6s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .notification-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gold);
            margin: 0;
            flex: 1;
        }
        .notification-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }
        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .notification-content {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            line-height: 1.5;
        }
        .notification-order-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(229, 207, 142, 0.2);
        }
        .notification-order-item {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }
        .notification-order-label {
            color: rgba(255, 255, 255, 0.6);
        }
        .notification-order-value {
            color: #fff;
            font-weight: 600;
        }
        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        .notification-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .notification-btn-view {
            background: rgba(194, 163, 85, 0.2);
            color: var(--gold);
            border: 1px solid rgba(194, 163, 85, 0.3);
        }
        .notification-btn-view:hover {
            background: rgba(194, 163, 85, 0.3);
        }
        .notification-btn-confirm {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }
        .notification-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        @media (max-width: 768px) {
            .new-order-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
            }
            .notification-actions {
                flex-direction: column;
            }
            .notification-btn {
                width: 100%;
            }
        }
        
        .time-schedule-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .time-schedule-modal.active {
            display: flex;
        }
        .time-schedule-content {
            background: linear-gradient(145deg, #121214, #0f0f11);
            border: 1px solid rgba(229,207,142,.2);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .time-schedule-content h3 {
            font-family: "Playfair Display", serif;
            font-size: 24px;
            margin: 0 0 20px 0;
            color: #fff;
        }
        .time-schedule-content p {
            color: rgba(255,255,255,.7);
            margin: 0 0 24px 0;
            font-size: 14px;
        }
        .time-input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        .time-input {
            padding: 12px 16px;
            background: rgba(255,255,255,.05);
            border: 1.5px solid rgba(229,207,142,.2);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            outline: none;
            width: 80px;
            text-align: center;
        }
        .time-input:focus {
            border-color: var(--gold);
            background: rgba(255,255,255,.08);
        }
        .time-separator {
            color: rgba(255,255,255,.5);
            font-size: 20px;
        }
        .quick-time-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        }
        .quick-time-btn {
            padding: 8px 16px;
            background: rgba(194,163,85,.1);
            border: 1px solid rgba(194,163,85,.3);
            border-radius: 8px;
            color: var(--gold);
            font-size: 14px;
            cursor: pointer;
            transition: all .3s;
        }
        .quick-time-btn:hover {
            background: rgba(194,163,85,.2);
        }
        .time-schedule-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .btn-schedule {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s;
        }
        .btn-schedule:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16,185,129,.4);
        }
        .btn-cancel-schedule {
            padding: 12px 24px;
            background: rgba(239, 68, 68, .2);
            border: 1px solid rgba(239, 68, 68, .3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s;
        }
        .btn-cancel-schedule:hover {
            background: rgba(239, 68, 68, .3);
        }
        .admin-login-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .admin-login-content {
            background: linear-gradient(145deg, #121214, #0f0f11);
            border: 1px solid rgba(229,207,142,.2);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .admin-login-content h2 {
            font-family: "Playfair Display", serif;
            font-size: 24px;
            margin: 0 0 20px 0;
            color: #fff;
        }
        .admin-password-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,.05);
            border: 1.5px solid rgba(229,207,142,.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
        }
        .admin-password-input:focus {
            border-color: var(--gold);
            background: rgba(255,255,255,.08);
        }
        @media (max-width: 768px) {
            .admin-container {
                padding: 12px;
                max-width: 100%;
            }
            
            /* Header Mobile */
            .admin-header {
                padding: 20px 16px;
                margin-bottom: 20px;
                border-radius: 16px;
            }
            .admin-header > div:first-child {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }
            .admin-header h1 {
                font-size: 22px;
                margin-bottom: 4px;
            }
            .admin-header p {
                font-size: 12px;
            }
            #adminStatus {
                display: block;
                margin: 8px 0 0 0 !important;
            }
            #logoutBtn {
                width: 100%;
                margin-top: 8px;
            }
            
            /* Stats Mobile - 2 columns */
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-top: 20px;
            }
            .stat-card {
                padding: 16px 12px;
                border-radius: 12px;
            }
            .stat-icon {
                font-size: 28px;
                margin-bottom: 8px;
            }
            .stat-value {
                font-size: 24px;
                margin-bottom: 6px;
            }
            .stat-label {
                font-size: 11px;
                line-height: 1.3;
            }
            .stat-sublabel {
                font-size: 10px;
                margin-top: 6px;
            }
            
            /* Layout Mobile */
            .admin-layout {
                flex-direction: column;
            }
            .admin-sidebar {
                width: 100%;
                position: relative;
                max-height: none;
                margin-bottom: 24px;
            }
            /* Tabs Mobile */
            .admin-tabs {
                flex-direction: row;
                gap: 4px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .admin-tabs::-webkit-scrollbar {
                display: none;
            }
            .admin-tab {
                padding: 12px 16px;
                font-size: 13px;
                white-space: nowrap;
                flex-shrink: 0;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .admin-tab.active {
                border-left: none;
                border-bottom-color: var(--gold);
            }
            
            /* Filters Mobile */
            .admin-filters {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                margin-bottom: 16px;
            }
            .filter-group {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }
            .filter-input {
                width: 100%;
                padding: 10px 14px;
                font-size: 14px;
            }
            .filter-btn {
                padding: 10px 14px;
                font-size: 12px;
                flex: 1;
                min-width: calc(50% - 4px);
            }
            
            /* Order Cards Mobile */
            .order-card, .reservation-card {
                padding: 16px;
                border-radius: 14px;
            }
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 12px;
            }
            .card-title {
                font-size: 18px;
                width: 100%;
            }
            .card-status {
                align-self: flex-start;
                font-size: 11px;
                padding: 4px 10px;
            }
            .card-info {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 12px;
            }
            .info-item {
                font-size: 13px;
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
            }
            .info-label {
                min-width: 80px;
            }
            .info-value {
                flex: 1;
                word-break: break-word;
            }
            .items-list {
                margin-top: 12px;
                padding-top: 12px;
            }
            .item-row {
                font-size: 13px;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .card-actions {
                width: 100%;
                flex-direction: column;
                gap: 8px;
                margin-top: 12px;
            }
            .btn-action {
                flex: 1;
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }
            
            /* Empty State Mobile */
            .empty-state {
                padding: 60px 20px;
                border-radius: 16px;
            }
            .empty-state-icon {
                font-size: 56px;
                margin-bottom: 16px;
            }
            .empty-state h3 {
                font-size: 16px !important;
            }
            .empty-state p {
                font-size: 13px !important;
            }
            
            /* Refresh Buttons Mobile */
            .refresh-btn {
                width: 56px;
                height: 56px;
                font-size: 22px;
                bottom: 16px;
                right: 16px;
                box-shadow: 0 6px 20px rgba(194, 163, 85, 0.4);
            }
            .refresh-btn[style*="right: 100px"] {
                right: 80px !important;
            }
            .refresh-btn[style*="right: 170px"] {
                right: 150px !important;
            }
            
            /* Modal Mobile */
            .time-schedule-content {
                padding: 24px 20px;
                margin: 20px;
                max-width: calc(100% - 40px);
            }
            .time-schedule-content h3 {
                font-size: 20px;
                margin-bottom: 12px;
            }
            .time-schedule-content p {
                font-size: 13px;
                margin-bottom: 20px;
            }
            .time-input-group {
                gap: 8px;
                margin-bottom: 20px;
            }
            .time-input {
                width: 70px;
                padding: 10px;
                font-size: 16px;
            }
            .quick-time-buttons {
                gap: 6px;
                margin-bottom: 20px;
            }
            .quick-time-btn {
                padding: 8px 12px;
                font-size: 12px;
                flex: 1;
                min-width: calc(33.333% - 4px);
            }
            .time-schedule-actions {
                flex-direction: column;
                gap: 10px;
            }
            .btn-schedule, .btn-cancel-schedule {
                width: 100%;
                padding: 14px;
            }
            
            /* Login Modal Mobile */
            .admin-login-content {
                padding: 30px 20px;
                margin: 20px;
                max-width: calc(100% - 40px);
            }
            
            /* Success Notification Mobile */
            .admin-success-content {
                padding: 24px 20px;
                margin: 20px;
                max-width: calc(100% - 40px);
            }
            .admin-success-title {
                font-size: 24px;
            }
            .admin-success-message {
                font-size: 14px;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .admin-container {
                padding: 8px;
            }
            .admin-header {
                padding: 16px 12px;
            }
            .admin-header h1 {
                font-size: 20px;
            }
            .admin-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .stat-card {
                padding: 14px 10px;
            }
            .stat-value {
                font-size: 22px;
            }
            .filter-btn {
                min-width: calc(50% - 4px);
                font-size: 11px;
                padding: 8px 10px;
            }
            .order-card, .reservation-card {
                padding: 14px;
            }
            .card-title {
                font-size: 16px;
            }
            .info-item {
                font-size: 12px;
            }
            .refresh-btn {
                width: 52px;
                height: 52px;
                font-size: 20px;
                bottom: 12px;
                right: 12px;
            }
            .refresh-btn[style*="right: 100px"] {
                right: 70px !important;
            }
            .refresh-btn[style*="right: 170px"] {
                right: 130px !important;
            }
        }
        
        /* Improve scrolling on mobile */
        @media (max-width: 768px) {
            html {
                -webkit-overflow-scrolling: touch;
            }
            body {
                overflow-x: hidden;
            }
            .admin-container {
                overflow-x: hidden;
            }
        }
        
        /* Better touch targets */
        @media (max-width: 768px) {
            .btn-action, .filter-btn, .admin-tab {
                min-height: 44px;
            }
            .time-input {
                min-height: 44px;
            }
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Login Modal -->
        <div id="adminLoginModal" class="admin-login-modal" style="display: none;">
            <div class="admin-login-content">
                <h2>üîê Admin Login</h2>
                
                <!-- Step 1: Password -->
                <div id="loginStep1" style="display: block;">
                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 20px; text-align: center;">
                        Sichere Anmeldung mit E-Mail-Best√§tigung
                    </p>
                    <input type="password" id="adminPassword" class="admin-password-input" placeholder="Passwort eingeben" autocomplete="current-password" onkeypress="if(event.key==='Enter') handleAdminLogin()">
                    <button class="btn-action btn-confirm" onclick="handleAdminLogin()">Weiter</button>
                </div>
                
                <!-- Step 2: Verification Code -->
                <div id="loginStep2" style="display: none;">
                    <p style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 20px; text-align: center;">
                        Best√§tigungscode wurde an Ihre E-Mail gesendet
                    </p>
                    <input type="text" id="adminVerificationCode" class="admin-password-input" placeholder="6-stelliger Code eingeben" maxlength="6" style="text-align: center; letter-spacing: 8px; font-size: 20px; font-weight: 600;" onkeypress="if(event.key==='Enter') handleVerifyCode()">
                    <button class="btn-action btn-confirm" onclick="handleVerifyCode()" style="margin-top: 10px;">Code best√§tigen</button>
                    <button class="btn-action btn-secondary" onclick="resendVerificationCode()" style="margin-top: 10px; background: rgba(255,255,255,.1);">Code erneut senden</button>
                    <button class="btn-action" onclick="backToPasswordStep()" style="margin-top: 10px; background: transparent; border: 1px solid rgba(255,255,255,.2); color: rgba(255,255,255,.6);">Zur√ºck</button>
                </div>
                
                <p style="color: rgba(255, 255, 255, 0.4); font-size: 11px; margin-top: 16px; text-align: center;">
                    ‚ö†Ô∏è Nach 5 fehlgeschlagenen Versuchen wird der Zugang gesperrt
                </p>
            </div>
        </div>

        <div class="admin-header">
            <div>
                <div>
                    <h1>üç£ LEO SUSHI Admin Panel</h1>
                    <p style="color: rgba(255,255,255,.7); margin: 0;">Verwaltung von Bestellungen und Reservierungen</p>
                </div>
                <div style="margin-top: 12px;">
                    <span id="adminStatus" style="color: rgba(255,255,255,.7); display: block; margin-bottom: 8px;"></span>
                    <button class="btn-action btn-view" onclick="handleAdminLogout()" id="logoutBtn" style="display: none; width: auto;">Abmelden</button>
                </div>
            </div>
            <div class="admin-stats" id="adminStats">
                <!-- Stats will be loaded dynamically -->
            </div>
        </div>

        <div class="admin-layout">
            <div class="admin-sidebar">
        <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchTab('orders')">üì¶ Bestellungen</button>
                    <button class="admin-tab" onclick="switchTab('reservations')">üìÖ Reservierungen</button>
                    <button class="admin-tab" onclick="switchTab('customers')">üë• Kunden</button>
                    <button class="admin-tab" onclick="switchTab('menu')">üç£ Menu</button>
                    <button class="admin-tab" onclick="switchTab('discount-codes')">üéÅ Rabattcodes</button>
                    <button class="admin-tab" onclick="switchTab('promotions')">‚≠ê Punkte einl√∂sen</button>
                    <button class="admin-tab" onclick="switchTab('holiday-schedule')">üìÖ Feiertags-√ñffnungszeiten</button>
                </div>
        </div>

            <div class="admin-main-content">
        <div id="ordersContent" class="admin-content active">
            <div class="admin-filters">
                <div class="filter-group">
                    <input type="text" id="orderSearch" class="filter-input" placeholder="üîç Suchen (Name, Telefon, ID...)" onkeyup="filterOrders()" style="min-width: 250px;">
                </div>
                <div class="filter-group">
                    <select id="dateFilter" class="filter-input" onchange="applyDateFilter()" style="min-width: 150px;">
                        <option value="all">Alle Zeit</option>
                        <option value="today" selected>Heute</option>
                        <option value="week">Letzte 7 Tage</option>
                        <option value="month">Letzte 30 Tage</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                    <input type="date" id="customDateStart" class="filter-input" style="display: none; min-width: 150px;" onchange="applyDateFilter()">
                    <input type="date" id="customDateEnd" class="filter-input" style="display: none; min-width: 150px;" onchange="applyDateFilter()">
                </div>
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterOrdersByStatus('all')" data-status="all">Alle</button>
                    <button class="filter-btn" onclick="filterOrdersByStatus('pending')" data-status="pending">Ausstehend</button>
                    <button class="filter-btn" onclick="filterOrdersByStatus('confirmed')" data-status="confirmed">Best√§tigt</button>
                    <button class="filter-btn" onclick="filterOrdersByStatus('cancelled')" data-status="cancelled">Storniert</button>
                </div>
            </div>
            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded dynamically -->
            </div>
        </div>

        <div id="reservationsContent" class="admin-content">
            <div class="admin-filters">
                <div class="filter-group">
                    <input type="text" id="reservationSearch" class="filter-input" placeholder="üîç Suchen (Name, Telefon, ID...)" onkeyup="filterReservations()" style="min-width: 250px;">
                </div>
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterReservationsByStatus('all')" data-status="all">Alle</button>
                    <button class="filter-btn" onclick="filterReservationsByStatus('pending')" data-status="pending">Ausstehend</button>
                    <button class="filter-btn" onclick="filterReservationsByStatus('confirmed')" data-status="confirmed">Best√§tigt</button>
                    <button class="filter-btn" onclick="filterReservationsByStatus('cancelled')" data-status="cancelled">Storniert</button>
                </div>
            </div>
            <div class="reservations-list" id="reservationsList">
                <!-- Reservations will be loaded dynamically -->
            </div>
        </div>

        <div id="customersContent" class="admin-content">
            <div class="admin-filters">
                <div class="filter-group">
                    <input type="text" id="customerSearch" class="filter-input" placeholder="üîç Suchen (Name, E-Mail, Telefon, Kunden-Code...)" onkeyup="filterCustomers()" style="min-width: 250px;">
                </div>
                <div class="filter-group">
                    <button class="btn-action" onclick="loadCustomers()" style="background: rgba(229, 207, 142, 0.15); color: rgba(229, 207, 142, 0.95); border: 1px solid rgba(229, 207, 142, 0.3); font-weight: 600;">üîÑ Aktualisieren</button>
            </div>
            </div>
            <div class="customers-list" id="customersListContainer">
                <!-- Customers will be loaded dynamically -->
            </div>
        </div>

        <div id="menuContent" class="admin-content">
            <div class="admin-filters">
                <div class="filter-group">
                    <select id="menuCategoryFilter" class="filter-input" onchange="filterMenuByCategory()" style="min-width: 200px;">
                        <option value="">Alle Kategorien</option>
                    </select>
                    <input type="text" id="menuSearch" class="filter-input" placeholder="üîç Suchen (Name, Rabattcode...)" onkeyup="filterMenuItems()" style="min-width: 250px;">
                </div>
                <div class="filter-group">
                    <button class="btn-action" onclick="loadMenuItems()" style="background: rgba(229, 207, 142, 0.1);">üîÑ Aktualisieren</button>
                    <button class="btn-action" onclick="showAddMenuItemModal()" style="background: rgba(34, 197, 94, 0.1);">‚ûï Neues Men√º-Item</button>
                </div>
            </div>
            <div class="menu-items-list" id="menuItemsList">
                <!-- Menu items will be loaded dynamically -->
            </div>
        </div>

        <div id="discount-codesContent" class="admin-content">
            <div class="admin-filters">
                <div class="filter-group">
                    <input type="text" id="discountCodeSearch" class="filter-input" placeholder="üîç Suchen (Code, Status...)" onkeyup="filterDiscountCodes()" style="min-width: 250px;">
                    <select id="discountCodeStatusFilter" class="filter-input" onchange="filterDiscountCodes()" style="min-width: 150px;">
                        <option value="">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="inactive">Inaktiv</option>
                        <option value="expired">Abgelaufen</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn-action" onclick="loadDiscountCodes()" style="background: rgba(229, 207, 142, 0.1);">üîÑ Aktualisieren</button>
                    <button class="btn-action" onclick="showAddDiscountCodeModal()" style="background: rgba(34, 197, 94, 0.1);">‚ûï Neuer Code</button>
                </div>
            </div>
            <div class="discount-codes-list" id="discountCodesList">
                <!-- Discount codes will be loaded dynamically -->
            </div>
        </div>

        <div id="promotionsContent" class="admin-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="color: var(--gold); margin: 0; font-family: 'Playfair Display', serif;">‚≠ê Einl√∂sungsregeln verwalten</h2>
                <button class="btn-action" onclick="showAddRedemptionRuleModal()" style="background: linear-gradient(135deg, var(--gold), #d4af37);">
                    ‚ûï Neue Regel hinzuf√ºgen
                </button>
            </div>
            
            <div id="redemptionRulesList" style="display: grid; gap: 16px;">
                <p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Lade Einl√∂sungsregeln...</p>
            </div>
        </div>

        <div id="holiday-scheduleContent" class="admin-content">
            <div class="admin-filters">
                <div class="filter-group">
                    <input type="text" id="holidaySearch" class="filter-input" placeholder="üîç Suchen (Datum, Notiz...)" onkeyup="filterHolidaySchedule()" style="min-width: 250px;">
                    <select id="holidayStatusFilter" class="filter-input" onchange="filterHolidaySchedule()" style="min-width: 150px;">
                        <option value="">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="inactive">Inaktiv</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn-action" onclick="loadHolidaySchedule()" style="background: rgba(229, 207, 142, 0.1);">üîÑ Aktualisieren</button>
                    <button class="btn-action" onclick="showAddHolidayModal()" style="background: rgba(34, 197, 94, 0.1);">‚ûï Neuer Feiertag</button>
                </div>
            </div>
            <div class="holiday-schedule-list" id="holidayScheduleList">
                <p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Lade Feiertags-√ñffnungszeiten...</p>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadAllData()" title="Aktualisieren" style="right: 30px;">üîÑ</button>
    <button class="refresh-btn" onclick="exportAllData()" title="Daten exportieren" style="right: 100px;">üì•</button>
    <button class="refresh-btn" onclick="testNotificationSound()" title="Ton testen" style="right: 170px; background: linear-gradient(135deg, #10b981, #059669);">üîä</button>

    <!-- Time Schedule Modal -->
    <div id="timeScheduleModal" class="time-schedule-modal" onclick="if(event.target.id === 'timeScheduleModal') closeTimeScheduleModal()">
        <div class="time-schedule-content" onclick="event.stopPropagation()">
            <h3>‚è∞ Geplante Zeit f√ºr Kunde</h3>
            <p>Geben Sie die voraussichtliche Zeit ein, die an den Kunden gesendet werden soll</p>
            <div class="time-input-group">
                <input type="number" id="scheduleHours" class="time-input" min="0" max="23" value="0" placeholder="Stunde">
                <span class="time-separator">:</span>
                <input type="number" id="scheduleMinutes" class="time-input" min="0" max="59" value="30" placeholder="Minute">
            </div>
            <div class="quick-time-buttons">
                <button class="quick-time-btn" onclick="setQuickTime(20)">20 Min.</button>
                <button class="quick-time-btn" onclick="setQuickTime(25)">25 Min.</button>
                <button class="quick-time-btn" onclick="setQuickTime(30)">30 Min.</button>
                <button class="quick-time-btn" onclick="setQuickTime(35)">35 Min.</button>
                <button class="quick-time-btn" onclick="setQuickTime(40)">40 Min.</button>
                <button class="quick-time-btn" onclick="setQuickTime(45)">45 Min.</button>
            </div>
            <div class="time-schedule-actions">
                <button class="btn-schedule" onclick="confirmWithScheduledTime()">Best√§tigen & E-Mail senden</button>
                <button class="btn-cancel-schedule" onclick="closeTimeScheduleModal()">Abbrechen</button>
            </div>
        </div>
            </div> <!-- End admin-main-content -->
        </div> <!-- End admin-layout -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Load modules in Abh√§ngigkeitsreihenfolge (WICHTIG - Reihenfolge nicht √§ndern!) -->
    <!-- Backup: Bei Fehlern die folgenden Zeilen auskommentieren und die Zeile auskommentieren: <script src="script.js"></script> -->
    <script src="js/config.js"></script>
    <script src="js/menu-data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/reservation.js"></script>
    <script src="js/payment.js"></script>
    <script src="js/firebase.js"></script>
    <!-- Load script.js for Firebase functions (getAllOrdersFromFirebase, getAllReservationsFromFirebase, etc.) -->
    <script src="script.js"></script>
    <script src="js/email.js"></script>
    <script src="js/customer.js"></script>
    <script src="js/main.js"></script>
    <!-- <script src="script.js"></script> --> <!-- Backup: Auskommentieren bei Bedarf f√ºr Rollback -->
    
    <script>
        // Initialize EmailJS
        if (typeof emailjs !== 'undefined' && EMAILJS_CONFIG) {
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
        }

        // Switch between tabs
        function switchTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Content').classList.add('active');
            
            // Load customers when switching to customers tab
            if (tab === 'customers') {
                loadCustomers();
            }
            
            // Load menu when switching to menu tab
            if (tab === 'menu') {
                loadMenuItems();
                loadMenuCategories();
            }
            
            // Load redemption rules and customers with points when switching to promotions tab
            if (tab === 'promotions') {
                loadCustomersWithPoints();
            }
            
            // Load discount codes when switching to discount-codes tab
            if (tab === 'discount-codes') {
                loadDiscountCodes();
            }
            
            // Load holiday schedule when switching to holiday-schedule tab
            if (tab === 'holiday-schedule') {
                loadHolidaySchedule();
            }
        }

        // ========== DISCOUNT CODES MANAGEMENT ==========
        let allDiscountCodes = [];

        async function loadDiscountCodes() {
            try {
                const response = await fetch('api/discount-codes.php?action=list');
                const data = await response.json();
                
                if (data.success) {
                    allDiscountCodes = data.data;
                    renderDiscountCodes(allDiscountCodes);
                } else {
                    alert('Fehler beim Laden der Rabattcodes: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading discount codes:', error);
                alert('Fehler beim Laden der Rabattcodes: ' + error.message);
            }
        }

        function renderDiscountCodes(codes) {
            const container = document.getElementById('discountCodesList');
            if (!container) return;
            
            if (codes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Rabattcodes vorhanden</p></div>';
                return;
            }
            
            container.innerHTML = codes.map(code => {
                const discountText = code.discount_type === 'percentage' 
                    ? `${code.discount_value}%` 
                    : `${code.discount_value}‚Ç¨`;
                const statusColor = code.status === 'active' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                const statusText = code.status === 'active' ? '‚úÖ Aktiv' : code.status === 'inactive' ? '‚è∏Ô∏è Inaktiv' : '‚ùå Abgelaufen';
                
                return `
                    <div class="order-card" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="color: var(--gold); margin-bottom: 8px;">${code.code}</h3>
                                <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 4px 0;">
                                    <strong>Rabatt:</strong> ${discountText}<br>
                                    ${code.min_order > 0 ? `<strong>Mindestbestellwert:</strong> ${code.min_order}‚Ç¨<br>` : ''}
                                    <strong>Startdatum:</strong> ${code.start_date}<br>
                                    <strong>Enddatum:</strong> ${code.end_date}<br>
                                    <strong>Status:</strong> <span style="background: ${statusColor}; padding: 2px 8px; border-radius: 4px;">${statusText}</span><br>
                                    ${code.usage_limit ? `<strong>Nutzungslimit:</strong> ${code.used_count || 0}/${code.usage_limit}<br>` : ''}
                                    ${code.per_user_limit ? `<strong>Limit pro Person:</strong> ${code.per_user_limit} mal<br>` : ''}
                                    ${code.first_order_only == 1 ? `<strong>‚ö†Ô∏è Nur f√ºr erste Bestellung</strong><br>` : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-action btn-view" onclick="editDiscountCode('${code.promotion_id}')" title="Bearbeiten">‚úèÔ∏è</button>
                                <button class="btn-action" onclick="deleteDiscountCode('${code.promotion_id}')" style="background: rgba(239,68,68,0.1);" title="L√∂schen">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterDiscountCodes() {
            const search = document.getElementById('discountCodeSearch')?.value.toLowerCase() || '';
            const status = document.getElementById('discountCodeStatusFilter')?.value || '';
            
            let filtered = allDiscountCodes;
            
            if (status) {
                filtered = filtered.filter(code => code.status === status);
            }
            
            if (search) {
                filtered = filtered.filter(code => 
                    code.code.toLowerCase().includes(search) ||
                    (code.status && code.status.toLowerCase().includes(search))
                );
            }
            
            renderDiscountCodes(filtered);
        }

        function showAddDiscountCodeModal() {
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal';
            modal.id = 'discountCodeModal';
            modal.onclick = function(e) {
                if (e.target.id === 'discountCodeModal') closeDiscountCodeModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <h3>‚ûï Neuer Discount Code</h3>
                    <form id="discountCodeForm" onsubmit="saveDiscountCode(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Rabattcode (LEO-XXXXXX) *</label>
                            <input type="text" id="discountCodeCode" class="filter-input" placeholder="LEO-XXXXXX" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Rabatttyp *</label>
                            <select id="discountCodeType" class="filter-input" onchange="updateDiscountCodeFields()" required style="width: 100%;">
                                <option value="percentage">Prozent (%)</option>
                                <option value="fixed">Fester Betrag (‚Ç¨)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;" id="discountValueLabel">Rabattwert (%) *</label>
                            <input type="number" id="discountCodeValue" class="filter-input" step="0.01" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Mindestbestellwert (‚Ç¨)</label>
                            <input type="number" id="discountCodeMinOrder" class="filter-input" step="0.01" min="0" value="0" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Maximaler Rabatt (‚Ç¨) - nur f√ºr %</label>
                            <input type="number" id="discountCodeMaxDiscount" class="filter-input" step="0.01" min="0" style="width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Startdatum *</label>
                                <input type="date" id="discountCodeStartDate" class="filter-input" required style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Enddatum *</label>
                                <input type="date" id="discountCodeEndDate" class="filter-input" required style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Nutzungslimit (leer = unbegrenzt)</label>
                            <input type="number" id="discountCodeUsageLimit" class="filter-input" min="1" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Limit pro Person (leer = unbegrenzt)</label>
                            <input type="number" id="discountCodePerUserLimit" class="filter-input" min="1" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.9);">
                                <input type="checkbox" id="discountCodeFirstOrderOnly" style="width: auto;">
                                <span>Nur f√ºr die erste Bestellung jedes Kunden</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Status *</label>
                            <select id="discountCodeStatus" class="filter-input" required style="width: 100%;">
                                <option value="active">Aktiv</option>
                                <option value="inactive">Inaktiv</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn-action" style="flex: 1;">üíæ Speichern</button>
                            <button type="button" class="btn-action" onclick="closeDiscountCodeModal()" style="background: rgba(239,68,68,0.1);">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default dates
            document.getElementById('discountCodeStartDate').value = new Date().toISOString().split('T')[0];
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            document.getElementById('discountCodeEndDate').value = endDate.toISOString().split('T')[0];
        }

        function updateDiscountCodeFields() {
            const type = document.getElementById('discountCodeType').value;
            const label = document.getElementById('discountValueLabel');
            if (type === 'percentage') {
                label.textContent = 'Rabattwert (%) *';
                document.getElementById('discountCodeValue').max = 100;
            } else {
                label.textContent = 'Rabattwert (‚Ç¨) *';
                document.getElementById('discountCodeValue').max = null;
            }
        }

        function editDiscountCode(codeId) {
            const code = allDiscountCodes.find(c => c.promotion_id === codeId);
            if (!code) return;
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal';
            modal.id = 'discountCodeModal';
            modal.onclick = function(e) {
                if (e.target.id === 'discountCodeModal') closeDiscountCodeModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <h3>‚úèÔ∏è Discount Code bearbeiten</h3>
                    <form id="discountCodeForm" onsubmit="updateDiscountCodeForm(event, '${codeId}')">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Rabattcode</label>
                            <input type="text" value="${code.code}" disabled class="filter-input" style="width: 100%; opacity: 0.5;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Rabatttyp *</label>
                            <select id="discountCodeType" class="filter-input" onchange="updateDiscountCodeFields()" required style="width: 100%;">
                                <option value="percentage" ${code.discount_type === 'percentage' ? 'selected' : ''}>Prozent (%)</option>
                                <option value="fixed" ${code.discount_type === 'fixed' ? 'selected' : ''}>Fester Betrag (‚Ç¨)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;" id="discountValueLabel">Rabattwert *</label>
                            <input type="number" id="discountCodeValue" value="${code.discount_value}" step="0.01" class="filter-input" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Mindestbestellwert (‚Ç¨)</label>
                            <input type="number" id="discountCodeMinOrder" value="${code.min_order || 0}" step="0.01" min="0" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Maximaler Rabatt (‚Ç¨)</label>
                            <input type="number" id="discountCodeMaxDiscount" value="${code.max_discount || ''}" step="0.01" min="0" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Startdatum *</label>
                                <input type="date" id="discountCodeStartDate" value="${code.start_date}" class="filter-input" required style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Enddatum *</label>
                                <input type="date" id="discountCodeEndDate" value="${code.end_date}" class="filter-input" required style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Nutzungslimit</label>
                            <input type="number" id="discountCodeUsageLimit" value="${code.usage_limit || ''}" min="1" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Limit pro Person</label>
                            <input type="number" id="discountCodePerUserLimit" value="${code.per_user_limit || ''}" min="1" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.9);">
                                <input type="checkbox" id="discountCodeFirstOrderOnly" ${code.first_order_only == 1 ? 'checked' : ''} style="width: auto;">
                                <span>Nur f√ºr die erste Bestellung jedes Kunden</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Status *</label>
                            <select id="discountCodeStatus" class="filter-input" required style="width: 100%;">
                                <option value="active" ${code.status === 'active' ? 'selected' : ''}>Aktiv</option>
                                <option value="inactive" ${code.status === 'inactive' ? 'selected' : ''}>Inaktiv</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn-action" style="flex: 1;">üíæ Aktualisieren</button>
                            <button type="button" class="btn-action" onclick="closeDiscountCodeModal()" style="background: rgba(239,68,68,0.1);">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateDiscountCodeFields();
        }

        function closeDiscountCodeModal() {
            const modal = document.getElementById('discountCodeModal');
            if (modal) modal.remove();
        }

        async function saveDiscountCode(event) {
            event.preventDefault();
            
            const codeData = {
                code: document.getElementById('discountCodeCode').value.trim(),
                discount_type: document.getElementById('discountCodeType').value,
                discount_value: parseFloat(document.getElementById('discountCodeValue').value),
                min_order: parseFloat(document.getElementById('discountCodeMinOrder').value) || 0,
                max_discount: document.getElementById('discountCodeMaxDiscount').value ? parseFloat(document.getElementById('discountCodeMaxDiscount').value) : null,
                start_date: document.getElementById('discountCodeStartDate').value,
                end_date: document.getElementById('discountCodeEndDate').value,
                usage_limit: document.getElementById('discountCodeUsageLimit').value ? parseInt(document.getElementById('discountCodeUsageLimit').value) : null,
                per_user_limit: document.getElementById('discountCodePerUserLimit').value ? parseInt(document.getElementById('discountCodePerUserLimit').value) : null,
                first_order_only: document.getElementById('discountCodeFirstOrderOnly').checked,
                status: document.getElementById('discountCodeStatus').value
            };
            
            try {
                const response = await fetch('api/discount-codes.php?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(codeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Rabattcode erfolgreich erstellt!');
                    closeDiscountCodeModal();
                    loadDiscountCodes();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function updateDiscountCodeForm(event, codeId) {
            event.preventDefault();
            
            const codeData = {
                discount_type: document.getElementById('discountCodeType').value,
                discount_value: parseFloat(document.getElementById('discountCodeValue').value),
                min_order: parseFloat(document.getElementById('discountCodeMinOrder').value) || 0,
                max_discount: document.getElementById('discountCodeMaxDiscount').value ? parseFloat(document.getElementById('discountCodeMaxDiscount').value) : null,
                start_date: document.getElementById('discountCodeStartDate').value,
                end_date: document.getElementById('discountCodeEndDate').value,
                usage_limit: document.getElementById('discountCodeUsageLimit').value ? parseInt(document.getElementById('discountCodeUsageLimit').value) : null,
                per_user_limit: document.getElementById('discountCodePerUserLimit').value ? parseInt(document.getElementById('discountCodePerUserLimit').value) : null,
                first_order_only: document.getElementById('discountCodeFirstOrderOnly').checked,
                status: document.getElementById('discountCodeStatus').value
            };
            
            try {
                const response = await fetch(`api/discount-codes.php?action=update&code_id=${codeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(codeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Rabattcode erfolgreich aktualisiert!');
                    closeDiscountCodeModal();
                    loadDiscountCodes();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function deleteDiscountCode(codeId) {
            if (!confirm('M√∂chten Sie diesen Rabattcode wirklich l√∂schen?')) return;
            
            try {
                const response = await fetch(`api/discount-codes.php?action=delete&code_id=${codeId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Rabattcode erfolgreich gel√∂scht!');
                    loadDiscountCodes();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function loadDiscountCodesForPromotion() {
            try {
                const response = await fetch('api/discount-codes.php?action=list&status=active');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('promoDiscountCodeSelect');
                    if (select) {
                        select.innerHTML = '<option value="">-- Rabattcode ausw√§hlen --</option>' + 
                            data.data.map(code => 
                                `<option value="${code.code}" data-type="${code.discount_type}" data-value="${code.discount_value}" data-min="${code.min_order || 0}" data-end="${code.end_date}">${code.code} - ${code.discount_type === 'percentage' ? code.discount_value + '%' : code.discount_value + '‚Ç¨'}</option>`
                            ).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading discount codes for promotion:', error);
            }
        }

        // ========== HOLIDAY SCHEDULE MANAGEMENT ==========
        let allHolidaySchedule = [];

        async function loadHolidaySchedule() {
            try {
                const response = await fetch('api/holiday-schedule.php?action=list');
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from holiday-schedule API:', text.substring(0, 500));
                    throw new Error('Server returned non-JSON response. This might be a server error. Please check the server logs.');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allHolidaySchedule = data.data;
                    renderHolidaySchedule(allHolidaySchedule);
                } else {
                    alert('Fehler beim Laden der Feiertags-√ñffnungszeiten: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading holiday schedule:', error);
                // Show user-friendly error message
                const container = document.getElementById('holidayScheduleList');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state" style="background: rgba(239,68,68,.1); border: 2px solid rgba(239,68,68,.3);">
                            <div class="empty-state-icon">‚ùå</div>
                            <h3 style="color: #ef4444; margin: 16px 0 8px; font-size: 18px;">Fehler beim Laden</h3>
                            <p style="color: rgba(255,255,255,.7); margin-bottom: 12px;">${error.message || 'Daten konnten nicht geladen werden'}</p>
                            <button class="btn-action btn-view" onclick="loadHolidaySchedule()" style="margin-top: 12px;">Erneut versuchen</button>
                        </div>
                    `;
                } else {
                    alert('Fehler beim Laden der Feiertags-√ñffnungszeiten: ' + error.message);
                }
            }
        }

        function renderHolidaySchedule(holidays) {
            const container = document.getElementById('holidayScheduleList');
            if (!container) return;
            
            if (holidays.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Feiertags-√ñffnungszeiten vorhanden</p></div>';
                return;
            }
            
            container.innerHTML = holidays.map(holiday => {
                const date = new Date(holiday.date);
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = holiday.is_closed 
                    ? (holiday.note || 'Geschlossen')
                    : `${holiday.open_time} - ${holiday.close_time}`;
                const statusColor = holiday.is_active ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                const statusText = holiday.is_active ? '‚úÖ Aktiv' : '‚è∏Ô∏è Inaktiv';
                
                return `
                    <div class="order-card" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="color: var(--gold); margin-bottom: 8px;">${dateStr}</h3>
                                <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 4px 0;">
                                    <strong>Status:</strong> <span style="background: ${statusColor}; padding: 2px 8px; border-radius: 4px;">${statusText}</span><br>
                                    <strong>√ñffnungszeiten:</strong> ${timeStr}<br>
                                    ${holiday.note ? `<strong>Notiz:</strong> ${holiday.note}<br>` : ''}
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-action btn-view" onclick="editHolidaySchedule('${holiday.holiday_id}')" title="Bearbeiten">‚úèÔ∏è</button>
                                <button class="btn-action" onclick="toggleHolidaySchedule('${holiday.holiday_id}')" style="background: ${holiday.is_active ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)'};" title="${holiday.is_active ? 'Deaktivieren' : 'Aktivieren'}">${holiday.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                                <button class="btn-action" onclick="deleteHolidaySchedule('${holiday.holiday_id}')" style="background: rgba(239,68,68,0.1);" title="L√∂schen">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterHolidaySchedule() {
            const search = document.getElementById('holidaySearch')?.value.toLowerCase() || '';
            const status = document.getElementById('holidayStatusFilter')?.value || '';
            
            let filtered = allHolidaySchedule;
            
            if (status) {
                filtered = filtered.filter(holiday => {
                    if (status === 'active') return holiday.is_active == 1;
                    if (status === 'inactive') return holiday.is_active == 0;
                    return true;
                });
            }
            
            if (search) {
                filtered = filtered.filter(holiday => {
                    const date = new Date(holiday.date);
                    const dateStr = date.toLocaleDateString('de-DE');
                    return dateStr.toLowerCase().includes(search) ||
                           (holiday.note && holiday.note.toLowerCase().includes(search));
                });
            }
            
            renderHolidaySchedule(filtered);
        }

        function showAddHolidayModal() {
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal';
            modal.id = 'holidayModal';
            modal.onclick = function(e) {
                if (e.target.id === 'holidayModal') closeHolidayModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <h3>‚ûï Neuer Feiertag</h3>
                    <form id="holidayForm" onsubmit="saveHolidaySchedule(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Datum *</label>
                            <input type="date" id="holidayDate" class="filter-input" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
                                <input type="checkbox" id="holidayIsClosed" checked onchange="toggleHolidayTimeFields()" style="margin-right: 8px;">
                                Geschlossen
                            </label>
                        </div>
                        <div id="holidayTimeFields" style="display: none; margin-bottom: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">√ñffnungszeit *</label>
                                    <input type="time" id="holidayOpenTime" class="filter-input" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Schlie√üzeit *</label>
                                    <input type="time" id="holidayCloseTime" class="filter-input" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Notiz (optional)</label>
                            <input type="text" id="holidayNote" class="filter-input" placeholder="z.B. Geschlossen" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
                                <input type="checkbox" id="holidayIsActive" checked style="margin-right: 8px;">
                                Aktiv (in Modal anzeigen)
                            </label>
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button type="button" class="btn-cancel-schedule" onclick="closeHolidayModal()">Abbrechen</button>
                            <button type="submit" class="btn-schedule">Speichern</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function toggleHolidayTimeFields() {
            const isClosed = document.getElementById('holidayIsClosed').checked;
            const timeFields = document.getElementById('holidayTimeFields');
            const openTime = document.getElementById('holidayOpenTime');
            const closeTime = document.getElementById('holidayCloseTime');
            
            if (timeFields) {
                timeFields.style.display = isClosed ? 'none' : 'block';
                if (isClosed) {
                    if (openTime) openTime.removeAttribute('required');
                    if (closeTime) closeTime.removeAttribute('required');
                } else {
                    if (openTime) openTime.setAttribute('required', 'required');
                    if (closeTime) closeTime.setAttribute('required', 'required');
                }
            }
        }

        async function saveHolidaySchedule(event) {
            event.preventDefault();
            
            const holidayData = {
                date: document.getElementById('holidayDate').value,
                is_closed: document.getElementById('holidayIsClosed').checked,
                open_time: document.getElementById('holidayIsClosed').checked ? null : document.getElementById('holidayOpenTime').value,
                close_time: document.getElementById('holidayIsClosed').checked ? null : document.getElementById('holidayCloseTime').value,
                note: document.getElementById('holidayNote').value || null,
                is_active: document.getElementById('holidayIsActive').checked
            };
            
            try {
                const response = await fetch('api/holiday-schedule.php?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(holidayData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Feiertag erfolgreich erstellt!');
                    closeHolidayModal();
                    loadHolidaySchedule();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function editHolidaySchedule(holidayId) {
            try {
                const response = await fetch(`api/holiday-schedule.php?action=get&holiday_id=${holidayId}`);
                const data = await response.json();
                
                if (!data.success) {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                    return;
                }
                
                const holiday = data.data;
                const modal = document.createElement('div');
                modal.className = 'time-schedule-modal';
                modal.id = 'holidayModal';
                modal.onclick = function(e) {
                    if (e.target.id === 'holidayModal') closeHolidayModal();
                };
                
                const date = new Date(holiday.date);
                const dateStr = date.toISOString().split('T')[0];
                
                modal.innerHTML = `
                    <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                        <h3>‚úèÔ∏è Feiertag bearbeiten</h3>
                        <form id="holidayForm" onsubmit="updateHolidaySchedule(event, '${holidayId}')">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Datum *</label>
                                <input type="date" id="holidayDate" class="filter-input" value="${dateStr}" required style="width: 100%;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
                                    <input type="checkbox" id="holidayIsClosed" ${holiday.is_closed ? 'checked' : ''} onchange="toggleHolidayTimeFields()" style="margin-right: 8px;">
                                    Geschlossen
                                </label>
                            </div>
                            <div id="holidayTimeFields" style="display: ${holiday.is_closed ? 'none' : 'block'}; margin-bottom: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">√ñffnungszeit *</label>
                                        <input type="time" id="holidayOpenTime" class="filter-input" value="${holiday.open_time || ''}" ${holiday.is_closed ? '' : 'required'} style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Schlie√üzeit *</label>
                                        <input type="time" id="holidayCloseTime" class="filter-input" value="${holiday.close_time || ''}" ${holiday.is_closed ? '' : 'required'} style="width: 100%;">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Notiz (optional)</label>
                                <input type="text" id="holidayNote" class="filter-input" value="${holiday.note || ''}" placeholder="z.B. Geschlossen" style="width: 100%;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">
                                    <input type="checkbox" id="holidayIsActive" ${holiday.is_active ? 'checked' : ''} style="margin-right: 8px;">
                                    Aktiv (in Modal anzeigen)
                                </label>
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn-cancel-schedule" onclick="closeHolidayModal()">Abbrechen</button>
                                <button type="submit" class="btn-schedule">Aktualisieren</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function updateHolidaySchedule(event, holidayId) {
            event.preventDefault();
            
            const holidayData = {
                date: document.getElementById('holidayDate').value,
                is_closed: document.getElementById('holidayIsClosed').checked,
                open_time: document.getElementById('holidayIsClosed').checked ? null : document.getElementById('holidayOpenTime').value,
                close_time: document.getElementById('holidayIsClosed').checked ? null : document.getElementById('holidayCloseTime').value,
                note: document.getElementById('holidayNote').value || null,
                is_active: document.getElementById('holidayIsActive').checked
            };
            
            try {
                const response = await fetch(`api/holiday-schedule.php?action=update&holiday_id=${holidayId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(holidayData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Feiertag erfolgreich aktualisiert!');
                    closeHolidayModal();
                    loadHolidaySchedule();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function deleteHolidaySchedule(holidayId) {
            if (!confirm('M√∂chten Sie diesen Feiertag wirklich l√∂schen?')) return;
            
            try {
                const response = await fetch(`api/holiday-schedule.php?action=delete&holiday_id=${holidayId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Feiertag erfolgreich gel√∂scht!');
                    loadHolidaySchedule();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function toggleHolidaySchedule(holidayId) {
            try {
                const response = await fetch(`api/holiday-schedule.php?action=toggle&holiday_id=${holidayId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadHolidaySchedule();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        function closeHolidayModal() {
            const modal = document.getElementById('holidayModal');
            if (modal) {
                modal.remove();
            }
        }

        function loadDiscountCodeDetails() {
            const select = document.getElementById('promoDiscountCodeSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const type = selectedOption.getAttribute('data-type');
                const value = selectedOption.getAttribute('data-value');
                const minOrder = selectedOption.getAttribute('data-min');
                const endDate = selectedOption.getAttribute('data-end');
                
                if (type === 'percentage') {
                    document.getElementById('promoDiscountPercent').value = value;
                    document.getElementById('promoDiscountAmount').value = '';
                } else {
                    document.getElementById('promoDiscountAmount').value = value;
                    document.getElementById('promoDiscountPercent').value = '';
                }
                
                document.getElementById('promoMinOrder').value = minOrder;
                document.getElementById('promoValidUntil').value = endDate;
                document.getElementById('promoDiscountCode').value = selectedOption.value;
            }
        }

        // ========== MENU MANAGEMENT ==========
        let menuCategories = [];
        let allMenuItems = [];

        async function loadMenuCategories() {
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu')}&action=categories`);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from menu categories API:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    menuCategories = data.data || [];
                    console.log('‚úÖ Loaded categories:', menuCategories.length);
                    
                    // Update filter dropdown
                    const select = document.getElementById('menuCategoryFilter');
                    if (select) {
                        select.innerHTML = '<option value="">Alle Kategorien</option>' + 
                            menuCategories.map(cat => 
                                `<option value="${cat.category_id}">${cat.name}</option>`
                            ).join('');
                    }
                    
                    // Update add/edit modal dropdown if it exists
                    const categorySelect = document.getElementById('menuItemCategory');
                    if (categorySelect && !categorySelect.value) {
                        categorySelect.innerHTML = '<option value="">-- Kategorie ausw√§hlen --</option>' + 
                            menuCategories.map(cat => 
                                `<option value="${cat.category_id}">${cat.name}</option>`
                            ).join('');
                    }
                } else {
                    console.error('‚ùå Failed to load categories:', data.message);
                    menuCategories = [];
                }
            } catch (error) {
                console.error('‚ùå Error loading categories:', error);
                menuCategories = [];
            }
        }

        async function loadMenuItems() {
            try {
                // Admin should see all items including unavailable ones
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu')}&admin=true`);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from menu API:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allMenuItems = data.data;
                    renderMenuItems(allMenuItems);
                } else {
                    alert('Fehler beim Laden des Men√ºs: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading menu items:', error);
                alert('Fehler beim Laden des Men√ºs: ' + error.message);
            }
        }

        function renderMenuItems(items) {
            const container = document.getElementById('menuItemsList');
            if (!container) return;
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Men√º-Items vorhanden</p></div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                if (!item.item_id) {
                    console.error('Menu item missing ID:', item);
                    return '';
                }
                
                const category = menuCategories.find(c => c.category_id === item.category_id);
                return `
                    <div class="order-card" style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="color: var(--gold); margin-bottom: 8px;">${item.name}</h3>
                                <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 4px 0;">
                                    <strong>Kategorie:</strong> ${category ? category.name : item.category_id || 'N/A'}<br>
                                    <strong>Preis:</strong> ${parseFloat(item.price).toFixed(2)}‚Ç¨
                                </p>
                                ${item.description ? `<p style="color: rgba(255,255,255,0.6); font-size: 13px; margin-top: 8px;">${item.description}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-action btn-view edit-menu-item-btn" data-item-id="${item.item_id}" title="Bearbeiten">‚úèÔ∏è</button>
                                <button class="btn-action delete-menu-item-btn" data-item-id="${item.item_id}" style="background: rgba(239,68,68,0.1);" title="L√∂schen">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Attach event listeners using event delegation
            setTimeout(() => {
                attachMenuItemEventListeners();
            }, 100);
        }
        
        // Store the event handler to avoid duplicate listeners
        let menuItemEventHandler = null;
        
        function attachMenuItemEventListeners() {
            const container = document.getElementById('menuItemsList');
            if (!container) return;
            
            // Remove old listener if exists
            if (menuItemEventHandler) {
                container.removeEventListener('click', menuItemEventHandler);
            }
            
            // Create new event handler
            menuItemEventHandler = function(e) {
                console.log('Menu items container clicked:', e.target);
                
                const editBtn = e.target.closest('.edit-menu-item-btn');
                const deleteBtn = e.target.closest('.delete-menu-item-btn');
                
                if (editBtn) {
                    const itemId = editBtn.getAttribute('data-item-id');
                    console.log('Edit button clicked, itemId:', itemId);
                    if (itemId) {
                        e.preventDefault();
                        e.stopPropagation();
                        editMenuItem(itemId);
                    }
                } else if (deleteBtn) {
                    const itemId = deleteBtn.getAttribute('data-item-id');
                    console.log('Delete button clicked, itemId:', itemId);
                    if (itemId) {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteMenuItem(itemId);
                    }
                }
            };
            
            // Attach the event listener
            container.addEventListener('click', menuItemEventHandler);
        }

        function filterMenuByCategory() {
            const categoryId = document.getElementById('menuCategoryFilter').value;
            const filtered = categoryId 
                ? allMenuItems.filter(item => item.category_id === categoryId)
                : allMenuItems;
            renderMenuItems(filtered);
        }

        function filterMenuItems() {
            const search = document.getElementById('menuSearch').value.toLowerCase();
            const categoryId = document.getElementById('menuCategoryFilter').value;
            
            let filtered = allMenuItems;
            
            if (categoryId) {
                filtered = filtered.filter(item => item.category_id === categoryId);
            }
            
            if (search) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(search) ||
                    (item.description && item.description.toLowerCase().includes(search))
                );
            }
            
            renderMenuItems(filtered);
        }

        function showAddMenuItemModal() {
            // Remove existing modal if any
            const existingModal = document.getElementById('menuItemModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal active';
            modal.id = 'menuItemModal';
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target.id === 'menuItemModal') closeMenuItemModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px; text-align: left;" onclick="event.stopPropagation()">
                    <h3 style="text-align: center; margin-bottom: 30px;">‚ûï Neues Men√º-Item</h3>
                    <form id="menuItemForm" onsubmit="saveMenuItem(event)">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Kategorie *</label>
                            <select id="menuItemCategory" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" onchange="generateMenuItemId()">
                                <option value="" style="background: #1a1a1c; color: rgba(255,255,255,0.6);">-- Kategorie ausw√§hlen --</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Item ID * <span style="color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 400;">(wird automatisch generiert)</span></label>
                            <input type="text" id="menuItemId" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.06); border: 2px solid rgba(229,207,142,0.2); color: rgba(255,255,255,0.7); font-size: 15px; border-radius: 10px;" readonly>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Name *</label>
                            <input type="text" id="menuItemName" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Preis (‚Ç¨) *</label>
                            <input type="number" id="menuItemPrice" class="filter-input" step="0.01" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;">
                        </div>
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Beschreibung</label>
                            <textarea id="menuItemDescription" class="filter-input" rows="4" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px; resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button type="submit" class="btn-action" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, rgba(229,207,142,0.2), rgba(194,163,85,0.3)); border: 2px solid rgba(229,207,142,0.4); color: var(--gold); font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">üíæ Speichern</button>
                            <button type="button" class="btn-action" onclick="closeMenuItemModal()" style="padding: 14px 24px; background: rgba(239,68,68,0.15); border: 2px solid rgba(239,68,68,0.3); color: #ef4444; font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Force display
            setTimeout(async () => {
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                // Load categories if not already loaded
                if (!menuCategories || menuCategories.length === 0) {
                    await loadMenuCategories();
                }
                
                // Load categories into dropdown
                const categorySelect = document.getElementById('menuItemCategory');
                if (categorySelect) {
                    if (menuCategories && menuCategories.length > 0) {
                        categorySelect.innerHTML = '<option value="">-- Kategorie ausw√§hlen --</option>' + 
                            menuCategories.map(cat => 
                                `<option value="${cat.category_id}">${cat.name}</option>`
                            ).join('');
                    } else {
                        categorySelect.innerHTML = '<option value="">Lade Kategorien...</option>';
                        // Try loading again
                        await loadMenuCategories();
                        if (menuCategories && menuCategories.length > 0) {
                            categorySelect.innerHTML = '<option value="">-- Kategorie ausw√§hlen --</option>' + 
                                menuCategories.map(cat => 
                                    `<option value="${cat.category_id}">${cat.name}</option>`
                                ).join('');
                        }
                    }
                    
                    // Setup Item ID tracking after modal is displayed
                    setTimeout(() => {
                        setupMenuItemIdTracking();
                    }, 50);
                }
            }, 10);
        }
        
        // Track if user manually edits Item ID
        function setupMenuItemIdTracking() {
            const itemIdInput = document.getElementById('menuItemId');
            if (itemIdInput) {
                // Store initial value
                if (!itemIdInput.defaultValue) {
                    itemIdInput.defaultValue = itemIdInput.value;
                }
                
                // Add listener to track manual edits
                itemIdInput.addEventListener('input', function() {
                    if (this.value && this.value !== this.defaultValue) {
                        this.dataset.userEdited = 'true';
                    } else {
                        delete this.dataset.userEdited;
                    }
                });
            }
        }
        
        async function generateMenuItemId() {
            const categoryId = document.getElementById('menuItemCategory')?.value;
            const itemIdInput = document.getElementById('menuItemId');
            
            if (!categoryId || !itemIdInput) return;
            
            // Don't override if user has manually edited the ID
            if (itemIdInput.dataset.userEdited === 'true') return;
            
            try {
                // Map category_id to prefix based on actual menu data patterns
                const categoryPrefixMap = {
                    'sushimenu': 'S',
                    'maki': 'M',
                    'insideout': 'U',
                    'crunchy': 'C',
                    'sashimi': 'Sa',
                    'nigiri': 'N',
                    'bigrolls': 'P',
                    'minirolls': 'Pa',
                    'specialrolls': 'Sp',
                    'firenigiri': 'F',
                    'temaki': 'Te',
                    'dessert': 'D',
                    'beilagen': 'B'
                };
                
                const prefix = categoryPrefixMap[categoryId.toLowerCase()] || '';
                
                // Get all items in this category to find the highest number
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu')}&category_id=${encodeURIComponent(categoryId)}&admin=true`);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from menu API:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const items = data.data || [];
                    let maxNumber = 0;
                    
                    if (prefix) {
                        // Category has prefix (S, M, U, C, Sa, N, P, Pa, Sp, F, Te, D, B)
                        items.forEach(item => {
                            if (item.item_id) {
                                // Match prefix followed by numbers (e.g., M1, M2, M10, S1, S2, Sa1, Sp1)
                                // Escape special regex characters in prefix
                                const escapedPrefix = prefix.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                const match = item.item_id.match(new RegExp(`^${escapedPrefix}(\\d+)$`, 'i'));
                                if (match) {
                                    const num = parseInt(match[1], 10);
                                    if (!isNaN(num) && num > maxNumber) {
                                        maxNumber = num;
                                    }
                                }
                            }
                        });
                        // Generate next ID: prefix + (maxNumber + 1)
                        const newId = prefix + (maxNumber + 1);
                        itemIdInput.value = newId;
                        console.log(`‚úÖ Generated ID for category ${categoryId}: ${newId} (max found: ${maxNumber}, total items: ${items.length})`);
                    } else {
                        // Category without prefix (vorspeisen, salate, suppen, etc.) - use numbers only
                        items.forEach(item => {
                            if (item.item_id) {
                                // Match pure numbers (e.g., 1, 2, 30, 40)
                                const match = item.item_id.match(/^(\d+)$/);
                                if (match) {
                                    const num = parseInt(match[1], 10);
                                    if (!isNaN(num) && num > maxNumber) {
                                        maxNumber = num;
                                    }
                                }
                            }
                        });
                        // Generate next ID: (maxNumber + 1)
                        const newId = (maxNumber + 1).toString();
                        itemIdInput.value = newId;
                        console.log(`‚úÖ Generated ID for category ${categoryId}: ${newId} (max found: ${maxNumber}, total items: ${items.length})`);
                    }
                } else {
                    console.error('Failed to load items for category:', data.message);
                }
            } catch (error) {
                console.error('Error generating item ID:', error);
                // Fallback: try to determine prefix from category_id
                const categoryPrefixMap = {
                    'sushimenu': 'S',
                    'maki': 'M',
                    'insideout': 'U',
                    'crunchy': 'C',
                    'sashimi': 'Sa',
                    'nigiri': 'N',
                    'bigrolls': 'P',
                    'minirolls': 'Pa',
                    'specialrolls': 'Sp',
                    'firenigiri': 'F',
                    'temaki': 'Te',
                    'dessert': 'D',
                    'beilagen': 'B'
                };
                const prefix = categoryPrefixMap[categoryId.toLowerCase()] || '';
                itemIdInput.value = prefix ? prefix + '1' : '1';
            }
        }
        
        // Track if user manually edits Item ID
        function setupMenuItemIdTracking() {
            const itemIdInput = document.getElementById('menuItemId');
            if (itemIdInput) {
                // Remove old listeners
                const newInput = itemIdInput.cloneNode(true);
                itemIdInput.parentNode.replaceChild(newInput, itemIdInput);
                
                // Add listener to track manual edits
                newInput.addEventListener('input', function() {
                    if (this.value && this.value !== this.defaultValue) {
                        this.dataset.userEdited = 'true';
                    }
                });
                
                // Store initial value as defaultValue
                newInput.defaultValue = newInput.value;
            }
        }

        function editMenuItem(itemId) {
            if (!itemId) {
                console.error('editMenuItem: itemId is missing');
                alert('Fehler: Item-ID fehlt');
                return;
            }
            
            console.log('editMenuItem called with ID:', itemId);
            
            const item = allMenuItems.find(i => i.item_id === itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                alert('Fehler: Men√º-Item nicht gefunden');
                return;
            }
            
            // Remove existing modal if any
            const existingModal = document.getElementById('menuItemModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal active';
            modal.id = 'menuItemModal';
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target.id === 'menuItemModal') closeMenuItemModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px; text-align: left;" onclick="event.stopPropagation()">
                    <h3 style="text-align: center; margin-bottom: 30px;">‚úèÔ∏è Men√º-Item bearbeiten</h3>
                    <form id="menuItemForm" onsubmit="updateMenuItemForm(event, '${itemId}')">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Item ID</label>
                            <input type="text" value="${item.item_id}" disabled class="filter-input" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.06); border: 2px solid rgba(229,207,142,0.2); color: rgba(255,255,255,0.5); font-size: 15px; border-radius: 10px; opacity: 0.7;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Name *</label>
                            <input type="text" id="menuItemName" value="${escapeHtml(item.name || '')}" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Kategorie *</label>
                            <select id="menuItemCategory" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;"></select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Preis (‚Ç¨) *</label>
                            <input type="number" id="menuItemPrice" value="${item.price || ''}" step="0.01" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;">
                        </div>
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Beschreibung</label>
                            <textarea id="menuItemDescription" class="filter-input" rows="4" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px; resize: vertical; font-family: inherit;">${escapeHtml(item.description || '')}</textarea>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button type="submit" class="btn-action" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, rgba(229,207,142,0.2), rgba(194,163,85,0.3)); border: 2px solid rgba(229,207,142,0.4); color: var(--gold); font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">üíæ Aktualisieren</button>
                            <button type="button" class="btn-action" onclick="closeMenuItemModal()" style="padding: 14px 24px; background: rgba(239,68,68,0.15); border: 2px solid rgba(239,68,68,0.3); color: #ef4444; font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Force display
            setTimeout(async () => {
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                // Load categories if not already loaded
                if (!menuCategories || menuCategories.length === 0) {
                    await loadMenuCategories();
                }
                
                // Load categories and set current
                const categorySelect = document.getElementById('menuItemCategory');
                if (categorySelect) {
                    if (menuCategories && menuCategories.length > 0) {
                        categorySelect.innerHTML = menuCategories.map(cat => 
                            `<option value="${cat.category_id}" ${cat.category_id === item.category_id ? 'selected' : ''}>${cat.name}</option>`
                        ).join('');
                    } else {
                        categorySelect.innerHTML = '<option value="">Lade Kategorien...</option>';
                        // Try loading again
                        await loadMenuCategories();
                        if (menuCategories && menuCategories.length > 0) {
                            categorySelect.innerHTML = menuCategories.map(cat => 
                                `<option value="${cat.category_id}" ${cat.category_id === item.category_id ? 'selected' : ''}>${cat.name}</option>`
                            ).join('');
                        }
                    }
                }
            }, 10);
        }

        function closeMenuItemModal() {
            const modal = document.getElementById('menuItemModal');
            if (modal) modal.remove();
        }
        
        function showMenuNotification(message, type = 'info') {
            // Remove existing notification if any
            const existing = document.getElementById('menuItemNotification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'menuItemNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, rgba(16,185,129,0.9), rgba(5,150,105,0.9))' : 'linear-gradient(135deg, rgba(239,68,68,0.9), rgba(220,38,38,0.9))'};
                color: #fff;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 3000;
                font-size: 14px;
                font-weight: 600;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
                cursor: pointer;
            `;
            notification.textContent = message;
            notification.onclick = () => notification.remove();
            
            // Add animation if not exists
            if (!document.getElementById('menuNotificationStyle')) {
                const style = document.createElement('style');
                style.id = 'menuNotificationStyle';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        async function saveMenuItem(event) {
            event.preventDefault();
            
            const itemIdInput = document.getElementById('menuItemId');
            const categoryId = document.getElementById('menuItemCategory').value;
            const name = document.getElementById('menuItemName').value.trim();
            const price = parseFloat(document.getElementById('menuItemPrice').value);
            const description = document.getElementById('menuItemDescription').value.trim() || null;
            
            // Validate required fields
            if (!categoryId || !name || !price || !itemIdInput.value.trim()) {
                showMenuNotification('‚ùå Bitte f√ºllen Sie alle Pflichtfelder aus!', 'error');
                return;
            }
            
            // Check if Item ID is empty or just "...", regenerate if needed
            let itemId = itemIdInput.value.trim();
            if (!itemId || itemId === '...') {
                console.log('Item ID is empty or loading, regenerating...');
                await generateMenuItemId();
                itemId = itemIdInput.value.trim();
                if (!itemId || itemId === '...') {
                    showMenuNotification('‚ùå Fehler beim Generieren der Item-ID. Bitte versuchen Sie es erneut.', 'error');
                    return;
                }
            }
            
            // Double-check if ID already exists before submitting
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const checkResponse = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu')}&action=list&admin=true`);
                
                // Check if response is JSON
                const checkContentType = checkResponse.headers.get('content-type');
                if (!checkContentType || !checkContentType.includes('application/json')) {
                    throw new Error('Server returned non-JSON response');
                }
                
                const checkData = await checkResponse.json();
                if (checkData.success) {
                    const existingItem = checkData.data.find(item => item.item_id === itemId);
                    if (existingItem) {
                        console.log(`Item ID ${itemId} already exists, regenerating...`);
                        await generateMenuItemId();
                        itemId = itemIdInput.value.trim();
                        if (!itemId || itemId === '...') {
                            showMenuNotification('‚ùå Fehler beim Generieren der Item-ID. Bitte versuchen Sie es erneut.', 'error');
                            return;
                        }
                    }
                }
            } catch (checkError) {
                console.error('Error checking existing items:', checkError);
                // Continue anyway, server will check
            }
            
            const itemData = {
                item_id: itemId,
                name: name,
                category_id: categoryId,
                price: price,
                description: description,
                available: 1  // M√≥n m·ªõi s·∫Ω ƒë∆∞·ª£c set available = 1 ƒë·ªÉ hi·ªÉn th·ªã ngay
                // discount_code kh√¥ng √°p d·ª•ng cho menu items - ch·ªâ √°p d·ª•ng cho ƒë∆°n h√†ng
            };
            
            console.log('Submitting menu item:', itemData);
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu/new')}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                
                const data = await response.json();
                console.log('Server response:', data);
                
                if (data.success) {
                    // Show success notification
                    showMenuNotification('‚úÖ Men√º-Item erfolgreich erstellt!', 'success');
                    closeMenuItemModal();
                    loadMenuItems();
                } else {
                    // If ID conflict, regenerate and suggest retry
                    if (data.message && data.message.includes('t·ªìn t·∫°i')) {
                        console.log('ID conflict detected, regenerating ID...');
                        await generateMenuItemId();
                        showMenuNotification('‚ùå Item-ID bereits vorhanden. Neue ID wurde generiert. Bitte erneut versuchen.', 'error');
                    } else {
                        // Show error notification without closing modal
                        showMenuNotification('‚ùå Fehler: ' + (data.message || 'Unknown error'), 'error');
                    }
                }
            } catch (error) {
                console.error('Error saving menu item:', error);
                // Show error notification without closing modal
                showMenuNotification('‚ùå Fehler: ' + error.message, 'error');
            }
        }

        async function updateMenuItemForm(event, itemId) {
            event.preventDefault();
            
            const itemData = {
                name: document.getElementById('menuItemName').value.trim(),
                category_id: document.getElementById('menuItemCategory').value,
                price: parseFloat(document.getElementById('menuItemPrice').value),
                description: document.getElementById('menuItemDescription').value.trim() || null
                // discount_code kh√¥ng √°p d·ª•ng cho menu items - ch·ªâ √°p d·ª•ng cho ƒë∆°n h√†ng
            };
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu/edit')}&item_id=${itemId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success notification
                    showMenuNotification('‚úÖ Men√º-Item erfolgreich aktualisiert!', 'success');
                    closeMenuItemModal();
                    loadMenuItems();
                } else {
                    // Show error notification without closing modal
                    showMenuNotification('‚ùå Fehler: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                // Show error notification without closing modal
                showMenuNotification('‚ùå Fehler: ' + error.message, 'error');
            }
        }

        async function deleteMenuItem(itemId) {
            if (!itemId) {
                console.error('deleteMenuItem: itemId is missing');
                alert('Fehler: Item-ID fehlt');
                return;
            }
            
            if (!confirm('M√∂chten Sie dieses Men√º-Item wirklich l√∂schen?')) return;
            
            console.log('deleteMenuItem called with ID:', itemId);
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/data/menu/remove')}&item_id=${encodeURIComponent(itemId)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Men√º-Item erfolgreich gel√∂scht!');
                    loadMenuItems();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        // ========== CUSTOMER MANAGEMENT IMPROVEMENTS ==========
        async function loadCustomers() {
            try {
                // Reset to first page when loading/searching
                currentCustomerPage = 1;
                
                const search = document.getElementById('customerSearch')?.value || '';
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                // Encode route parameter to handle slashes properly
                const url = search 
                    ? `api/index.php?route=${encodeURIComponent('v1/data/customers')}&search=${encodeURIComponent(search)}`
                    : `api/index.php?route=${encodeURIComponent('v1/data/customers')}`;
                
                const response = await fetch(url);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. This might be a server error. Please check the server logs.');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    renderCustomers(data.data);
                } else {
                    alert('Fehler beim Laden der Kunden: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                alert('Fehler beim Laden der Kunden: ' + error.message);
            }
        }

        // Pagination state for customers
        let currentCustomerPage = 1;
        const customersPerPage = 10;
        let allCustomers = [];

        function renderCustomers(customers) {
            const container = document.getElementById('customersListContainer');
            if (!container) return;
            
            // Store all customers for pagination
            allCustomers = customers;
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Keine Kunden vorhanden</p></div>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(customers.length / customersPerPage);
            const startIndex = (currentCustomerPage - 1) * customersPerPage;
            const endIndex = startIndex + customersPerPage;
            const paginatedCustomers = customers.slice(startIndex, endIndex);
            
            // Render customers
            const customersHTML = paginatedCustomers.map(customer => {
                if (!customer.id) {
                    console.error('Customer missing ID:', customer);
                    return '';
                }
                
                const fullName = `${customer.first_name || ''} ${customer.last_name || ''}`.trim() || 'N/A';
                const address = customer.street ? `${customer.street}, ${customer.postal || ''} ${customer.city || ''}`.trim() : '';
                const points = customer.points || 0;
                const birthday = customer.birthday || '';
                const orderCount = customer.order_count || 0;
                const lastOrderDate = customer.last_order_date ? new Date(customer.last_order_date).toLocaleDateString('de-DE') : 'Keine';
                const customerId = String(customer.id).replace(/'/g, "\\'");
                
                return `
                <div class="order-card" style="margin-bottom: 16px;" data-customer-id="${customer.id}" data-customer-email="${(customer.email || '').replace(/"/g, '&quot;')}" data-customer-phone="${(customer.phone || '').replace(/"/g, '&quot;')}">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="color: var(--gold); margin-bottom: 8px;">
                                ${fullName}
                            </h3>
                            <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin: 4px 0;">
                                <strong>üìß Email:</strong> ${customer.email || 'N/A'}<br>
                                <strong>üì± Telefon:</strong> ${customer.phone || 'N/A'}<br>
                                ${address ? `<strong>üìç Adresse:</strong> ${address}<br>` : ''}
                                ${points > 0 ? `<strong>‚≠ê Punkte:</strong> <span style="color: var(--gold); font-weight: 600;">${points}</span><br>` : ''}
                                <strong>üéÇ Geburtstag:</strong> ${birthday ? new Date(birthday).toLocaleDateString('de-DE') : '<span style="color: rgba(255,255,255,0.5);">Nicht angegeben</span>'}<br>
                                <strong>üì¶ Bestellungen:</strong> ${orderCount}<br>
                                ${lastOrderDate !== 'Keine' ? `<strong>üìÖ Letzte Bestellung:</strong> ${lastOrderDate}<br>` : ''}
                                <strong>‚úÖ Email verified:</strong> ${customer.email_verified ? '‚úÖ' : '‚ùå'}<br>
                                ${customer.discount_code ? `<strong style="color: var(--gold);">üéÅ Rabattcode:</strong> ${customer.discount_code}<br>` : ''}
                                <strong>üí≥ Discount used:</strong> ${customer.discount_used ? '‚úÖ' : '‚ùå'}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${points > 0 ? `<button class="btn-action redeem-points-btn" data-customer-id="${customer.id}" data-customer-points="${points}" data-customer-name="${fullName.replace(/"/g, '&quot;')}" style="background: rgba(34, 197, 94, 0.1); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3);" title="Punkte einl√∂sen">‚≠ê Einl√∂sen</button>` : ''}
                            <button class="btn-action btn-view edit-customer-btn" data-customer-id="${customer.id}" title="Bearbeiten">‚úèÔ∏è</button>
                            <button class="btn-action delete-customer-btn" data-customer-id="${customer.id}" style="background: rgba(239,68,68,0.1);" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Render pagination
            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; padding: 20px;">
                        <button class="filter-btn" onclick="goToCustomerPage(${currentCustomerPage - 1})" ${currentCustomerPage === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>‚Üê Zur√ºck</button>
                        <span style="color: rgba(255, 255, 255, 0.7); padding: 0 16px;">
                            Seite ${currentCustomerPage} von ${totalPages} (${customers.length} Kunden)
                        </span>
                        <button class="filter-btn" onclick="goToCustomerPage(${currentCustomerPage + 1})" ${currentCustomerPage === totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Weiter ‚Üí</button>
                    </div>
                `;
            }
            
            container.innerHTML = customersHTML + paginationHTML;
            
            // Attach event listeners using event delegation
            // Use setTimeout to ensure DOM is updated
            setTimeout(() => {
                attachCustomerEventListeners();
            }, 100);
        }

        // Store the event handler to avoid duplicate listeners
        let customerEventHandler = null;
        
        function attachCustomerEventListeners() {
            const container = document.getElementById('customersListContainer');
            if (!container) return;
            
            // Remove old listener if exists
            if (customerEventHandler) {
                container.removeEventListener('click', customerEventHandler);
            }
            
            // Create new event handler
            customerEventHandler = function(e) {
                console.log('Customer container clicked:', e.target);
                
                const editBtn = e.target.closest('.edit-customer-btn');
                const deleteBtn = e.target.closest('.delete-customer-btn');
                const redeemBtn = e.target.closest('.redeem-points-btn');
                
                if (redeemBtn) {
                    const customerId = redeemBtn.getAttribute('data-customer-id');
                    const customerPoints = parseInt(redeemBtn.getAttribute('data-customer-points') || '0');
                    const customerName = redeemBtn.getAttribute('data-customer-name') || 'Kunde';
                    console.log('Redeem points button clicked, customerId:', customerId);
                    if (customerId) {
                        e.preventDefault();
                        e.stopPropagation();
                        showRedeemPointsModal(customerId, customerPoints, customerName);
                    }
                } else if (editBtn) {
                    const customerId = editBtn.getAttribute('data-customer-id');
                    console.log('Edit button clicked, customerId:', customerId);
                    if (customerId) {
                        e.preventDefault();
                        e.stopPropagation();
                        editCustomer(customerId);
                    }
                } else if (deleteBtn) {
                    const customerId = deleteBtn.getAttribute('data-customer-id');
                    console.log('Delete button clicked, customerId:', customerId);
                    if (customerId) {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteCustomer(customerId);
                    }
                }
            };
            
            // Attach the event listener
            container.addEventListener('click', customerEventHandler);
        }

        function goToCustomerPage(page) {
            const totalPages = Math.ceil(allCustomers.length / customersPerPage);
            if (page < 1 || page > totalPages) return;
            currentCustomerPage = page;
            renderCustomers(allCustomers);
            // Scroll to top of customers list
            document.getElementById('customersListContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Event listeners are already attached in renderCustomers
        }

        function showAddCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal';
            modal.id = 'customerModal';
            modal.onclick = function(e) {
                if (e.target.id === 'customerModal') closeCustomerModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <h3>‚ûï Neuer Kunde</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">Hinweis: Kunden werden normalerweise √ºber die Registrierung erstellt. Sie k√∂nnen hier manuell einen Kunden hinzuf√ºgen.</p>
                    <form id="customerForm" onsubmit="saveCustomer(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Email *</label>
                            <input type="email" id="customerEmail" class="filter-input" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Telefon</label>
                            <input type="tel" id="customerPhone" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Vorname</label>
                                <input type="text" id="customerFirstName" class="filter-input" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Nachname</label>
                                <input type="text" id="customerLastName" class="filter-input" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(229, 207, 142, 0.2); border-radius: 8px;">
                            <p style="color: rgba(255,255,255,0.7); font-size: 13px; margin: 0;">
                                <strong>‚ÑπÔ∏è Hinweis:</strong> M√£ khuy·∫øn m√£i s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o khi kh√°ch h√†ng ƒëƒÉng k√Ω. Kh√¥ng th·ªÉ ch·ªânh s·ª≠a th·ªß c√¥ng.
                            </p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn-action" style="flex: 1;">üíæ Speichern</button>
                            <button type="button" class="btn-action" onclick="closeCustomerModal()" style="background: rgba(239,68,68,0.1);">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function editCustomer(customerId) {
            if (!customerId) {
                console.error('editCustomer: customerId is missing');
                alert('Fehler: Kunden-ID fehlt');
                return;
            }
            
            console.log('editCustomer called with ID:', customerId);
            
            // Show loading indicator
            const loadingModal = document.createElement('div');
            loadingModal.className = 'time-schedule-modal active';
            loadingModal.style.display = 'flex';
            loadingModal.innerHTML = '<div class="time-schedule-content"><p style="color: rgba(255,255,255,0.9);">Lade Kundendaten...</p></div>';
            document.body.appendChild(loadingModal);
            
            // Load customer data and show edit modal
            fetch(`api/v1/data/customers?action=get&customer_id=${encodeURIComponent(customerId)}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    // Check if response is JSON
                    const contentType = res.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        return res.text().then(text => {
                            console.error('Non-JSON response:', text);
                            throw new Error('Server returned non-JSON response. This might be a server error.');
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    loadingModal.remove();
                    if (data.success) {
                        const customer = data.data;
                        console.log('Customer data loaded:', customer);
                        showEditCustomerModal(customer);
                    } else {
                        alert('Fehler beim Laden der Kundendaten: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    loadingModal.remove();
                    console.error('Error loading customer:', error);
                    alert('Fehler: ' + error.message);
                });
        }

        function showEditCustomerModal(customer) {
            // Remove existing modal if any
            const existingModal = document.getElementById('customerModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal active';
            modal.id = 'customerModal';
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target.id === 'customerModal') closeCustomerModal();
            };
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px;" onclick="event.stopPropagation()">
                    <h3>‚úèÔ∏è Kunde bearbeiten</h3>
                    <form id="customerForm" onsubmit="updateCustomerForm(event, '${customer.id}')">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Email *</label>
                            <input type="email" id="customerEmail" value="${customer.email || ''}" class="filter-input" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Telefon</label>
                            <input type="tel" id="customerPhone" value="${customer.phone || ''}" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Vorname</label>
                                <input type="text" id="customerFirstName" value="${customer.first_name || ''}" class="filter-input" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Nachname</label>
                                <input type="text" id="customerLastName" value="${customer.last_name || ''}" class="filter-input" style="width: 100%;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Stra√üe</label>
                                <input type="text" id="customerStreet" value="${customer.street || ''}" class="filter-input" style="width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">PLZ</label>
                                <input type="text" id="customerPostal" value="${customer.postal || ''}" class="filter-input" style="width: 100%;">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">Stadt</label>
                            <input type="text" id="customerCity" value="${customer.city || ''}" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">üéÇ Geburtstag</label>
                            <input type="date" id="customerBirthday" value="${customer.birthday || ''}" class="filter-input" style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">‚≠ê Punkte</label>
                            <input type="number" id="customerPoints" value="${customer.points || 0}" min="0" class="filter-input" style="width: 100%;">
                        </div>
                        ${customer.discount_code ? `
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(229, 207, 142, 0.1); border: 1px solid rgba(229, 207, 142, 0.2); border-radius: 8px;">
                            <label style="display: block; color: rgba(255,255,255,0.9); margin-bottom: 8px;">üéÅ Rabattcode (nur Anzeige)</label>
                            <p style="color: var(--gold); font-weight: 600; margin: 0;">${customer.discount_code}</p>
                            <p style="color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 4px;">Dieser Code kann nicht manuell ge√§ndert werden. M√£ khuy·∫øn m√£i n√†y ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o cho kh√°ch h√†ng m·ªõi v√† ch·ªâ d√πng ƒë∆∞·ª£c 1 l·∫ßn.</p>
                        </div>
                        ` : ''}
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn-action" style="flex: 1;">üíæ Aktualisieren</button>
                            <button type="button" class="btn-action" onclick="closeCustomerModal()" style="background: rgba(239,68,68,0.1);">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Force display
            setTimeout(() => {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }, 10);
        }

        function closeCustomerModal() {
            const modal = document.getElementById('customerModal');
            if (modal) modal.remove();
        }

        async function saveCustomer(event) {
            event.preventDefault();
            // Note: Creating customers should be done through registration API
            alert('Hinweis: Kunden sollten √ºber die Registrierung erstellt werden. Bitte verwenden Sie die Registrierungsseite.');
            closeCustomerModal();
        }

        async function updateCustomerForm(event, customerId) {
            event.preventDefault();
            
            const customerData = {
                email: document.getElementById('customerEmail').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                first_name: document.getElementById('customerFirstName').value.trim() || null,
                last_name: document.getElementById('customerLastName').value.trim() || null,
                street: document.getElementById('customerStreet')?.value.trim() || null,
                postal: document.getElementById('customerPostal')?.value.trim() || null,
                city: document.getElementById('customerCity')?.value.trim() || null,
                birthday: document.getElementById('customerBirthday')?.value || null,
                points: document.getElementById('customerPoints')?.value ? parseInt(document.getElementById('customerPoints').value) : null
                // discount_code kh√¥ng ƒë∆∞·ª£c ch·ªânh s·ª≠a th·ªß c√¥ng - ch·ªâ ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o khi ƒëƒÉng k√Ω
            };
            
            try {
                const response = await fetch(`api/v1/data/customers?action=update&customer_id=${customerId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Kunde erfolgreich aktualisiert!');
                    closeCustomerModal();
                    loadCustomers();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function deleteCustomer(customerId) {
            if (!customerId) {
                console.error('deleteCustomer: customerId is missing');
                alert('Fehler: Kunden-ID fehlt');
                return;
            }
            
            if (!confirm('M√∂chten Sie diesen Kunden wirklich l√∂schen?')) return;
            
            console.log('deleteCustomer called with ID:', customerId);
            
            try {
                const response = await fetch(`api/v1/data/customers?action=delete&customer_id=${encodeURIComponent(customerId)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Kunde erfolgreich gel√∂scht!');
                    loadCustomers();
                } else {
                    alert('‚ùå Fehler: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        function filterCustomers() {
            loadCustomers();
        }

        // ========== REDEEM POINTS FOR CUSTOMER ==========
        async function showRedeemPointsModal(customerId, customerPoints, customerName) {
            // Load redemption rules first
            let rules = [];
            try {
                const rulesResponse = await fetch('api/v1/data/points/rules');
                const rulesData = await rulesResponse.json();
                if (rulesData.success) {
                    rules = rulesData.rules || rulesData.data || [];
                    // Filter only rules that customer can afford
                    rules = rules.filter(rule => rule.points_required <= customerPoints && rule.status === 'active');
                }
            } catch (error) {
                console.error('Error loading redemption rules:', error);
            }
            
            if (rules.length === 0) {
                showMenuNotification('‚ùå Keine verf√ºgbaren Einl√∂sungsregeln f√ºr diesen Kunden!', 'error');
                return;
            }
            
            const existingModal = document.getElementById('redeemPointsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal active';
            modal.id = 'redeemPointsModal';
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target.id === 'redeemPointsModal') closeRedeemPointsModal();
            };
            
            const rulesOptions = rules.map(rule => {
                let desc = `${rule.points_required} Punkte = `;
                if (rule.discount_type === 'percentage') {
                    desc += `${rule.discount_value}% Rabatt`;
                } else if (rule.discount_type === 'fixed') {
                    desc += `${rule.discount_value}‚Ç¨ Rabatt`;
                }
                if (rule.min_order > 0) {
                    desc += ` (Min. ${rule.min_order}‚Ç¨)`;
                }
                return `<option value="${rule.rule_id}" data-points="${rule.points_required}">${desc}</option>`;
            }).join('');
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px; text-align: left;" onclick="event.stopPropagation()">
                    <h3 style="text-align: center; margin-bottom: 20px;">‚≠ê Punkte einl√∂sen f√ºr ${customerName}</h3>
                    <div style="background: rgba(229, 207, 142, 0.1); border: 1px solid rgba(229, 207, 142, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                        <p style="color: var(--gold); margin: 0; font-weight: 600; font-size: 18px;">Verf√ºgbare Punkte: ${customerPoints}</p>
                    </div>
                    <form id="redeemPointsForm" onsubmit="redeemPointsForCustomer(event, '${customerId}', ${customerPoints})">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Einl√∂sungsregel ausw√§hlen *</label>
                            <select id="customerRedemptionRule" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" onchange="updateCustomerRedemptionPreview('${customerId}', ${customerPoints})">
                                <option value="">-- Regel ausw√§hlen --</option>
                                ${rulesOptions}
                            </select>
                        </div>
                        
                        <div id="customerRedemptionPreview" style="margin-bottom: 20px; padding: 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; display: none;">
                            <p style="color: #86efac; margin: 0; font-weight: 600;" id="customerRedemptionPreviewText"></p>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button type="submit" class="btn-action" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, rgba(229,207,142,0.2), rgba(194,163,85,0.3)); border: 2px solid rgba(229,207,142,0.4); color: var(--gold); font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">‚≠ê Punkte einl√∂sen</button>
                            <button type="button" class="btn-action" onclick="closeRedeemPointsModal()" style="padding: 14px 24px; background: rgba(239,68,68,0.15); border: 2px solid rgba(239,68,68,0.3); color: #ef4444; font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.style.display = 'flex';
                modal.classList.add('active');
            }, 10);
        }
        
        function updateCustomerRedemptionPreview(customerId, customerPoints) {
            const ruleSelect = document.getElementById('customerRedemptionRule');
            const previewDiv = document.getElementById('customerRedemptionPreview');
            const previewText = document.getElementById('customerRedemptionPreviewText');
            
            if (!ruleSelect || !previewDiv || !previewText) return;
            
            const ruleId = ruleSelect.value;
            if (!ruleId) {
                previewDiv.style.display = 'none';
                return;
            }
            
            const selectedOption = ruleSelect.options[ruleSelect.selectedIndex];
            const pointsRequired = parseInt(selectedOption.getAttribute('data-points') || '0');
            const remainingPoints = customerPoints - pointsRequired;
            
            if (remainingPoints < 0) {
                previewText.textContent = `‚ùå Nicht genug Punkte! Ben√∂tigt: ${pointsRequired}, Verf√ºgbar: ${customerPoints}`;
                previewDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                previewDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                previewText.style.color = '#fca5a5';
            } else {
                previewText.textContent = `Verwendet: ${pointsRequired} Punkte ‚Üí Verbleibend: ${remainingPoints} Punkte`;
                previewDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                previewDiv.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                previewText.style.color = '#86efac';
            }
            
            previewDiv.style.display = 'block';
        }
        
        function closeRedeemPointsModal() {
            const modal = document.getElementById('redeemPointsModal');
            if (modal) modal.remove();
        }
        
        async function redeemPointsForCustomer(event, customerId, customerPoints) {
            event.preventDefault();
            
            const ruleId = document.getElementById('customerRedemptionRule').value;
            if (!ruleId) {
                showMenuNotification('‚ùå Bitte w√§hlen Sie eine Einl√∂sungsregel aus!', 'error');
                return;
            }
            
            const selectedOption = document.getElementById('customerRedemptionRule').options[document.getElementById('customerRedemptionRule').selectedIndex];
            const pointsRequired = parseInt(selectedOption.getAttribute('data-points') || '0');
            
            if (customerPoints < pointsRequired) {
                showMenuNotification(`‚ùå Nicht genug Punkte! Ben√∂tigt: ${pointsRequired}, Verf√ºgbar: ${customerPoints}`, 'error');
                return;
            }
            
            try {
                const response = await fetch('api/v1/data/points/redeem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        rule_id: ruleId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification(`‚úÖ Punkte erfolgreich eingel√∂st! Rabattcode: ${data.promotion_code || 'N/A'}`, 'success');
                    closeRedeemPointsModal();
                    // Reload customers to update points
                    await loadCustomers();
                } else {
                    showMenuNotification('‚ùå Fehler: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error redeeming points:', error);
                showMenuNotification('‚ùå Fehler: ' + error.message, 'error');
            }
        }

        // Promotion email functions
        let selectedCustomers = [];

        async function loadCustomersForPromotion() {
            try {
                const response = await fetch('api/promotions.php?action=list-customers');
                const data = await response.json();
                
                if (data.success) {
                    const customersList = document.getElementById('customersList');
                    if (customersList) {
                        if (data.customers.length === 0) {
                            customersList.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 20px;">Keine Kunden vorhanden</p>';
                            return;
                        }
                        
                        customersList.innerHTML = data.customers.map(customer => `
                            <label style="display: flex; align-items: center; padding: 8px; margin-bottom: 4px; background: rgba(255, 255, 255, 0.02); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" value="${customer.email}" data-name="${customer.name}" 
                                    onchange="updateSelectedCustomers()" 
                                    style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                                <span style="color: rgba(255, 255, 255, 0.9);">${customer.name} (${customer.email})</span>
                            </label>
                        `).join('');
                    }
                } else {
                    alert('Fehler beim Laden der Kundenliste: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                alert('Fehler beim Laden der Kundenliste: ' + error.message);
            }
        }

        function updateSelectedCustomers() {
            const checkboxes = document.querySelectorAll('#customersList input[type="checkbox"]:checked');
            selectedCustomers = Array.from(checkboxes).map(cb => ({
                email: cb.value,
                name: cb.getAttribute('data-name')
            }));
        }

        function selectAllCustomers() {
            const checkboxes = document.querySelectorAll('#customersList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCustomers();
        }

        function clearCustomerSelection() {
            const checkboxes = document.querySelectorAll('#customersList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            selectedCustomers = [];
        }

        // ========== REDEMPTION RULES MANAGEMENT ==========
        let allRedemptionRules = [];
        
        async function loadRedemptionRules() {
            try {
                const response = await fetch('api/points.php?action=rules');
                const data = await response.json();
                
                if (data.success) {
                    // API returns {success: true, rules: [...]}
                    allRedemptionRules = data.rules || data.data || [];
                    renderRedemptionRules();
                } else {
                    console.error('Failed to load redemption rules:', data.message);
                    document.getElementById('redemptionRulesList').innerHTML = `
                        <p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Fehler beim Laden der Regeln: ${data.message}</p>
                    `;
                }
            } catch (error) {
                console.error('Error loading redemption rules:', error);
                document.getElementById('redemptionRulesList').innerHTML = `
                    <p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Fehler: ${error.message}</p>
                `;
            }
        }
        
        function renderRedemptionRules() {
            const container = document.getElementById('redemptionRulesList');
            
            if (!allRedemptionRules || allRedemptionRules.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(229, 207, 142, 0.2); border-radius: 12px; padding: 40px; text-align: center;">
                        <p style="color: rgba(255, 255, 255, 0.5); margin: 0;">Keine Einl√∂sungsregeln vorhanden. Klicken Sie auf "Neue Regel hinzuf√ºgen" um eine zu erstellen.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allRedemptionRules.map(rule => {
                const statusColor = rule.status === 'active' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                const statusText = rule.status === 'active' ? 'Aktiv' : 'Inaktiv';
                const statusBorder = rule.status === 'active' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                
                let discountText = '';
                if (rule.discount_type === 'percentage') {
                    discountText = `${rule.discount_value}% Rabatt`;
                } else if (rule.discount_type === 'fixed') {
                    discountText = `${rule.discount_value}‚Ç¨ Rabatt`;
                } else {
                    // Fallback for old format
                    if (rule.discount_percent > 0) {
                        discountText = `${rule.discount_percent}% Rabatt`;
                    } else if (rule.discount_amount > 0) {
                        discountText = `${rule.discount_amount}‚Ç¨ Rabatt`;
                    }
                }
                
                return `
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid ${statusBorder}; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <h3 style="color: var(--gold); margin: 0 0 8px 0; font-size: 18px;">${rule.points_required} Punkte</h3>
                                <p style="color: rgba(255, 255, 255, 0.9); margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">‚Üí ${discountText}</p>
                                ${rule.min_order > 0 ? `<p style="color: rgba(255, 255, 255, 0.6); margin: 4px 0 0 0; font-size: 14px;">Mindestbestellwert: ${rule.min_order}‚Ç¨</p>` : ''}
                                <p style="color: rgba(255, 255, 255, 0.6); margin: 4px 0 0 0; font-size: 14px;">G√ºltig: ${rule.valid_days || 30} Tage</p>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="background: ${statusColor}; border: 1px solid ${statusBorder}; color: ${rule.status === 'active' ? '#86efac' : '#fca5a5'}; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">${statusText}</span>
                                <button class="filter-btn" onclick="editRedemptionRule('${rule.rule_id}')" style="background: rgba(229, 207, 142, 0.1); padding: 8px 16px; font-size: 13px; cursor: pointer;">‚úèÔ∏è Bearbeiten</button>
                                <button class="filter-btn" onclick="deleteRedemptionRule('${rule.rule_id}')" style="background: rgba(239, 68, 68, 0.1); padding: 8px 16px; font-size: 13px; cursor: pointer;">üóëÔ∏è L√∂schen</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showAddRedemptionRuleModal() {
            showRedemptionRuleModal(null);
        }
        
        function editRedemptionRule(ruleId) {
            const rule = allRedemptionRules.find(r => r.rule_id === ruleId);
            if (rule) {
                showRedemptionRuleModal(rule);
            }
        }
        
        function showRedemptionRuleModal(rule = null) {
            const existingModal = document.getElementById('redemptionRuleModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'time-schedule-modal active';
            modal.id = 'redemptionRuleModal';
            modal.style.display = 'flex';
            modal.onclick = function(e) {
                if (e.target.id === 'redemptionRuleModal') closeRedemptionRuleModal();
            };
            
            const isEdit = rule !== null;
            
            modal.innerHTML = `
                <div class="time-schedule-content" style="max-width: 600px; text-align: left;" onclick="event.stopPropagation()">
                    <h3 style="text-align: center; margin-bottom: 30px;">${isEdit ? '‚úèÔ∏è Regel bearbeiten' : '‚ûï Neue Regel hinzuf√ºgen'}</h3>
                    <form id="redemptionRuleForm" onsubmit="saveRedemptionRule(event, ${isEdit ? `'${rule.rule_id}'` : 'null'})">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Ben√∂tigte Punkte *</label>
                            <input type="number" id="rulePointsRequired" class="filter-input" required min="1" step="1" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" value="${rule ? rule.points_required : ''}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Rabatttyp *</label>
                            <select id="ruleDiscountType" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" onchange="updateDiscountFields()">
                                <option value="">-- Typ ausw√§hlen --</option>
                                <option value="percentage" ${rule && rule.discount_type === 'percentage' ? 'selected' : ''}>Prozent (%)</option>
                                <option value="fixed" ${rule && rule.discount_type === 'fixed' ? 'selected' : ''}>Fester Betrag (‚Ç¨)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;" id="discountValueContainer">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;" id="discountValueLabel">Rabattwert *</label>
                            <input type="number" id="ruleDiscountValue" class="filter-input" required min="0" step="0.01" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" value="${rule ? rule.discount_value : ''}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Mindestbestellwert (‚Ç¨)</label>
                            <input type="number" id="ruleMinOrder" class="filter-input" min="0" step="0.01" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" value="${rule ? (rule.min_order || 0) : '0'}">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">G√ºltigkeitsdauer (Tage) *</label>
                            <input type="number" id="ruleValidDays" class="filter-input" required min="1" step="1" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;" value="${rule ? (rule.valid_days || 30) : '30'}">
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; color: #fff; margin-bottom: 10px; font-weight: 600; font-size: 14px;">Status</label>
                            <select id="ruleStatus" class="filter-input" required style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(229,207,142,0.3); color: #fff; font-size: 15px; border-radius: 10px;">
                                <option value="active" ${rule && rule.status === 'active' ? 'selected' : ''}>Aktiv</option>
                                <option value="inactive" ${rule && rule.status === 'inactive' ? 'selected' : ''}>Inaktiv</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button type="submit" class="btn-action" style="flex: 1; padding: 14px 24px; background: linear-gradient(135deg, rgba(229,207,142,0.2), rgba(194,163,85,0.3)); border: 2px solid rgba(229,207,142,0.4); color: var(--gold); font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">üíæ Speichern</button>
                            <button type="button" class="btn-action" onclick="closeRedemptionRuleModal()" style="padding: 14px 24px; background: rgba(239,68,68,0.15); border: 2px solid rgba(239,68,68,0.3); color: #ef4444; font-weight: 600; font-size: 15px; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Abbrechen</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.style.display = 'flex';
                modal.classList.add('active');
                updateDiscountFields();
            }, 10);
        }
        
        function updateDiscountFields() {
            const discountType = document.getElementById('ruleDiscountType')?.value;
            const label = document.getElementById('discountValueLabel');
            const input = document.getElementById('ruleDiscountValue');
            
            if (label && input) {
                if (discountType === 'percentage') {
                    label.textContent = 'Rabatt (%) *';
                    input.max = 100;
                    input.step = '1';
                    input.placeholder = '20';
                } else if (discountType === 'fixed') {
                    label.textContent = 'Rabatt (‚Ç¨) *';
                    input.max = '';
                    input.step = '0.01';
                    input.placeholder = '5.00';
                }
            }
        }
        
        function closeRedemptionRuleModal() {
            const modal = document.getElementById('redemptionRuleModal');
            if (modal) modal.remove();
        }
        
        async function saveRedemptionRule(event, ruleId) {
            event.preventDefault();
            
            const pointsRequired = parseInt(document.getElementById('rulePointsRequired').value);
            const discountType = document.getElementById('ruleDiscountType').value;
            const discountValue = parseFloat(document.getElementById('ruleDiscountValue').value);
            const minOrder = parseFloat(document.getElementById('ruleMinOrder').value) || 0;
            const validDays = parseInt(document.getElementById('ruleValidDays').value);
            const status = document.getElementById('ruleStatus').value;
            
            if (pointsRequired <= 0) {
                showMenuNotification('‚ùå Ben√∂tigte Punkte muss gr√∂√üer als 0 sein!', 'error');
                return;
            }
            
            if (discountValue <= 0) {
                showMenuNotification('‚ùå Rabattwert muss gr√∂√üer als 0 sein!', 'error');
                return;
            }
            
            if (discountType === 'percentage' && discountValue > 100) {
                showMenuNotification('‚ùå Rabatt (%) darf nicht gr√∂√üer als 100 sein!', 'error');
                return;
            }
            
            try {
                const url = ruleId ? `api/v1/data/points/rules?action=update&rule_id=${ruleId}` : 'api/v1/data/points/rules?action=create';
                const method = 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        points_required: pointsRequired,
                        discount_type: discountType,
                        discount_value: discountValue,
                        min_order: minOrder,
                        valid_days: validDays,
                        status: status
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification(`‚úÖ Regel ${ruleId ? 'aktualisiert' : 'erstellt'}!`, 'success');
                    closeRedemptionRuleModal();
                    await loadRedemptionRules();
                } else {
                    showMenuNotification('‚ùå Fehler: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving redemption rule:', error);
                showMenuNotification('‚ùå Fehler: ' + error.message, 'error');
            }
        }
        
        async function deleteRedemptionRule(ruleId) {
            if (!confirm('M√∂chten Sie diese Regel wirklich l√∂schen?')) {
                return;
            }
            
            try {
                const response = await fetch(`api/v1/data/points/rules?action=delete&rule_id=${ruleId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification('‚úÖ Regel gel√∂scht!', 'success');
                    await loadRedemptionRules();
                } else {
                    showMenuNotification('‚ùå Fehler: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error deleting redemption rule:', error);
                showMenuNotification('‚ùå Fehler: ' + error.message, 'error');
            }
        }

        // Load all data
        async function loadAllData(silent = false) {
            await loadStats(); // Load stats first to get all orders
            await loadOrders(silent);
            await loadReservations();
            // Load customers but don't fail if permissions error
            try {
                await loadCustomers();
            } catch (error) {
                console.warn('Could not load customers (permissions issue):', error);
                // Continue even if customers fail to load
            }
        }
        
        // Show new order notification
        function showNewOrderNotification(order) {
            // Play notification sound
            console.log('üîî Neue Bestellung erhalten!', order);
            playNotificationSound();
            
            // Request browser notification permission
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                if (Notification.permission === 'granted') {
                const orderId = order.order_id || order._id || 'N/A';
                    const orderIdShort = orderId.toString().replace(/^(ORD-|LEO-)/, '').slice(-8);
                    
                    // Parse delivery_address (could be JSON string or object)
                    let address = {};
                    if (order.delivery_address) {
                        if (typeof order.delivery_address === 'string') {
                            try {
                                address = JSON.parse(order.delivery_address);
                            } catch (e) {
                                address = {};
                            }
                        } else {
                            address = order.delivery_address;
                        }
                    }
                    
                    const customerName = `${address.firstName || address.first_name || ''} ${address.lastName || address.last_name || ''}`.trim() || 'Kunde';
                    
                    // Parse summary (could be JSON string or object)
                    let summary = {};
                    if (order.summary) {
                        if (typeof order.summary === 'string') {
                            try {
                                summary = JSON.parse(order.summary);
                            } catch (e) {
                                summary = {};
                            }
                        } else {
                            summary = order.summary;
                        }
                    }
                    
                    const total = summary.total || order.order_total || '0,00 ‚Ç¨';
                
                new Notification('üç£ Neue Bestellung!', {
                    body: `Bestellung #${orderIdShort} - ${customerName} - ${total}`,
                    icon: '/assets/logo.png',
                    badge: '/assets/logo.png',
                    tag: `order-${orderId}`,
                    requireInteraction: false
                });
                }
            }
            
            // Create in-page notification
            const orderId = order.order_id || order._id || 'N/A';
            const orderIdShort = orderId.toString().replace(/^(ORD-|LEO-)/, '').slice(-8);
            
            // Parse delivery_address
            let address = {};
            if (order.delivery_address) {
                if (typeof order.delivery_address === 'string') {
                    try {
                        address = JSON.parse(order.delivery_address);
                    } catch (e) {
                        address = {};
                    }
                } else {
                    address = order.delivery_address;
                }
            }
            
            const customerName = `${address.firstName || address.first_name || ''} ${address.lastName || address.last_name || ''}`.trim() || 'Kunde';
            const phone = address.phone || 'N/A';
            
            // Parse summary
            let summary = {};
            if (order.summary) {
                if (typeof order.summary === 'string') {
                    try {
                        summary = JSON.parse(order.summary);
                    } catch (e) {
                        summary = {};
                    }
                } else {
                    summary = order.summary;
                }
            }
            
            const total = summary.total || order.order_total || '0,00 ‚Ç¨';
            const serviceType = order.service_type === 'delivery' ? 'Lieferung' : order.service_type === 'pickup' ? 'Abholung' : 'Reservierung';
            
            const notification = document.createElement('div');
            notification.className = 'new-order-notification';
            notification.dataset.orderId = orderId;
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-icon">üîî</div>
                    <h3 class="notification-title">Neue Bestellung!</h3>
                    <button class="notification-close" onclick="closeNewOrderNotification(this)">√ó</button>
                </div>
                <div class="notification-content">
                    <p style="margin: 0 0 12px 0; font-weight: 600;">Bestellung #${orderIdShort}</p>
                    <div class="notification-order-info">
                        <div class="notification-order-item">
                            <span class="notification-order-label">Kunde:</span>
                            <span class="notification-order-value">${customerName}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">Telefon:</span>
                            <span class="notification-order-value">${phone}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">Typ:</span>
                            <span class="notification-order-value">${serviceType}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">Gesamt:</span>
                            <span class="notification-order-value" style="color: var(--gold);">${total}</span>
                        </div>
                    </div>
                    <div class="notification-actions">
                        <button class="notification-btn notification-btn-view" onclick="viewNewOrder('${orderId}'); closeNewOrderNotification(this.closest('.new-order-notification'))">Details anzeigen</button>
                        <button class="notification-btn notification-btn-confirm" onclick="confirmOrder('${orderId}'); closeNewOrderNotification(this.closest('.new-order-notification'))">Best√§tigen</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto close after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNewOrderNotification(notification.querySelector('.notification-close'));
                }
            }, 10000);
            
            // Click to close
            notification.addEventListener('click', (e) => {
                if (e.target === notification || e.target.closest('.notification-close')) {
                    return;
                }
                // Click on notification body will scroll to order
                viewNewOrder(orderId);
            });
        }
        
        // Close new order notification
        function closeNewOrderNotification(button) {
            const notification = button.closest ? button.closest('.new-order-notification') : button;
            if (notification) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }
        
        // Show new reservation notification
        function showNewReservationNotification(reservation) {
            // Play notification sound
            console.log('üîî Neue Reservierung erhalten!', reservation);
            playNotificationSound();
            
            // Request browser notification permission
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                if (Notification.permission === 'granted') {
                    const reservationId = reservation.reservation_id || reservation.reservationId || 'N/A';
                    const reservationIdShort = reservationId.toString().replace(/^(RES-)/, '').slice(-8);
                    const customerName = `${reservation.first_name || ''} ${reservation.last_name || ''}`.trim() || 'Kunde';
                    const date = reservation.date || '';
                    const time = reservation.time || '';
                    
                    new Notification('üìÖ Neue Reservierung!', {
                        body: `Reservierung #${reservationIdShort} - ${customerName} - ${date} ${time}`,
                        icon: '/assets/logo.png',
                        badge: '/assets/logo.png',
                        tag: `reservation-${reservationId}`,
                        requireInteraction: false
                    });
                }
            }
            
            // Create in-page notification
            const reservationId = reservation.reservation_id || reservation.reservationId || 'N/A';
            const reservationIdShort = reservationId.toString().replace(/^(RES-)/, '').slice(-8);
            const customerName = `${reservation.first_name || ''} ${reservation.last_name || ''}`.trim() || 'Kunde';
            const phone = reservation.phone || 'N/A';
            const date = reservation.date || '';
            const time = reservation.time || '';
            const guests = reservation.guests || 'N/A';
            
            const notification = document.createElement('div');
            notification.className = 'new-order-notification';
            notification.dataset.reservationId = reservationId;
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-icon">üìÖ</div>
                    <h3 class="notification-title">Neue Reservierung!</h3>
                    <button class="notification-close" onclick="closeNewOrderNotification(this)">√ó</button>
                </div>
                <div class="notification-content">
                    <p style="margin: 0 0 12px 0; font-weight: 600;">Reservierung #${reservationIdShort}</p>
                    <div class="notification-order-info">
                        <div class="notification-order-item">
                            <span class="notification-order-label">Kunde:</span>
                            <span class="notification-order-value">${customerName}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">Telefon:</span>
                            <span class="notification-order-value">${phone}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">Datum:</span>
                            <span class="notification-order-value">${date} ${time}</span>
                        </div>
                        <div class="notification-order-item">
                            <span class="notification-order-label">G√§ste:</span>
                            <span class="notification-order-value">${guests}</span>
                        </div>
                    </div>
                    <div class="notification-actions">
                        <button class="notification-btn notification-btn-view" onclick="viewNewReservation('${reservationId}'); closeNewOrderNotification(this.closest('.new-order-notification'))">Details anzeigen</button>
                        <button class="notification-btn notification-btn-confirm" onclick="confirmReservation('${reservationId}'); closeNewOrderNotification(this.closest('.new-order-notification'))">Best√§tigen</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto close after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNewOrderNotification(notification.querySelector('.notification-close'));
                }
            }, 10000);
            
            // Click to close
            notification.addEventListener('click', (e) => {
                if (e.target === notification || e.target.closest('.notification-close')) {
                    return;
                }
                // Click on notification body will scroll to reservation
                viewNewReservation(reservationId);
            });
        }
        
        // View new reservation (scroll to it)
        function viewNewReservation(reservationId) {
            // Switch to reservations tab
            const reservationsTab = document.querySelector('.admin-tab[onclick*="reservations"]');
            if (reservationsTab) {
                reservationsTab.click();
            }
            
            // Scroll to reservation after a short delay
            setTimeout(() => {
                const reservationElement = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (reservationElement) {
                    reservationElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    reservationElement.style.border = '2px solid var(--gold)';
                    setTimeout(() => {
                        reservationElement.style.border = '';
                    }, 3000);
                }
            }, 500);
        }
        
        // View new order (scroll to it)
        function viewNewOrder(orderId) {
            // Switch to orders tab
            const ordersTab = document.querySelector('.admin-tab[onclick*="orders"]');
            if (ordersTab) {
                ordersTab.click();
            }
            
            // Find and scroll to order card
            setTimeout(() => {
                const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                if (orderCard) {
                    orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight the card
                    orderCard.style.animation = 'pulse 2s ease 3';
                    setTimeout(() => {
                        orderCard.style.animation = '';
                    }, 6000);
                }
            }, 300);
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted');
                    }
                });
            }
        }
        
        // Initialize notification sound
        let audioContext = null;
        let audioContextInitialized = false;
        
        // Initialize audio context on first user interaction
        function initAudioContext() {
            if (!audioContextInitialized) {
                try {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    // Resume audio context if suspended
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            audioContextInitialized = true;
                            console.log('‚úÖ Audio context initialized and resumed');
                        }).catch(e => {
                            console.log('Could not resume audio context:', e);
                        });
                    } else {
                        audioContextInitialized = true;
                        console.log('‚úÖ Audio context initialized');
                    }
                } catch (e) {
                    console.log('Could not initialize audio context:', e);
                }
            }
        }
        
        function initNotificationSound() {
            try {
                // Create or reuse audio context
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume audio context if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        playNotificationSound();
                    }).catch(e => {
                        console.log('Could not resume audio context:', e);
                    });
                } else {
                    playNotificationSound();
                }
            } catch (e) {
                console.log('Could not create notification sound:', e);
            }
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                // Create or reuse audio context
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume audio context if suspended (browser autoplay policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('üîä Audio context resumed, playing sound');
                        playSoundInternal();
                    }).catch(e => {
                        console.log('Could not resume audio context:', e);
                        // Try to play anyway
                        playSoundInternal();
                    });
                } else if (audioContext.state === 'running') {
                    // Audio context is ready, play immediately
                    console.log('üîä Playing notification sound');
                    playSoundInternal();
                } else {
                    // Audio context is in 'closed' state, try to create a new one
                    console.log('‚ö†Ô∏è Audio context closed, creating new one');
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    playSoundInternal();
                }
            } catch (e) {
                console.log('Could not play notification sound (Web Audio):', e);
                // Fallback to HTML5 Audio
                playNotificationSoundFallback();
            }
        }
        
        // Fallback method using HTML5 Audio (more compatible)
        function playNotificationSoundFallback() {
            try {
                // Create audio element with data URI (beep sound)
                const audio = new Audio();
                // Use a simple beep sound using data URI
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
                
                console.log('üîä Played notification sound (fallback)');
            } catch (e) {
                console.log('Could not play notification sound (fallback):', e);
            }
        }
        
        // Internal function to actually play the sound
        function playSoundInternal() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Create a pleasant notification sound (ding-dong)
                const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5 - C major chord
                const durations = [0.15, 0.15, 0.2];
                
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';
                        
                        const now = audioContext.currentTime;
                        const duration = durations[index];
                        
                        // Smooth attack and release
                        gainNode.gain.setValueAtTime(0, now);
                        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);
                        gainNode.gain.linearRampToValueAtTime(0.2, now + duration - 0.05);
                        gainNode.gain.linearRampToValueAtTime(0, now + duration);
                        
                        oscillator.start(now);
                        oscillator.stop(now + duration);
                        } catch (e) {
                            console.log('Error creating oscillator:', e);
                        }
                    }, index * 200);
                });
            } catch (e) {
                console.log('Error in playSoundInternal:', e);
            }
        }
        
        // Test sound function (can be called manually)
        function testNotificationSound() {
            playNotificationSound();
        }

        // Global variable to store all orders
        let allOrdersData = [];
        let allReservationsData = [];
        let knownOrderIds = new Set(); // Track known orders for new order detection
        let knownReservationIds = new Set(); // Track known reservations for new reservation detection
        
        // Track user interaction to prevent refresh during actions
        let isUserInteracting = false;
        let lastInteractionTime = 0;
        let savedScrollPosition = 0;
        let refreshPaused = false;
        
        // Track user interactions and initialize audio context
        document.addEventListener('mousedown', () => {
            isUserInteracting = true;
            lastInteractionTime = Date.now();
            initAudioContext(); // Initialize audio on first interaction
            setTimeout(() => {
                if (Date.now() - lastInteractionTime > 2000) {
                    isUserInteracting = false;
                }
            }, 2000);
        });
        
        document.addEventListener('keydown', () => {
            isUserInteracting = true;
            lastInteractionTime = Date.now();
            initAudioContext(); // Initialize audio on first interaction
            setTimeout(() => {
                if (Date.now() - lastInteractionTime > 2000) {
                    isUserInteracting = false;
                }
            }, 2000);
        });
        
        // Also try to initialize on touch events (mobile)
        document.addEventListener('touchstart', () => {
            initAudioContext();
        }, { once: true });
        
        // Check if modal is open
        function isModalOpen() {
            return document.querySelector('.modal:not([style*="display: none"])') !== null ||
                   document.querySelector('[class*="modal"][style*="display: block"]') !== null ||
                   document.querySelector('.time-picker-modal:not([style*="display: none"])') !== null;
        }

        // Load statistics
        async function loadStats() {
            // Try to load from Firebase first
            if (typeof window !== 'undefined' && window.db && typeof getAllOrdersFromFirebase === 'function') {
                try {
                    allOrdersData = await getAllOrdersFromFirebase() || [];
                } catch (error) {
                    console.error('Failed to load orders for stats:', error);
                    allOrdersData = [];
                }
            }
            
            // Try to load reservations
            if (typeof window !== 'undefined' && window.db && typeof getAllReservationsFromFirebase === 'function') {
                try {
                    allReservationsData = await getAllReservationsFromFirebase() || [];
                } catch (error) {
                    console.error('Failed to load reservations for stats:', error);
                    allReservationsData = [];
                }
            }
            
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = allOrdersData.filter(o => {
                const orderDate = getOrderDate(o);
                return orderDate === today;
            });
            
            const confirmedOrders = allOrdersData.filter(o => o.status === 'confirmed');
            const pendingOrders = allOrdersData.filter(o => !o.status || o.status === 'pending');
            
            const totalRevenue = confirmedOrders.reduce((sum, o) => sum + parseFloat(o.summary?.total || 0), 0);
            const todayRevenue = todayOrders
                .filter(o => o.status === 'confirmed')
                .reduce((sum, o) => sum + parseFloat(o.summary?.total || 0), 0);
            
            // Calculate total VAT (7% of subtotal after discount)
            const totalVAT = confirmedOrders.reduce((sum, o) => {
                // Try to get VAT from order data
                let vat = 0;
                if (o.vat) {
                    vat = parseFloat(o.vat) || 0;
                } else if (o.summary?.vat) {
                    vat = parseFloat(o.summary.vat) || 0;
                } else if (o.summary?.subtotal) {
                    // Calculate VAT from subtotal (7%)
                    const subtotal = parseFloat(o.summary.subtotal) || 0;
                    vat = (subtotal * 7) / 100;
                }
                return sum + vat;
            }, 0);
            
            const todayVAT = todayOrders
                .filter(o => o.status === 'confirmed')
                .reduce((sum, o) => {
                    let vat = 0;
                    if (o.vat) {
                        vat = parseFloat(o.vat) || 0;
                    } else if (o.summary?.vat) {
                        vat = parseFloat(o.summary.vat) || 0;
                    } else if (o.summary?.subtotal) {
                        const subtotal = parseFloat(o.summary.subtotal) || 0;
                        vat = (subtotal * 7) / 100;
                    }
                    return sum + vat;
                }, 0);
            
            const avgOrderValue = confirmedOrders.length > 0 
                ? totalRevenue / confirmedOrders.length 
                : 0;
            
            const upcomingReservations = allReservationsData.filter(r => r.date >= today);
            const pendingReservations = upcomingReservations.filter(r => !r.status || r.status === 'pending');
            
            document.getElementById('adminStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-value">${allOrdersData.length}</div>
                    <div class="stat-label">Gesamtbestellungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value">${pendingOrders.length}</div>
                    <div class="stat-label">Ausstehend</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value">${confirmedOrders.length}</div>
                    <div class="stat-label">Best√§tigt</div>
                </div>
                <div class="stat-card stat-card-revenue">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-value">‚Ç¨${totalRevenue.toFixed(2)}</div>
                    <div class="stat-label">Gesamtumsatz</div>
                    <div class="stat-sublabel">Heute: ‚Ç¨${todayRevenue.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value">‚Ç¨${avgOrderValue.toFixed(2)}</div>
                    <div class="stat-label">Durchschnittlicher Bestellwert</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value">${pendingReservations.length}</div>
                    <div class="stat-label">Ausstehende Reservierungen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üßæ</div>
                    <div class="stat-value">‚Ç¨${totalVAT.toFixed(2)}</div>
                    <div class="stat-label">MwSt./USt. (7%)</div>
                    <div class="stat-sublabel">Heute: ‚Ç¨${todayVAT.toFixed(2)}</div>
                </div>
            `;
        }

        // Helper function to get order date
        function getOrderDate(order) {
            if (order.date) return order.date;
            if (order.createdAt) {
                if (order.createdAt.seconds) {
                    return new Date(order.createdAt.seconds * 1000).toISOString().split('T')[0];
                } else if (order.createdAt.toDate) {
                    return order.createdAt.toDate().toISOString().split('T')[0];
                } else if (typeof order.createdAt === 'string') {
                    return new Date(order.createdAt).toISOString().split('T')[0];
                }
            }
            if (order.summary?.timestamp) {
                return new Date(order.summary.timestamp).toISOString().split('T')[0];
            }
            return new Date().toISOString().split('T')[0];
        }

        // Load orders - load ALL orders, not just today
        async function loadOrders(silent = false, preserveScroll = false) {
            const ordersList = document.getElementById('ordersList');
            
            // Save scroll position if preserving
            if (preserveScroll) {
                savedScrollPosition = ordersList.scrollTop || window.scrollY || 0;
            }
            
            // Only show loading if not silent and not preserving scroll
            if (!silent && !preserveScroll) {
            ordersList.innerHTML = `
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p style="color: rgba(255,255,255,.7);">Bestellungen werden geladen...</p>
                </div>
            `;
            }
            
            try {
                // Get current status filter
                const statusFilter = document.querySelector('.filter-btn.active[data-status]')?.dataset.status || 'all';
                
                // Call API to get orders (GET request with query parameter)
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                // Encode route parameter to handle slashes properly
                const url = `api/index.php?route=${encodeURIComponent('v1/data/orders')}${statusFilter !== 'all' ? '&status=' + encodeURIComponent(statusFilter) : ''}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Non-JSON response from orders API:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response. This might be a server error. Please check the server logs.');
                }
                
                const data = await response.json();
                
                console.log('üì¶ Orders API Response:', data);
                
                if (data.success && data.orders) {
                    allOrdersData = data.orders;
                    console.log('‚úÖ Loaded orders:', allOrdersData.length);
                    
                    // Always check for new orders (even in silent mode - we still want sound!)
                        const previousOrderIds = new Set(knownOrderIds);
                        const currentOrderIds = new Set();
                        
                    allOrdersData.forEach(order => {
                        if (order.order_id) {
                            currentOrderIds.add(order.order_id.toString());
                        }
                    });
                    
                    // Find new orders
                        if (previousOrderIds.size > 0) {
                            const newOrderIds = [...currentOrderIds].filter(id => !previousOrderIds.has(id));
                            if (newOrderIds.length > 0) {
                            const newOrders = allOrdersData.filter(order => 
                                order.order_id && newOrderIds.includes(order.order_id.toString())
                            );
                            
                                newOrders.forEach(order => {
                                    // ALWAYS show notification for new orders, regardless of tab or mode
                                    console.log('üîî Neue Bestellung gefunden!', order);
                                    
                                    // Always play sound
                                    playNotificationSound();
                                    
                                    // Always show in-page notification UI (regardless of tab)
                                    showNewOrderNotification(order);
                                    
                                    // Also show browser notification if permitted
                                    if ('Notification' in window && Notification.permission === 'granted') {
                                        const orderId = order.order_id || order._id || 'N/A';
                                        const orderIdShort = orderId.toString().replace(/^(ORD-|LEO-)/, '').slice(-8);
                                        
                                        let address = {};
                                        if (order.delivery_address) {
                                            if (typeof order.delivery_address === 'string') {
                                                try { address = JSON.parse(order.delivery_address); } catch (e) {}
                                            } else { address = order.delivery_address; }
                                        }
                                        
                                        const customerName = `${address.firstName || address.first_name || ''} ${address.lastName || address.last_name || ''}`.trim() || 'Kunde';
                                        
                                        let summary = {};
                                        if (order.summary) {
                                            if (typeof order.summary === 'string') {
                                                try { summary = JSON.parse(order.summary); } catch (e) {}
                                            } else { summary = order.summary; }
                                        }
                                        
                                        const total = summary.total || order.order_total || '0,00 ‚Ç¨';
                                        
                                        new Notification('üç£ Neue Bestellung!', {
                                            body: `Bestellung #${orderIdShort} - ${customerName} - ${total}`,
                                            icon: '/assets/logo.png',
                                            badge: '/assets/logo.png',
                                            tag: `order-${orderId}`,
                                            requireInteraction: false
                                        });
                                    }
                            });
                        }
                    }
                    
                    knownOrderIds = currentOrderIds;
                    
                    // Smart update: ch·ªâ update ph·∫ßn thay ƒë·ªïi, kh√¥ng re-render to√†n b·ªô
                    if (allOrdersData.length > 0) {
                        if (preserveScroll) {
                            // Smart update mode: ch·ªâ update thay ƒë·ªïi
                            smartUpdateOrders(allOrdersData);
                            
                            // Restore scroll position
                            setTimeout(() => {
                                const ordersList = document.getElementById('ordersList');
                                if (ordersList) {
                                    ordersList.scrollTop = savedScrollPosition;
                                } else {
                                    window.scrollTo(0, savedScrollPosition);
                                }
                            }, 50);
                        } else {
                            // Full render mode
                            displayOrders(allOrdersData);
                        }
                    } else {
                        ordersList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <h3 style="color: rgba(255,255,255,.8); margin: 16px 0 8px; font-size: 18px;">Keine Bestellungen</h3>
                                <p style="color: rgba(255,255,255,.5);">Neue Bestellungen werden hier angezeigt</p>
                            </div>
                        `;
                    }
                } else {
                    console.error('‚ùå API returned error:', data);
                    throw new Error(data.message || 'Fehler beim Laden der Bestellungen');
                }
                } catch (error) {
                console.error('‚ùå Error loading orders:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });
                        ordersList.innerHTML = `
                            <div class="empty-state" style="background: rgba(239,68,68,.1); border: 2px solid rgba(239,68,68,.3);">
                                <div class="empty-state-icon">‚ùå</div>
                                <h3 style="color: #ef4444; margin: 16px 0 8px; font-size: 18px;">Fehler beim Laden der Bestellungen</h3>
                                <p style="color: rgba(255,255,255,.7); margin-bottom: 12px;">${error.message || 'Unknown error'}</p>
                                <button class="btn-action btn-view" onclick="loadOrders()" style="margin-top: 12px;">Erneut versuchen</button>
                            </div>
                        `;
                    }
        }
        
        // Apply date filter to orders
        function applyDateFilterToOrders(orders) {
            const dateFilter = document.getElementById('dateFilter')?.value || 'today'; // Default to 'today' instead of 'all'
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (dateFilter === 'all') {
                return orders;
            } else if (dateFilter === 'today') {
                const todayStr = today.toISOString().split('T')[0];
                return orders.filter(o => getOrderDate(o) === todayStr);
            } else if (dateFilter === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return orders.filter(o => {
                    const orderDate = new Date(getOrderDate(o));
                    return orderDate >= weekAgo;
                });
            } else if (dateFilter === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setDate(monthAgo.getDate() - 30);
                return orders.filter(o => {
                    const orderDate = new Date(getOrderDate(o));
                    return orderDate >= monthAgo;
                });
            } else if (dateFilter === 'custom') {
                const startDate = document.getElementById('customDateStart')?.value;
                const endDate = document.getElementById('customDateEnd')?.value;
                if (!startDate || !endDate) return orders;
                return orders.filter(o => {
                    const orderDate = getOrderDate(o);
                    return orderDate >= startDate && orderDate <= endDate;
                });
            }
            return orders;
        }
        
        // Apply date filter
        function applyDateFilter() {
            const dateFilter = document.getElementById('dateFilter')?.value || 'today'; // Default to 'today' instead of 'all'
            const customStart = document.getElementById('customDateStart');
            const customEnd = document.getElementById('customDateEnd');
            
            if (dateFilter === 'custom') {
                if (customStart) customStart.style.display = 'block';
                if (customEnd) customEnd.style.display = 'block';
            } else {
                if (customStart) customStart.style.display = 'none';
                if (customEnd) customEnd.style.display = 'none';
            }
            
            // Re-display orders with filter
            if (allOrdersData && allOrdersData.length > 0) {
                const filteredOrders = applyDateFilterToOrders(allOrdersData);
                // displayOrders will sort orders internally, so just pass filtered orders
                displayOrders(filteredOrders);
            } else {
                loadOrders();
            }
        }

        // Helper function to get status text
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ausstehend',
                'confirmed': 'Best√§tigt',
                'completed': 'Abgeschlossen',
                'cancelled': 'Storniert',
                'processing': 'In Bearbeitung'
            };
            return statusMap[status] || statusMap['pending'] || 'Ausstehend';
        }

        // Display orders function
        // Smart update orders - ch·ªâ update ph·∫ßn thay ƒë·ªïi
        function smartUpdateOrders(newOrders) {
            const ordersList = document.getElementById('ordersList');
            if (!ordersList) return;
            
            // Get existing order cards
            const existingCards = ordersList.querySelectorAll('[data-order-id]');
            const existingOrderIds = new Set();
            existingCards.forEach(card => {
                const orderId = card.getAttribute('data-order-id');
                if (orderId) existingOrderIds.add(orderId);
            });
            
            // Find new orders and updated orders
            const newOrderIds = new Set();
            const updatedOrders = [];
            const ordersToAdd = [];
            
            newOrders.forEach(order => {
                const orderId = (order.order_id || order._id || '').toString();
                if (!orderId) return;
                
                if (!existingOrderIds.has(orderId)) {
                    // New order - add to list
                    ordersToAdd.push(order);
                    newOrderIds.add(orderId);
                } else {
                    // Existing order - check if status changed
                    const existingCard = ordersList.querySelector(`[data-order-id="${orderId}"]`);
                    if (existingCard) {
                        const currentStatus = existingCard.querySelector('.order-status')?.textContent?.trim();
                        const newStatus = getStatusText(order.status || 'pending');
                        
                        if (currentStatus !== newStatus) {
                            // Status changed - update this card
                            updatedOrders.push(order);
                        }
                    }
                }
            });
            
            // Update changed orders
            updatedOrders.forEach(order => {
                const orderId = (order.order_id || order._id || '').toString();
                const existingCard = ordersList.querySelector(`[data-order-id="${orderId}"]`);
                if (existingCard) {
                    // Update status badge
                    const statusBadge = existingCard.querySelector('.order-status');
                    if (statusBadge) {
                        statusBadge.className = `order-status ${order.status || 'pending'}`;
                        statusBadge.textContent = getStatusText(order.status || 'pending');
                    }
                }
            });
            
            // Add new orders to the top (most recent first)
            if (ordersToAdd.length > 0) {
                // Get current scroll position
                const scrollPos = ordersList.scrollTop || window.scrollY || 0;
                
                // Render new orders
                const newOrdersHTML = ordersToAdd.map(order => renderOrderCard(order)).join('');
                
                // Insert at the top
                if (ordersList.children.length === 0 || ordersList.querySelector('.empty-state')) {
                    ordersList.innerHTML = newOrdersHTML;
                } else {
                    ordersList.insertAdjacentHTML('afterbegin', newOrdersHTML);
                }
                
                // Restore scroll position (add offset for new items)
                setTimeout(() => {
                    const newCardsHeight = ordersToAdd.length * 200; // Approximate height per card
                    ordersList.scrollTop = scrollPos + newCardsHeight;
                }, 50);
            }
        }
        
        // Helper function to render a single order card
        function renderOrderCard(order) {
            // This will be a simplified version - you may need to adjust based on your displayOrders function
            const orderId = order.order_id || order._id || 'N/A';
            const orderIdShort = orderId.toString().replace(/^(ORD-|LEO-)/, '').slice(-8);
            const status = order.status || 'pending';
            
            // Parse delivery_address
            let address = {};
            if (order.delivery_address) {
                if (typeof order.delivery_address === 'string') {
                    try { address = JSON.parse(order.delivery_address); } catch (e) {}
                } else { address = order.delivery_address; }
            }
            
            const customerName = `${address.firstName || address.first_name || ''} ${address.lastName || address.last_name || ''}`.trim() || 'Kunde';
            
            // Parse summary
            let summary = {};
            if (order.summary) {
                if (typeof order.summary === 'string') {
                    try { summary = JSON.parse(order.summary); } catch (e) {}
                } else { summary = order.summary; }
            }
            
            const total = summary.total || order.order_total || '0,00 ‚Ç¨';
            
            return `
                <div class="order-card" data-order-id="${orderId}">
                    <div class="order-header">
                        <div>
                            <div class="order-id">Bestellung #${orderIdShort}</div>
                            <div class="order-date">${new Date(order.date || order.created_at || Date.now()).toLocaleString('de-DE')}</div>
                        </div>
                        <span class="order-status ${status}">${getStatusText(status)}</span>
                    </div>
                    <div class="order-info">
                        <div class="order-info-item">
                            <span class="order-info-label">üë§ Kunde:</span>
                            <span class="order-info-value">${customerName}</span>
                        </div>
                        <div class="order-info-item">
                            <span class="order-info-label">üí∞ Gesamt:</span>
                            <span class="order-info-value" style="color: var(--gold);">${total}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            
            if (!orders || orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3 style="color: rgba(255,255,255,.8); margin: 16px 0 8px; font-size: 18px;">Heute noch keine Bestellungen</h3>
                        <p style="color: rgba(255,255,255,.5);">Neue Bestellungen werden hier angezeigt</p>
                    </div>
                `;
                return;
            }
            
            // Sort orders by timestamp (newest first)
            const sortedOrders = [...orders].sort((a, b) => {
                // Get timestamp from various possible locations
                const getTimestamp = (order) => {
                    if (order.summary?.timestamp) {
                        return new Date(order.summary.timestamp).getTime();
                    }
                    if (order.createdAt) {
                        if (order.createdAt.seconds) {
                            return order.createdAt.seconds * 1000;
                        }
                        if (order.createdAt.toDate) {
                            return order.createdAt.toDate().getTime();
                        }
                        if (typeof order.createdAt === 'string') {
                            return new Date(order.createdAt).getTime();
                        }
                        return new Date(order.createdAt).getTime();
                    }
                    if (order.timestamp) {
                        return new Date(order.timestamp).getTime();
                    }
                    // Fallback: use order_id if it contains timestamp
                    const orderId = order.order_id || '';
                    const timestampMatch = orderId.match(/\d+/);
                    if (timestampMatch) {
                        return parseInt(timestampMatch[0]);
                    }
                    return 0;
                };
                
                const timeA = getTimestamp(a);
                const timeB = getTimestamp(b);
                return timeB - timeA; // Descending order (newest first)
            });
            
            ordersList.innerHTML = sortedOrders.map(order => {
                const status = order.status || 'pending';
                const statusText = {
                    'pending': 'Ausstehend',
                    'confirmed': 'Best√§tigt',
                    'cancelled': 'Storniert'
                }[status] || 'Ausstehend';
                
                const statusClass = {
                    'pending': 'status-pending',
                    'confirmed': 'status-confirmed',
                    'cancelled': 'status-cancelled'
                }[status] || 'status-pending';
                
                // Handle different createdAt formats
                let orderTime = 'Unbekannt';
                if (order.created_at) {
                    // MySQL timestamp
                    orderTime = new Date(order.created_at).toLocaleString('de-DE');
                } else if (order.summary?.timestamp) {
                    orderTime = new Date(order.summary.timestamp).toLocaleString('de-DE');
                } else if (order.createdAt) {
                    if (order.createdAt.seconds) {
                        // Firestore Timestamp
                        orderTime = new Date(order.createdAt.seconds * 1000).toLocaleString('de-DE');
                    } else if (order.createdAt.toDate) {
                        // Firestore Timestamp with toDate method
                        orderTime = order.createdAt.toDate().toLocaleString('de-DE');
                    } else if (typeof order.createdAt === 'string') {
                        // ISO string
                        orderTime = new Date(order.createdAt).toLocaleString('de-DE');
                    } else {
                        // Try to parse as Date
                        orderTime = new Date(order.createdAt).toLocaleString('de-DE');
                    }
                }
                
                const orderId = order.order_id || order.summary?.timestamp || 'N/A';
                const orderIdShort = orderId.toString().replace('ORD-', '').slice(-8);
                
                // Handle items - can be array or JSON string
                let itemsArray = order.items;
                if (typeof itemsArray === 'string') {
                    try {
                        itemsArray = JSON.parse(itemsArray);
                    } catch (e) {
                        itemsArray = [];
                    }
                }
                if (!Array.isArray(itemsArray)) {
                    itemsArray = [];
                }
                
                const itemsHTML = itemsArray.map(item => `
                    <div class="item-row">
                        <span class="item-name">${item.qty || item.quantity || 1}x ${item.name || item.item_name || 'Unbekannt'}${item.note ? ` (${item.note})` : ''}</span>
                        <span class="item-price">‚Ç¨${item.total || item.price || '0.00'}</span>
                    </div>
                `).join('');
                
                // Try multiple paths to get customer code (check all possible locations)
                // Normalize: trim, uppercase, remove spaces
                let customerCode = order.customerCode || 
                                   order.delivery?.address?.customerCode || 
                                   order.delivery?.customerCode ||
                                   (order.delivery?.address && order.delivery.address.customerCode) ||
                                   null;
                
                // Normalize customer code if found
                if (customerCode) {
                    customerCode = String(customerCode).trim().toUpperCase().replace(/\s+/g, '');
                    // Only keep if it's not empty after normalization
                    if (!customerCode || customerCode === 'NULL' || customerCode === 'UNDEFINED') {
                        customerCode = null;
                    }
                }
                
                // Debug log - always log to help debug
                console.log('üîç Checking customer code for order:', orderId, {
                    'order.customerCode': order.customerCode,
                    'order.delivery?.address?.customerCode': order.delivery?.address?.customerCode,
                    'order.delivery?.customerCode': order.delivery?.customerCode,
                    'Final customerCode': customerCode,
                    'Has delivery': !!order.delivery,
                    'Has delivery.address': !!order.delivery?.address
                });
                
                return `
                    <div class="order-card ${status}" data-order-id="${orderId}">
                        <div class="card-header">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <h3 class="card-title" style="--icon: 'üì¶'; margin: 0;">Bestellung #${orderIdShort}</h3>
                                ${customerCode ? `
                                <div style="background: linear-gradient(135deg, var(--gold), #fbbf24); color: #1a1a1a; padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 13px; font-family: monospace; letter-spacing: 1.5px; box-shadow: 0 2px 8px rgba(229, 207, 142, 0.3); display: flex; align-items: center; gap: 6px;">
                                    <span>üîë</span>
                                    <span>${customerCode}</span>
                                </div>
                                ` : `
                                <div style="background: rgba(255,255,255,.05); color: rgba(255,255,255,.4); padding: 6px 14px; border-radius: 8px; font-weight: 500; font-size: 12px; border: 1px solid rgba(255,255,255,.1);">
                                    <span>üîë</span>
                                    <span>Kein Code</span>
                                </div>
                                `}
                            </div>
                            <span class="card-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-info">
                            <div class="info-item">
                                <span class="info-label">‚è∞ Zeit:</span>
                                <span class="info-value">${orderTime}</span>
                            </div>
                            ${customerCode ? `
                            <div class="info-item">
                                <span class="info-label">üîë Kunden-Code:</span>
                                <span class="info-value" style="color: var(--gold); font-weight: 700; font-family: monospace; letter-spacing: 1px;">${customerCode}</span>
                            </div>
                            ` : ''}
                            <div class="info-item">
                                <span class="info-label">üë§ Kunde:</span>
                                <span class="info-value">${order.delivery_address?.first_name || order.delivery?.address?.firstName || order.delivery?.address?.first_name || ''} ${order.delivery_address?.last_name || order.delivery?.address?.lastName || order.delivery?.address?.last_name || ''}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üì± Telefon:</span>
                                <span class="info-value">${order.delivery_address?.phone || order.delivery?.address?.phone || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">üìß E-Mail:</span>
                                <span class="info-value">${order.delivery_address?.email || order.delivery?.address?.email || 'N/A'}</span>
                            </div>
                            ${order.service_type === 'delivery' ? `
                            <div class="info-item">
                                <span class="info-label">üìç Adresse:</span>
                                <span class="info-value">${order.delivery_address?.street || order.delivery?.address?.street || ''}, ${order.delivery_address?.postal || order.delivery?.address?.postal || ''} ${order.delivery_address?.city || order.delivery?.address?.city || ''}</span>
                            </div>
                            ` : ''}
                            ${order.service_type === 'delivery' && (order.delivery_address?.scheduled_time || order.delivery?.scheduled_time || order.scheduled_delivery_time || order.summary?.scheduled_delivery_time) ? (() => {
                                const scheduledTime = order.delivery_address?.scheduled_time || order.delivery?.scheduled_time || order.scheduled_delivery_time || order.summary?.scheduled_delivery_time;
                                const scheduledDate = scheduledTime?.date || scheduledTime?.datetime?.split('T')[0] || '';
                                const scheduledTimeStr = scheduledTime?.time || scheduledTime?.datetime?.split('T')[1]?.substring(0, 5) || '';
                                const formattedDate = scheduledDate ? new Date(scheduledDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                                return `
                            <div class="info-item">
                                <span class="info-label">‚è∞ Gew√ºnschte Lieferzeit:</span>
                                <span class="info-value" style="color: var(--gold); font-weight: 600;">${formattedDate} um ${scheduledTimeStr} Uhr</span>
                            </div>
                            `;
                            })() : ''}
                            <div class="info-item">
                                <span class="info-label">üöö Service:</span>
                                <span class="info-value">${order.service_type === 'pickup' ? 'Abholung' : order.service_type === 'reservation' ? 'Reservierung' : 'Lieferung'}</span>
                            </div>
                            ${order.service_type === 'pickup' ? `
                            <div class="info-item">
                                <span class="info-label">ü™ë Tisch:</span>
                                <span class="info-value" style="color: ${order.table_number ? 'var(--gold)' : 'rgba(255,255,255,.5)'}; font-weight: ${order.table_number ? '700' : '400'};">
                                    ${order.table_number ? order.table_number : 'Nicht zugewiesen'}
                                </span>
                                ${!order.table_number ? `
                                <button class="btn-action btn-view" onclick="assignTable('${order.order_id}')" style="margin-left: 10px; padding: 6px 14px; font-size: 12px; border-radius: 8px;">Tisch zuweisen</button>
                                ` : ''}
                            </div>
                            ` : ''}
                            <div class="info-item">
                                <span class="info-label">üí≥ Zahlung:</span>
                                <span class="info-value">${order.payment_method === 'cash' || order.summary?.payment_method === 'cash' ? 'Barzahlung' : order.payment_method === 'paypal' || order.summary?.payment_method === 'paypal' ? 'PayPal' : 'Kartenzahlung'}</span>
                            </div>
                            <div class="info-item" style="grid-column: 1 / -1; padding-top: 12px; border-top: 2px solid rgba(229,207,142,.15); margin-top: 4px;">
                                <span class="info-label" style="font-size: 16px; color: var(--gold);">üí∞ Gesamt:</span>
                                <span class="info-value" style="color: var(--gold); font-size: 22px; font-weight: 700;">‚Ç¨${order.summary?.total || (typeof order.summary === 'string' ? JSON.parse(order.summary || '{}').total : '0.00') || '0.00'}</span>
                            </div>
                        </div>
                        ${itemsHTML ? `
                            <div class="items-list">
                                <strong style="color: rgba(255,255,255,.9); margin-bottom: 8px; display: block;">Artikel:</strong>
                                ${itemsHTML}
                            </div>
                        ` : ''}
                        ${order.delivery?.address?.note ? `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                                <strong style="color: #fbbf24;">Hinweis:</strong>
                                <p style="color: rgba(255,255,255,.8); margin: 4px 0 0 0;">${order.delivery.address.note}</p>
                            </div>
                        ` : ''}
                        <div class="card-actions">
                            ${status === 'pending' ? `
                                <button class="btn-action btn-confirm" onclick="confirmOrder('${orderId}')">‚úì Best√§tigen</button>
                                <button class="btn-action btn-cancel" onclick="cancelOrder('${orderId}')">‚úó Stornieren</button>
                            ` : ''}
                            <button class="btn-action btn-view" onclick="viewOrderDetails('${orderId}')">Details</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load reservations
        async function loadReservations(preserveScroll = false) {
            const reservationsList = document.getElementById('reservationsList');
            
            // Save scroll position if preserving
            if (preserveScroll) {
                savedScrollPosition = reservationsList.scrollTop || window.scrollY || 0;
            }
            
            // Only show loading if not preserving scroll
            if (!preserveScroll) {
            reservationsList.innerHTML = `
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p style="color: rgba(255,255,255,.7);">Reservierungen werden geladen...</p>
                </div>
            `;
            }
            
            try {
                // Get current status filter from reservationsContent only
                const statusFilter = document.querySelector('#reservationsContent .filter-btn.active[data-status]')?.dataset.status || 
                                   document.querySelector('#reservationsContent .filter-btn[data-status="all"]')?.dataset.status || 
                                   'all';
                
                console.log('üîç Loading reservations with filter:', statusFilter);
                
                // Call API to get reservations (GET request v·ªõi query parameter)
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                // Encode route parameter to handle slashes properly
                const url = `api/index.php?route=${encodeURIComponent('v1/data/reservations')}${statusFilter !== 'all' ? '&status=' + encodeURIComponent(statusFilter) : ''}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('‚ùå Non-JSON response from reservations API:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response. This might be a server error. Please check the server logs.');
                }
                
                const data = await response.json();
                
                if (data.success && data.reservations) {
                    console.log('üìÖ Loaded reservations from API:', data.reservations.length);
                    
                    // Apply status filter first (API already filtered, but double-check)
                    let filteredReservations = data.reservations;
                    if (statusFilter !== 'all') {
                        filteredReservations = data.reservations.filter(r => (r.status || 'pending') === statusFilter);
                        console.log('üìÖ After status filter:', filteredReservations.length);
                    }
                    
                    // Filter upcoming reservations (date >= today)
                    const today = new Date().toISOString().split('T')[0];
                    const upcomingReservations = filteredReservations.filter(r => r.date >= today);
                    console.log('üìÖ After date filter (upcoming):', upcomingReservations.length);
                    
                    // Always check for new reservations (even in silent mode - we still want sound!)
                    const previousReservationIds = new Set(knownReservationIds);
                    const currentReservationIds = new Set();
                    
                    upcomingReservations.forEach(reservation => {
                        if (reservation.reservation_id) {
                            currentReservationIds.add(reservation.reservation_id.toString());
                        }
                    });
                    
                    // Find new reservations
                    if (previousReservationIds.size > 0) {
                        const newReservationIds = [...currentReservationIds].filter(id => !previousReservationIds.has(id));
                        if (newReservationIds.length > 0) {
                            const newReservations = upcomingReservations.filter(reservation => 
                                reservation.reservation_id && newReservationIds.includes(reservation.reservation_id.toString())
                            );
                            
                            newReservations.forEach(reservation => {
                                // Always play sound, even in silent mode
                                console.log('üîî Neue Reservierung:', reservation);
                                playNotificationSound();
                                
                                // Show notification UI only if not in silent mode
                                if (!preserveScroll) {
                                    showNewReservationNotification(reservation);
                                } else {
                                    // Silent mode: ch·ªâ ph√°t ti·∫øng + browser notification
                                    if ('Notification' in window && Notification.permission === 'granted') {
                                        const reservationId = reservation.reservation_id || reservation.reservationId || 'N/A';
                                        const reservationIdShort = reservationId.toString().replace(/^(RES-)/, '').slice(-8);
                                        const customerName = `${reservation.first_name || ''} ${reservation.last_name || ''}`.trim() || 'Kunde';
                                        const date = reservation.date || '';
                                        const time = reservation.time || '';
                                        
                                        new Notification('üìÖ Neue Reservierung!', {
                                            body: `Reservierung #${reservationIdShort} - ${customerName} - ${date} ${time}`,
                                            icon: '/assets/logo.png',
                                            badge: '/assets/logo.png',
                                            tag: `reservation-${reservationId}`,
                                            requireInteraction: false
                                        });
                                    }
                                }
                            });
                        }
                    }
                    
                    knownReservationIds = currentReservationIds;
                    
                    if (upcomingReservations.length > 0) {
                        // Use smart update only during auto-refresh (preserveScroll = true)
                        // Use full render when user clicks filter or first load (preserveScroll = false)
                        if (preserveScroll) {
                            // Smart update mode: ch·ªâ update thay ƒë·ªïi (auto-refresh)
                            try {
                                smartUpdateReservations(upcomingReservations);
                                
                                // Restore scroll position
                                setTimeout(() => {
                                    const reservationsList = document.getElementById('reservationsList');
                                    if (reservationsList) {
                                        reservationsList.scrollTop = savedScrollPosition;
                                    } else {
                                        window.scrollTo(0, savedScrollPosition);
                                    }
                                }, 50);
                            } catch (e) {
                                console.error('Error in smartUpdateReservations, falling back to full render:', e);
                    displayReservations(upcomingReservations);
                            }
                        } else {
                            // Full render mode (user clicked filter or first load)
                            displayReservations(upcomingReservations);
                        }
                    } else {
                        reservationsList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÖ</div>
                                <h3 style="color: rgba(255,255,255,.8); margin: 16px 0 8px; font-size: 18px;">Keine Reservierungen</h3>
                                <p style="color: rgba(255,255,255,.5);">Neue Reservierungen werden hier angezeigt</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(data.message || 'Fehler beim Laden der Reservierungen');
                }
                } catch (error) {
                console.error('Error loading reservations:', error);
                        reservationsList.innerHTML = `
                            <div class="empty-state" style="background: rgba(239,68,68,.1); border: 2px solid rgba(239,68,68,.3);">
                                <div class="empty-state-icon">‚ùå</div>
                                <h3 style="color: #ef4444; margin: 16px 0 8px; font-size: 18px;">Fehler beim Laden der Reservierungen</h3>
                                <p style="color: rgba(255,255,255,.7); margin-bottom: 12px;">${error.message || 'Unknown error'}</p>
                                <button class="btn-action btn-view" onclick="loadReservations()" style="margin-top: 12px;">Erneut versuchen</button>
                            </div>
                        `;
                    }
        }

        // Smart update reservations - ch·ªâ update ph·∫ßn thay ƒë·ªïi
        function smartUpdateReservations(newReservations) {
            const reservationsList = document.getElementById('reservationsList');
            if (!reservationsList) return;
            
            // Get existing reservation cards
            const existingCards = reservationsList.querySelectorAll('[data-reservation-id]');
            const existingReservationIds = new Set();
            existingCards.forEach(card => {
                const reservationId = card.getAttribute('data-reservation-id');
                if (reservationId) existingReservationIds.add(reservationId);
            });
            
            // Find new reservations and updated reservations
            const updatedReservations = [];
            const reservationsToAdd = [];
            
            newReservations.forEach(reservation => {
                const reservationId = (reservation.reservation_id || reservation.reservationId || '').toString();
                if (!reservationId) return;
                
                if (!existingReservationIds.has(reservationId)) {
                    // New reservation - add to list
                    reservationsToAdd.push(reservation);
                } else {
                    // Existing reservation - check if status changed
                    const existingCard = reservationsList.querySelector(`[data-reservation-id="${reservationId}"]`);
                    if (existingCard) {
                        const currentStatus = existingCard.querySelector('.card-status')?.textContent?.trim();
                        const statusText = {
                            'pending': 'Ausstehend',
                            'confirmed': 'Best√§tigt',
                            'cancelled': 'Storniert'
                        }[reservation.status || 'pending'] || 'Ausstehend';
                        
                        if (currentStatus !== statusText) {
                            // Status changed - update this card
                            updatedReservations.push(reservation);
                        }
                    }
                }
            });
            
            // Update changed reservations
            updatedReservations.forEach(reservation => {
                const reservationId = (reservation.reservation_id || reservation.reservationId || '').toString();
                const existingCard = reservationsList.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (existingCard) {
                    // Update status badge
                    const statusBadge = existingCard.querySelector('.card-status');
                    if (statusBadge) {
                        const status = reservation.status || 'pending';
                        const statusClass = {
                            'pending': 'status-pending',
                            'confirmed': 'status-confirmed',
                            'cancelled': 'status-cancelled'
                        }[status] || 'status-pending';
                        const statusText = {
                            'pending': 'Ausstehend',
                            'confirmed': 'Best√§tigt',
                            'cancelled': 'Storniert'
                        }[status] || 'Ausstehend';
                        
                        statusBadge.className = `card-status ${statusClass}`;
                        statusBadge.textContent = statusText;
                    }
                }
            });
            
            // Add new reservations to the top
            if (reservationsToAdd.length > 0) {
                // Get current scroll position
                const scrollPos = reservationsList.scrollTop || window.scrollY || 0;
                
                // Use displayReservations to render new ones, then prepend
                const tempDiv = document.createElement('div');
                displayReservations(reservationsToAdd, tempDiv);
                
                if (reservationsList.children.length === 0 || reservationsList.querySelector('.empty-state')) {
                    reservationsList.innerHTML = tempDiv.innerHTML;
                } else {
                    reservationsList.insertAdjacentHTML('afterbegin', tempDiv.innerHTML);
                }
                
                // Restore scroll position (add offset for new items)
                setTimeout(() => {
                    const newCardsHeight = reservationsToAdd.length * 200; // Approximate height per card
                    reservationsList.scrollTop = scrollPos + newCardsHeight;
                }, 50);
            }
        }

        // Display reservations function
        function displayReservations(reservations, targetElement = null) {
            const reservationsList = targetElement || document.getElementById('reservationsList');
            
            if (!reservations || reservations.length === 0) {
            reservationsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                        <h3 style="color: rgba(255,255,255,.8); margin: 16px 0 8px; font-size: 18px;">Keine Reservierungen</h3>
                        <p style="color: rgba(255,255,255,.5);">Neue Reservierungen werden hier angezeigt</p>
                </div>
            `;
            return;
            }
            
            reservationsList.innerHTML = reservations.map(reservation => {
                const status = reservation.status || 'pending';
                const statusText = {
                    'pending': 'Ausstehend',
                    'confirmed': 'Best√§tigt',
                    'cancelled': 'Storniert'
                }[status] || 'Ausstehend';
                
                const statusClass = {
                    'pending': 'status-pending',
                    'confirmed': 'status-confirmed',
                    'cancelled': 'status-cancelled'
                }[status] || 'status-pending';
                
                const reservationDateTime = new Date(`${reservation.date}T${reservation.time}`).toLocaleString('de-DE', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const reservationId = reservation.reservation_id || reservation.reservationId || 'N/A';
                const reservationIdShort = reservationId.toString().replace('RES-', '').slice(-8);
                
                return `
                    <div class="reservation-card ${status}" data-reservation-id="${reservationId}">
                        <div class="card-header">
                            <h3 class="card-title" style="--icon: 'üìÖ';">Reservierung #${reservationIdShort}</h3>
                            <span class="card-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="card-info">
                            <div class="info-item">
                                <span class="info-label">Datum & Zeit:</span>
                                <span class="info-value">${reservationDateTime}</span>
                            </div>
                            ${reservation.customer_code ? `
                            <div class="info-item">
                                <span class="info-label">üîë Kunden-Code:</span>
                                <span class="info-value" style="color: var(--gold); font-weight: 700; font-family: monospace; letter-spacing: 1px;">${reservation.customer_code}</span>
                            </div>
                            ` : ''}
                            <div class="info-item">
                                <span class="info-label">Kunde:</span>
                                <span class="info-value">${reservation.first_name || ''} ${reservation.last_name || ''}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Telefon:</span>
                                <span class="info-value">${reservation.phone || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">E-Mail:</span>
                                <span class="info-value">${reservation.email || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Personen:</span>
                                <span class="info-value">${reservation.guests || 1}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tisch:</span>
                                <span class="info-value" style="color: ${reservation.table_number ? 'var(--gold)' : 'rgba(255,255,255,.5)'}; font-weight: ${reservation.table_number ? '700' : '400'};">
                                    ${reservation.table_number || 'N/A'}
                                </span>
                                ${!reservation.table_number ? `
                                <button class="btn-action btn-view" onclick="assignTableToReservation('${reservationId}')" style="margin-left: 10px; padding: 6px 14px; font-size: 12px; border-radius: 8px;">Tisch zuweisen</button>
                                ` : ''}
                            </div>
                        </div>
                        ${reservation.note ? `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                                <strong style="color: #fbbf24;">Hinweis:</strong>
                                <p style="color: rgba(255,255,255,.8); margin: 4px 0 0 0;">${reservation.note}</p>
                            </div>
                        ` : ''}
                        <div class="card-actions">
                            ${status === 'pending' ? `
                                <button class="btn-action btn-confirm" onclick="confirmReservation('${reservationId}')">‚úì Best√§tigen</button>
                                <button class="btn-action btn-cancel" onclick="cancelReservation('${reservationId}')">‚úó Stornieren</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Global variables for time scheduling
        let pendingOrderId = null;
        let pendingReservationId = null;
        let isOrderConfirmation = false;

        // Filter orders
        function filterOrders() {
            const searchTerm = document.getElementById('orderSearch')?.value.toLowerCase() || '';
            const cards = document.querySelectorAll('.order-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const matchesSearch = !searchTerm || text.includes(searchTerm);
                card.style.display = matchesSearch ? '' : 'none';
            });
        }

        // Filter orders by status
        function filterOrdersByStatus(status) {
            // Update active button
            const filterButtons = document.querySelectorAll('#ordersContent .filter-btn');
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                // Set active on button with matching data-status
                if (btn.getAttribute('data-status') === status) {
                    btn.classList.add('active');
                }
            });
            
            // Reload orders with new filter
            loadOrders(false); // Not silent, not preserving scroll
        }

        // Filter reservations
        function filterReservations() {
            const searchTerm = document.getElementById('reservationSearch')?.value.toLowerCase() || '';
            // Reservations use order-card class in displayReservations function
            const cards = document.querySelectorAll('#reservationsList .order-card, #reservationsList [data-reservation-id]');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const matchesSearch = !searchTerm || text.includes(searchTerm);
                card.style.display = matchesSearch ? '' : 'none';
            });
        }

        // Filter reservations by status
        function filterReservationsByStatus(status) {
            console.log('üîç Filter reservations by status:', status);
            
            // Update active button in reservationsContent only
            const reservationsContent = document.getElementById('reservationsContent');
            if (!reservationsContent) {
                console.error('‚ùå reservationsContent not found!');
                return;
            }
            
            const filterButtons = reservationsContent.querySelectorAll('.filter-btn');
            console.log('Found filter buttons:', filterButtons.length);
            
            if (filterButtons.length === 0) {
                console.error('‚ùå No filter buttons found in reservationsContent!');
                return;
            }
            
            filterButtons.forEach(btn => {
                const btnStatus = btn.getAttribute('data-status');
                btn.classList.remove('active');
                // Set active on button with matching data-status
                if (btnStatus === status) {
                    btn.classList.add('active');
                    console.log('‚úÖ Activated button with status:', status, btn);
                }
            });
            
            // Verify active button
            const activeButton = reservationsContent.querySelector('.filter-btn.active[data-status]');
            console.log('Active button after update:', activeButton?.getAttribute('data-status'));
            
            // Reload reservations with new filter
            loadReservations(false); // Not silent, not preserving scroll
        }


        // Filter customers
        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
            const cards = document.querySelectorAll('.customer-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const email = card.getAttribute('data-customer-email')?.toLowerCase() || '';
                const phone = card.getAttribute('data-customer-phone')?.toLowerCase() || '';
                const customerCode = card.getAttribute('data-customer-code')?.toLowerCase() || '';
                const matchesSearch = !searchTerm || text.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm) || customerCode.includes(searchTerm);
                card.style.display = matchesSearch ? '' : 'none';
            });
        }

        // Show time schedule modal
        function showTimeScheduleModal(orderId, isOrder = true) {
            console.log('‚è∞ showTimeScheduleModal called:', { orderId, isOrder });
            
            // Store in global variables
            pendingOrderId = isOrder ? orderId : null;
            pendingReservationId = !isOrder ? orderId : null;
            isOrderConfirmation = isOrder;
            
            // Also store in modal data attributes as backup
            const modal = document.getElementById('timeScheduleModal');
            if (!modal) {
                console.error('‚ùå Time schedule modal not found!');
                alert('Fehler: Zeitplan-Modal nicht gefunden. Bitte Seite aktualisieren.');
                return;
            }
            
            modal.dataset.orderId = isOrder ? orderId : '';
            modal.dataset.reservationId = !isOrder ? orderId : '';
            modal.dataset.isOrder = isOrder ? 'true' : 'false';
            
            // Reset time inputs
            const hoursInput = document.getElementById('scheduleHours');
            const minutesInput = document.getElementById('scheduleMinutes');
            
            if (hoursInput) hoursInput.value = '0';
            if (minutesInput) minutesInput.value = '30'; // Default 30 minutes
            
            modal.classList.add('active');
            console.log('‚úÖ Time schedule modal shown with data:', {
                pendingOrderId,
                pendingReservationId,
                isOrderConfirmation,
                modalData: {
                    orderId: modal.dataset.orderId,
                    reservationId: modal.dataset.reservationId,
                    isOrder: modal.dataset.isOrder
                }
            });
        }

        // Close time schedule modal
        function closeTimeScheduleModal() {
            const modal = document.getElementById('timeScheduleModal');
            if (modal) {
                modal.classList.remove('active');
            }
            pendingOrderId = null;
            pendingReservationId = null;
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTimeScheduleModal();
            }
        });

        // Set quick time
        function setQuickTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            document.getElementById('scheduleHours').value = hours;
            document.getElementById('scheduleMinutes').value = mins;
        }

        // Confirm with scheduled time
        async function confirmWithScheduledTime() {
            console.log('‚è∞ confirmWithScheduledTime called');
            
            // Get IDs from modal data attributes (backup if global variables are lost)
            const modal = document.getElementById('timeScheduleModal');
            const modalOrderId = modal?.dataset.orderId || '';
            const modalReservationId = modal?.dataset.reservationId || '';
            const modalIsOrder = modal?.dataset.isOrder === 'true';
            
            // Use global variables first, fallback to modal data
            const orderId = pendingOrderId || modalOrderId;
            const reservationId = pendingReservationId || modalReservationId;
            const isOrder = isOrderConfirmation !== undefined ? isOrderConfirmation : modalIsOrder;
            
            console.log('üìã IDs from variables:', { pendingOrderId, pendingReservationId, isOrderConfirmation });
            console.log('üìã IDs from modal:', { modalOrderId, modalReservationId, modalIsOrder });
            console.log('üìã Final IDs:', { orderId, reservationId, isOrder });
            
            const hours = parseInt(document.getElementById('scheduleHours')?.value) || 0;
            const minutes = parseInt(document.getElementById('scheduleMinutes')?.value) || 0;
            
            if (hours === 0 && minutes === 0) {
                alert('Bitte geben Sie die geplante Zeit ein (mindestens 1 Minute)');
                return;
            }
            
            const totalMinutes = hours * 60 + minutes;
            const estimatedTime = new Date();
            estimatedTime.setMinutes(estimatedTime.getMinutes() + totalMinutes);
            const estimatedTimeText = estimatedTime.toLocaleString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            console.log('üìÖ Scheduled time:', { hours, minutes, totalMinutes, estimatedTimeText });
            
            // Close modal first (but keep IDs)
            if (modal) {
                modal.classList.remove('active');
            }
            
            // Confirm based on type
            if (isOrder && orderId) {
                console.log('‚úÖ Confirming order:', orderId);
                await confirmOrderWithTime(orderId, estimatedTimeText, totalMinutes);
            } else if (!isOrder && reservationId) {
                // Reservations don't need time scheduling - use customer's selected time
                console.log('‚ö†Ô∏è Reservation confirmation should not use time modal. Use confirmReservation() directly.');
                alert('Reservierungen verwenden die vom Kunden gew√§hlte Zeit. Bitte verwenden Sie die Best√§tigung direkt.');
                return;
            } else {
                console.error('‚ùå No pending order or reservation ID found!');
                console.error('Debug info:', {
                    isOrder,
                    orderId,
                    reservationId,
                    pendingOrderId,
                    pendingReservationId,
                    isOrderConfirmation,
                    modalData: modal?.dataset
                });
                alert('Fehler: Keine Bestellung oder Reservierung zum Best√§tigen gefunden. Bitte versuchen Sie es erneut.');
                return;
            }
            
            // Clear variables after successful confirmation
            pendingOrderId = null;
            pendingReservationId = null;
            if (modal) {
                modal.dataset.orderId = '';
                modal.dataset.reservationId = '';
                modal.dataset.isOrder = '';
            }
        }

        // Confirm order
        async function confirmOrder(orderId) {
            console.log('üîî confirmOrder called with orderId:', orderId);
            if (!orderId) {
                console.error('‚ùå No orderId provided to confirmOrder');
                alert('Fehler: Bestell-ID nicht gefunden');
                return;
            }
            showTimeScheduleModal(orderId, true);
        }

        // Confirm order with scheduled time
        async function confirmOrderWithTime(orderId, estimatedTimeText, totalMinutes) {
            console.log('üîÑ confirmOrderWithTime called:', { orderId, estimatedTimeText, totalMinutes });
            
            if (!orderId) {
                console.error('‚ùå No orderId provided!');
                alert('Fehler: Bestell-ID nicht gefunden');
                return;
            }
            
            // Get order from API
            let order = null;
            try {
                const response = await fetch(`api/v1/data/orders?action=get&order_id=${orderId}`);
                const data = await response.json();
                if (data.success && data.order) {
                    order = data.order;
                }
                } catch (error) {
                console.error('Failed to get order from API:', error);
            }
            
            // If not found, try to get from current loaded orders
            if (!order && allOrdersData) {
                order = allOrdersData.find(o => o.order_id === orderId);
            }
            
            if (!order) {
                alert('Bestellung nicht gefunden!');
                return;
            }
            
            // Update order status via API
            try {
                const response = await fetch('api/v1/data/orders?action=update-status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: 'confirmed'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Order status updated successfully');
                    order.status = 'confirmed';
                } else {
                    throw new Error(data.message || 'Fehler beim Aktualisieren');
                }
                } catch (error) {
                console.error('‚ùå Failed to update order:', error);
                    alert('Fehler beim Aktualisieren des Bestellstatus: ' + error.message);
                return;
            }
            
            // Prepare delivery address object (ALWAYS define it, even if no email)
            const customerEmail = order.delivery?.address?.email || order.delivery?.email || order.email || order.delivery_address?.email || '';
            
            // Prepare delivery address object - ALWAYS define it
            let deliveryAddress = order.delivery?.address || order.delivery_address || {};
            
            // If delivery_address is a JSON string, parse it
            if (typeof deliveryAddress === 'string') {
                try {
                    deliveryAddress = JSON.parse(deliveryAddress);
                } catch (e) {
                    deliveryAddress = {};
                }
            }
            
            // Ensure all fields are set
            deliveryAddress = {
                email: deliveryAddress.email || customerEmail || '',
                firstName: deliveryAddress.firstName || deliveryAddress.first_name || order.firstName || '',
                lastName: deliveryAddress.lastName || deliveryAddress.last_name || order.lastName || '',
                phone: deliveryAddress.phone || order.phone || '',
                street: deliveryAddress.street || order.street || '',
                postal: deliveryAddress.postal || order.postal || '',
                city: deliveryAddress.city || order.city || '',
                note: deliveryAddress.note || order.note || '',
                customerCode: deliveryAddress.customerCode || order.customerCode || ''
            };
            
            // Send confirmation email to customer with estimated time
            if (customerEmail && customerEmail.trim() !== '') {
                try {
                    if (typeof sendCustomerConfirmationEmail === 'function' || typeof window.sendCustomerConfirmationEmail === 'function') {
                        const emailFunction = sendCustomerConfirmationEmail || window.sendCustomerConfirmationEmail;
                        
                        console.log('üìß Sending confirmation email to:', deliveryAddress.email);
                        console.log('üìß Delivery address object:', deliveryAddress);
                        
                        emailFunction(order, deliveryAddress, true, estimatedTimeText);
                        console.log('‚úÖ Email function called successfully');
                    } else {
                        console.warn('‚ö†Ô∏è sendCustomerConfirmationEmail function not found');
                        console.warn('Available functions:', Object.keys(window).filter(k => k.toLowerCase().includes('email')));
                    }
                } catch (emailError) {
                    console.error('‚ùå Error sending email:', emailError);
                    console.error('Error stack:', emailError.stack);
                    // Continue even if email fails
                }
            } else {
                console.warn('‚ö†Ô∏è No customer email found in order');
                console.warn('Order data:', {
                    hasDelivery: !!order.delivery,
                    hasAddress: !!order.delivery?.address,
                    email: order.delivery?.address?.email,
                    orderEmail: order.email
                });
            }
            
            // Generate and show print bills (customer receipt and kitchen ticket)
            try {
                // Wait a bit for script.js to fully load
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Try multiple ways to call showPrintBills
                let printFunction = null;
                
                // Check in order: window.showPrintBills, global showPrintBills
                if (typeof window.showPrintBills === 'function') {
                    printFunction = window.showPrintBills;
                    console.log('‚úÖ Found showPrintBills via window.showPrintBills');
                } else if (typeof showPrintBills === 'function') {
                    printFunction = showPrintBills;
                    console.log('‚úÖ Found showPrintBills via global scope');
                } else {
                    console.error('‚ùå showPrintBills function not found!');
                    console.log('Available window functions:', Object.keys(window).filter(k => k.toLowerCase().includes('print') || k.toLowerCase().includes('bill')));
                    
                    // Try to wait a bit more and check again
                    await new Promise(resolve => setTimeout(resolve, 500));
                    if (typeof window.showPrintBills === 'function') {
                        printFunction = window.showPrintBills;
                        console.log('‚úÖ Found showPrintBills after waiting');
                    }
                }
                
                if (printFunction) {
                    console.log('üñ®Ô∏è Calling showPrintBills...', {
                        orderId: orderId,
                        hasAddress: !!deliveryAddress,
                        deliveryAddress: deliveryAddress,
                        orderItems: order.items?.length || 0,
                        orderData: order
                    });
                    
                    // Call print function (include geplante Zeit f√ºr Billdruck)
                    // IMPORTANT: use the deliveryAddress object we built above,
                    // so that name / phone / address are always filled correctly on the bill.
                    printFunction(order, deliveryAddress, orderId, estimatedTimeText);
                    console.log('‚úÖ Print bills function called successfully');
                } else {
                    console.error('‚ùå showPrintBills function still not found after retry!');
                    alert('‚ö†Ô∏è Rechnung konnte nicht ge√∂ffnet werden.\n\nBitte:\n1. √úberpr√ºfen Sie, ob script.js vollst√§ndig geladen wurde\n2. √ñffnen Sie die Konsole (F12) f√ºr Details\n3. Versuchen Sie, die Admin-Seite zu aktualisieren');
                }
            } catch (error) {
                console.error('‚ùå Error showing print bills:', error);
                console.error('Error stack:', error.stack);
                alert('Fehler beim Anzeigen der Rechnung:\n' + error.message + '\n\nBitte √∂ffnen Sie die Konsole (F12) f√ºr Details.');
            }
            
            // Show beautiful success notification
            showAdminSuccessNotification(order, orderId);
            
            // Reload orders immediately to show updated status (only refresh, don't reload page)
            console.log('üîÑ Refreshing orders to show updated status...');
            await loadOrders(true); // Silent mode - just refresh data
        }

        // Cancel order
        async function cancelOrder(orderId) {
            if (!confirm('M√∂chten Sie diese Bestellung wirklich stornieren?')) return;
            
            // Update order status in Firebase
            if (typeof window !== 'undefined' && window.db) {
                try {
                    await db.collection('orders').doc(orderId).update({
                        status: 'cancelled',
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Order cancelled in Firebase:', orderId);
                    alert('Bestellung storniert!');
                    // Only refresh orders list, don't reload entire page
                    await loadOrders(true); // Silent mode
                } catch (error) {
                    console.error('Failed to cancel order in Firebase:', error);
                    alert('Fehler beim Stornieren der Bestellung. Bitte versuchen Sie es erneut.');
                }
            } else {
                alert('Firebase nicht verf√ºgbar. Bestellung konnte nicht storniert werden.');
            }
        }

        // Confirm reservation (using customer's selected time)
        async function confirmReservation(reservationId) {
            // Get reservation from API
            let reservation = null;
            try {
                const response = await fetch(`api/v1/data/reservations?action=get&reservation_id=${reservationId}`);
                const data = await response.json();
                if (data.success && data.reservation) {
                    reservation = data.reservation;
                }
                } catch (error) {
                console.error('Failed to get reservation from API:', error);
                    alert('Reservierung nicht gefunden!');
                return;
            }
            
            if (!reservation) {
                alert('Reservierung nicht gefunden!');
                return;
            }
            
            // Format the customer's selected time
            const customerTime = reservation.time || '';
            const customerDate = reservation.date || '';
            let formattedTime = '';
            
            if (customerTime) {
                // Format time from "HH:MM:SS" or "HH:MM" to "HH:MM Uhr"
                const timeParts = customerTime.split(':');
                if (timeParts.length >= 2) {
                    formattedTime = `${timeParts[0]}:${timeParts[1]} Uhr`;
                } else {
                    formattedTime = customerTime;
                }
            }
            
            // Update reservation status via API
            try {
                const response = await fetch('api/v1/data/reservations/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        status: 'confirmed'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Reservation confirmed:', reservationId);
                } else {
                    throw new Error(data.message || 'Fehler beim Best√§tigen');
                }
                } catch (error) {
                console.error('Failed to update reservation:', error);
                    alert('Fehler beim Best√§tigen der Reservierung. Bitte versuchen Sie es erneut.');
                    return;
            }
            
            // Send confirmation email to customer with their selected time
            if (reservation.email && typeof sendReservationConfirmationEmail === 'function') {
                sendReservationConfirmationEmail(reservation, formattedTime);
            }
            
            // Show beautiful success notification (same style as order confirmation)
            showAdminReservationSuccessNotification(reservation, reservationId, formattedTime);
            
            // Only refresh reservations list, don't reload entire page
            await loadReservations();
        }

        // Cancel reservation
        async function cancelReservation(reservationId) {
            if (!confirm('M√∂chten Sie diese Reservierung wirklich stornieren?')) return;
            
            // Update reservation status via API
            try {
                const response = await fetch('api/v1/data/reservations/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        status: 'cancelled'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Reservation cancelled:', reservationId);
                    alert('Reservierung storniert!');
                    await loadReservations();
                } else {
                    throw new Error(data.message || 'Fehler beim Stornieren');
                }
                } catch (error) {
                console.error('Failed to cancel reservation:', error);
                    alert('Fehler beim Stornieren der Reservierung. Bitte versuchen Sie es erneut.');
            }
        }

        // Assign table to order
        async function assignTable(orderId) {
            const tableNumber = prompt('Tischnummer eingeben (1-16):');
            if (!tableNumber) return;
            
            const tableNum = parseInt(tableNumber);
            if (isNaN(tableNum) || tableNum < 1 || tableNum > 16) {
                alert('Ung√ºltige Tischnummer. Bitte geben Sie eine Zahl von 1 bis 16 ein.');
                return;
            }
            
            // Update order table number via API
            try {
                const response = await fetch('api/v1/data/orders?action=update-status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        table_id: tableNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Table assigned:', orderId, 'Table:', tableNum);
                    alert(`Tisch ${tableNum} wurde f√ºr Bestellung #${orderId.slice(-8)} zugewiesen`);
                    await loadOrders(true); // Silent mode
                } else {
                    throw new Error(data.message || 'Fehler beim Zuweisen');
                }
                } catch (error) {
                console.error('Failed to assign table:', error);
                    alert('Fehler beim Zuweisen des Tisches. Bitte versuchen Sie es erneut.');
            }
        }

        // Make assignTable globally available
        window.assignTable = assignTable;

        // Assign table to reservation
        async function assignTableToReservation(reservationId) {
            const tableNumber = prompt('Tischnummer eingeben (1-16):');
            if (!tableNumber) return;
            
            const tableNum = parseInt(tableNumber);
            if (isNaN(tableNum) || tableNum < 1 || tableNum > 16) {
                alert('Ung√ºltige Tischnummer. Bitte geben Sie eine Zahl von 1 bis 16 ein.');
                return;
            }
            
            // Update reservation table number via API
            try {
                const response = await fetch('api/v1/data/reservations/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reservation_id: reservationId,
                        table_number: tableNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Table assigned to reservation:', reservationId, 'Table:', tableNum);
                    alert(`Tisch ${tableNum} wurde f√ºr Reservierung #${reservationId.toString().replace('RES-', '').slice(-8)} zugewiesen`);
                    await loadReservations(); // Reload reservations
                } else {
                    throw new Error(data.message || 'Fehler beim Zuweisen');
                }
            } catch (error) {
                console.error('Failed to assign table to reservation:', error);
                alert('Fehler beim Zuweisen des Tisches. Bitte versuchen Sie es erneut.');
            }
        }

        // Make assignTableToReservation globally available
        window.assignTableToReservation = assignTableToReservation;

        // Export all data (orders and reservations) to JSON file
        async function exportAllData() {
            const today = new Date().toISOString().split('T')[0];
            
            // Get all orders from Firebase
            let allOrders = [];
            if (typeof window !== 'undefined' && window.db && typeof getAllOrdersFromFirebase === 'function') {
                try {
                    allOrders = await getAllOrdersFromFirebase() || [];
                } catch (error) {
                    console.error('Failed to load orders from Firebase:', error);
                    alert('Fehler beim Laden der Bestellungen. Bitte versuchen Sie es erneut.');
                    return;
                }
            }
            
            // Get all reservations from Firebase
            let allReservations = [];
            if (typeof window !== 'undefined' && window.db && typeof getAllReservationsFromFirebase === 'function') {
                try {
                    allReservations = await getAllReservationsFromFirebase() || [];
                } catch (error) {
                    console.error('Failed to load reservations from Firebase:', error);
                    alert('Fehler beim Laden der Reservierungen. Bitte versuchen Sie es erneut.');
                    return;
                }
            }
            
            // Filter today's orders
            const todayOrders = allOrders.filter(o => {
                const orderDate = o.date || (o.createdAt ? new Date(o.createdAt.seconds ? o.createdAt.seconds * 1000 : o.createdAt).toISOString().split('T')[0] : null);
                return orderDate === today;
            });
            
            // Combine all data
            const exportData = {
                export_date: new Date().toISOString(),
                orders: {
                    today: todayOrders,
                    all: allOrders
                },
                reservations: {
                    all: allReservations
                },
                statistics: {
                    total_orders: allOrders.length,
                    total_reservations: allReservations.length,
                    today_orders: todayOrders.length
                }
            };
            
            // Create and download JSON file
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `leo_sushi_data_${today}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Daten wurden erfolgreich exportiert!');
        }

        window.exportAllData = exportAllData;

        // View order details
        async function viewOrderDetails(orderId) {
            // Get order from Firebase (PRIMARY SOURCE)
            let order = null;
            if (typeof db !== 'undefined' && db && typeof getOrderFromFirebase === 'function') {
                try {
                    order = await getOrderFromFirebase(orderId);
                } catch (error) {
                    console.error('Failed to get order from Firebase:', error);
                }
            }
            
            if (!order) {
                alert('Bestellung nicht gefunden!');
                return;
            }
            
            const orderTime = order.summary?.timestamp || order.createdAt
                ? new Date(order.summary?.timestamp || order.createdAt).toLocaleString('de-DE')
                : 'Unbekannt';
            
            const orderIdShort = order.order_id.toString().replace('ORD-', '').slice(-8);
            
            const scheduledTime = order.delivery_address?.scheduled_time || order.delivery?.scheduled_time || order.scheduled_delivery_time || order.summary?.scheduled_delivery_time;
            const scheduledTimeStr = scheduledTime ? (() => {
                const scheduledDate = scheduledTime?.date || scheduledTime?.datetime?.split('T')[0] || '';
                const scheduledTimeValue = scheduledTime?.time || scheduledTime?.datetime?.split('T')[1]?.substring(0, 5) || '';
                const formattedDate = scheduledDate ? new Date(scheduledDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                return `${formattedDate} um ${scheduledTimeValue} Uhr`;
            })() : null;
            
            const details = `
Bestellung #${orderIdShort}

Zeit: ${orderTime}
${scheduledTimeStr ? `Gew√ºnschte Lieferzeit: ${scheduledTimeStr}` : ''}
Kunde: ${order.delivery?.address?.firstName || ''} ${order.delivery?.address?.lastName || ''}
Telefon: ${order.delivery?.address?.phone || 'N/A'}
E-Mail: ${order.delivery?.address?.email || 'N/A'}
Adresse: ${order.delivery?.address?.street || ''}, ${order.delivery?.address?.postal || ''} ${order.delivery?.address?.city || ''}
Zahlung: ${order.summary?.payment_method === 'cash' ? 'Barzahlung' : 'Kartenzahlung'}
Status: ${order.status || 'pending'}

Artikel:
${order.items?.map(item => `  ${item.quantity}x ${item.name}${item.note ? ` (${item.note})` : ''} - ‚Ç¨${item.total}`).join('\n') || 'Keine'}

Zwischensumme: ‚Ç¨${order.summary?.subtotal || '0.00'}
Lieferung: ‚Ç¨${order.summary?.delivery_fee || '0.00'}
Gesamt: ‚Ç¨${order.summary?.total || '0.00'}

${order.delivery?.address?.note ? `Hinweis: ${order.delivery.address.note}` : ''}
            `.trim();
            
            alert(details);
        }

        // Send order confirmation email (admin action)
        function sendOrderConfirmationEmail(order) {
            if (typeof emailjs === 'undefined' || !EMAILJS_CONFIG) return;
            
            const templateParams = {
                to_email: order.delivery?.address?.email,
                customer_name: `${order.delivery?.address?.firstName || ''} ${order.delivery?.address?.lastName || ''}`.trim() || 'Liebe/r Kunde/in',
                order_id: order.order_id || order.summary?.timestamp || 'N/A',
                order_time: order.summary?.timestamp ? new Date(order.summary.timestamp).toLocaleString('de-DE') : 'Unbekannt',
                items: order.items?.map(item => `${item.quantity}x ${item.name} - ‚Ç¨${item.total}`).join('\n') || 'Keine',
                total: `‚Ç¨${order.summary?.total || '0.00'}`,
                restaurant_name: 'LEO SUSHI',
                restaurant_address: 'Florastra√üe 10A, 13187 Berlin',
                restaurant_phone: '+49 30 37476736'
            };
            
            emailjs.send(
                EMAILJS_CONFIG.SERVICE_ID,
                EMAILJS_CONFIG.CUSTOMER_TEMPLATE_ID || EMAILJS_CONFIG.TEMPLATE_ID,
                templateParams
            ).then(() => {
                console.log('Order confirmation email sent');
            }).catch(error => {
                console.error('Failed to send order confirmation email:', error);
            });
        }

        // Show beautiful admin success notification
        function showAdminSuccessNotification(order, orderId) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'admin-success-notification';
            notification.id = 'adminSuccessNotification';
            notification.innerHTML = `
                <div class="admin-success-content">
                    <div class="admin-success-icon">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="32" fill="url(#adminSuccessGradient)"/>
                            <path d="M20 32L28 40L44 24" stroke="#1a1a1a" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                            <defs>
                                <linearGradient id="adminSuccessGradient" x1="0" y1="0" x2="64" y2="64">
                                    <stop offset="0%" stop-color="#10b981"/>
                                    <stop offset="100%" stop-color="#059669"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <h2 class="admin-success-title">Bestellung best√§tigt!</h2>
                    <p class="admin-success-message">
                        Bestellung <strong>#${orderId.replace('ORD-', '').slice(-8)}</strong> wurde erfolgreich best√§tigt.
                    </p>
                    <div class="admin-success-details">
                        <div class="admin-detail-item">
                            <span class="admin-detail-label">Kunde:</span>
                            <span class="admin-detail-value">${order.delivery?.address?.firstName || ''} ${order.delivery?.address?.lastName || ''}</span>
                        </div>
                        <div class="admin-detail-item">
                            <span class="admin-detail-label">Gesamt:</span>
                            <span class="admin-detail-value" style="color: var(--gold);">‚Ç¨${order.summary?.total || '0.00'}</span>
                        </div>
                    </div>
                    <div class="admin-success-actions">
                        <div class="admin-action-item">
                            <div class="admin-action-icon">üìß</div>
                            <div class="admin-action-text">
                                <strong>E-Mail gesendet</strong><br>
                                <span>Best√§tigungs-E-Mail wurde an den Kunden gesendet.</span>
                            </div>
                        </div>
                        <div class="admin-action-item">
                            <div class="admin-action-icon">üñ®Ô∏è</div>
                            <div class="admin-action-text">
                                <strong>Rechnung gedruckt</strong><br>
                                <span>Kundenrechnung und K√ºchenticket wurden gedruckt.</span>
                            </div>
                        </div>
                    </div>
                    <button class="admin-success-btn" onclick="closeAdminSuccessNotification()">Verstanden</button>
                </div>
            `;
            
            // Add styles if not already added
            if (!document.getElementById('adminSuccessNotificationStyles')) {
                const style = document.createElement('style');
                style.id = 'adminSuccessNotificationStyles';
                style.textContent = `
                    .admin-success-notification {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.85);
                        backdrop-filter: blur(8px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    .admin-success-content {
                        background: linear-gradient(180deg, #1a1a1a, #0f0f11);
                        border: 1px solid rgba(229, 207, 142, 0.2);
                        border-radius: 24px;
                        padding: 40px;
                        max-width: 500px;
                        width: 90%;
                        text-align: center;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                        animation: slideUp 0.4s ease;
                    }
                    @keyframes slideUp {
                        from {
                            transform: translateY(30px);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    .admin-success-icon {
                        margin: 0 auto 24px;
                        animation: scaleIn 0.5s ease 0.2s both;
                    }
                    @keyframes scaleIn {
                        from { transform: scale(0); }
                        to { transform: scale(1); }
                    }
                    .admin-success-title {
                        font-family: "Playfair Display", serif;
                        font-size: 32px;
                        color: #fff;
                        margin: 0 0 16px;
                        font-weight: 700;
                    }
                    .admin-success-message {
                        color: rgba(255, 255, 255, 0.8);
                        font-size: 16px;
                        line-height: 1.6;
                        margin: 0 0 24px;
                    }
                    .admin-success-message strong {
                        color: var(--gold);
                        font-weight: 600;
                    }
                    .admin-success-details {
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(255, 255, 255, 0.08);
                        border-radius: 12px;
                        padding: 20px;
                        margin: 0 0 24px;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    .admin-detail-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 0;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                    }
                    .admin-detail-item:last-child {
                        border-bottom: none;
                    }
                    .admin-detail-label {
                        color: rgba(255, 255, 255, 0.6);
                        font-size: 14px;
                    }
                    .admin-detail-value {
                        color: #fff;
                        font-weight: 600;
                        font-size: 16px;
                    }
                    .admin-success-actions {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        margin: 0 0 24px;
                    }
                    .admin-action-item {
                        background: rgba(16, 185, 129, 0.1);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        border-radius: 12px;
                        padding: 16px;
                        display: flex;
                        align-items: flex-start;
                        gap: 12px;
                        text-align: left;
                        animation: slideIn 0.4s ease 0.3s both;
                    }
                    @keyframes slideIn {
                        from {
                            opacity: 0;
                            transform: translateX(-10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    .admin-action-icon {
                        font-size: 24px;
                        flex-shrink: 0;
                        margin-top: 2px;
                    }
                    .admin-action-text {
                        flex: 1;
                    }
                    .admin-action-text strong {
                        color: #10b981;
                        font-size: 15px;
                        display: block;
                        margin-bottom: 6px;
                    }
                    .admin-action-text span {
                        color: rgba(255, 255, 255, 0.8);
                        font-size: 13px;
                        line-height: 1.5;
                    }
                    .admin-success-btn {
                        background: linear-gradient(180deg, var(--gold), var(--gold-2));
                        color: #1a1a1a;
                        border: none;
                        padding: 14px 32px;
                        border-radius: 100px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        width: 100%;
                    }
                    .admin-success-btn:hover {
                        filter: brightness(1.1);
                        transform: translateY(-2px);
                        box-shadow: 0 8px 20px rgba(194, 163, 85, 0.3);
                    }
                    @media (max-width: 640px) {
                        .admin-success-content {
                            padding: 32px 24px;
                        }
                        .admin-success-title {
                            font-size: 24px;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto close after 8 seconds
            setTimeout(() => {
                closeAdminSuccessNotification();
            }, 8000);
        }

        // Show beautiful admin reservation success notification
        function showAdminReservationSuccessNotification(reservation, reservationId, formattedTime) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'admin-success-notification';
            notification.id = 'adminReservationSuccessNotification';
            
            const reservationDateFormatted = reservation.date ? new Date(reservation.date).toLocaleDateString('de-DE', {
                weekday: 'long',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            }) : '';
            
            notification.innerHTML = `
                <div class="admin-success-content">
                    <div class="admin-success-icon">
                        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="32" fill="url(#adminReservationSuccessGradient)"/>
                            <path d="M20 32L28 40L44 24" stroke="#1a1a1a" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                            <defs>
                                <linearGradient id="adminReservationSuccessGradient" x1="0" y1="0" x2="64" y2="64">
                                    <stop offset="0%" stop-color="#10b981"/>
                                    <stop offset="100%" stop-color="#059669"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <h2 class="admin-success-title">Reservierung best√§tigt!</h2>
                    <p class="admin-success-message">
                        Reservierung <strong>#${reservationId.replace('RES-', '').slice(-8)}</strong> wurde erfolgreich best√§tigt.
                    </p>
                    <div class="admin-success-details">
                        <div class="admin-detail-item">
                            <span class="admin-detail-label">Kunde:</span>
                            <span class="admin-detail-value">${reservation.first_name || ''} ${reservation.last_name || ''}</span>
                        </div>
                        <div class="admin-detail-item">
                            <span class="admin-detail-label">Datum & Zeit:</span>
                            <span class="admin-detail-value" style="color: var(--gold);">${reservationDateFormatted} um ${formattedTime || reservation.time || ''}</span>
                        </div>
                        <div class="admin-detail-item">
                            <span class="admin-detail-label">Personen:</span>
                            <span class="admin-detail-value">${reservation.guests || 1}</span>
                        </div>
                    </div>
                    <div class="admin-success-actions">
                        <div class="admin-action-item">
                            <div class="admin-action-icon">üìß</div>
                            <div class="admin-action-text">
                                <strong>E-Mail gesendet</strong><br>
                                <span>Best√§tigungs-E-Mail wurde an den Kunden gesendet.</span>
                            </div>
                        </div>
                    </div>
                    <button class="admin-success-btn" onclick="closeAdminReservationSuccessNotification()">Verstanden</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto close after 8 seconds
            setTimeout(() => {
                closeAdminReservationSuccessNotification();
            }, 8000);
        }

        // Close admin reservation success notification
        function closeAdminReservationSuccessNotification() {
            const notification = document.getElementById('adminReservationSuccessNotification');
            if (notification) {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // Close admin success notification
        function closeAdminSuccessNotification() {
            const notification = document.getElementById('adminSuccessNotification');
            if (notification) {
                notification.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // Make functions globally available
        window.closeAdminSuccessNotification = closeAdminSuccessNotification;
        window.closeAdminReservationSuccessNotification = closeAdminReservationSuccessNotification;

        // Check admin login status (server-side)
        async function checkAdminLogin() {
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/session')}`, {
                    method: 'GET',
                    credentials: 'include' // Important for session cookies
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.warn('Admin login check returned non-JSON:', text.substring(0, 200));
                    // If not logged in, that's okay - just show login modal
                    const loginModal = document.getElementById('adminLoginModal');
                    if (loginModal) loginModal.style.display = 'flex';
                    return false;
                }
                
                const data = await response.json();
                const isLoggedIn = data.success && data.logged_in === true;
                
            const loginModal = document.getElementById('adminLoginModal');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminStatus = document.getElementById('adminStatus');
                const passwordInput = document.getElementById('adminPassword');
            
            if (isLoggedIn) {
                if (loginModal) loginModal.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
                if (adminStatus) adminStatus.textContent = '‚úì Angemeldet';
                    if (passwordInput) passwordInput.value = ''; // Clear password
            } else {
                if (loginModal) loginModal.style.display = 'flex';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (adminStatus) adminStatus.textContent = '';
                }
                
                return isLoggedIn;
            } catch (error) {
                console.error('Error checking admin login:', error);
                // On error, show login modal
                const loginModal = document.getElementById('adminLoginModal');
                if (loginModal) loginModal.style.display = 'flex';
                return false;
            }
        }

        // Handle admin login - Step 1: Send verification code
        async function handleAdminLogin() {
            const password = document.getElementById('adminPassword')?.value;
            const loginBtn = document.querySelector('#loginStep1 .btn-confirm');
            const originalBtnText = loginBtn?.textContent;
            
            if (!password) {
                showMenuNotification('‚ùå Bitte geben Sie ein Passwort ein.', 'error');
                return;
            }
            
            // Disable button and show loading
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Wird gepr√ºft...';
            }
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/auth/send-code')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ password: password })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    showMenuNotification('‚ùå Server-Fehler. Bitte versuchen Sie es erneut.', 'error');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Show step 2 (verification code)
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2').style.display = 'block';
                    document.getElementById('adminVerificationCode').focus();
                    showMenuNotification('‚úÖ Best√§tigungscode wurde an Ihre E-Mail gesendet.', 'success');
                } else {
                    const message = data.message || 'Falsches Passwort';
                    const attemptsRemaining = data.attempts_remaining;
                    let errorMsg = `‚ùå ${message}`;
                    if (attemptsRemaining !== undefined) {
                        errorMsg += ` (${attemptsRemaining} Versuche verbleibend)`;
                    }
                    console.error('Login failed:', data);
                    showMenuNotification(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error during admin login:', error);
                showMenuNotification('‚ùå Fehler beim Senden des Codes. Bitte versuchen Sie es erneut.', 'error');
            } finally {
                // Re-enable button
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = originalBtnText || 'Weiter';
                }
            }
        }
        
        // Handle verification code - Step 2: Verify and login
        async function handleVerifyCode() {
            const code = document.getElementById('adminVerificationCode')?.value;
            const verifyBtn = document.querySelector('#loginStep2 .btn-confirm');
            const originalBtnText = verifyBtn?.textContent;
            
            if (!code || code.length !== 6) {
                showMenuNotification('‚ùå Bitte geben Sie den 6-stelligen Code ein.', 'error');
                return;
            }
            
            // Disable button and show loading
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.textContent = 'Wird gepr√ºft...';
            }
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/auth/verify-code')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ code: code })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from verify-code:', text);
                    showMenuNotification('‚ùå Server-Fehler. Bitte versuchen Sie es erneut.', 'error');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification('‚úÖ Erfolgreich angemeldet!', 'success');
                    // Clear inputs
                    if (document.getElementById('adminPassword')) {
                        document.getElementById('adminPassword').value = '';
                    }
                    if (document.getElementById('adminVerificationCode')) {
                        document.getElementById('adminVerificationCode').value = '';
                    }
                    // Reset to step 1
                    document.getElementById('loginStep1').style.display = 'block';
                    document.getElementById('loginStep2').style.display = 'none';
                    await checkAdminLogin();
                } else {
                    const message = data.message || 'Ung√ºltiger Code';
                    console.error('Verify code failed:', data);
                    showMenuNotification(`‚ùå ${message}`, 'error');
                }
            } catch (error) {
                console.error('Error during code verification:', error);
                showMenuNotification('‚ùå Fehler bei der Code-Verifizierung. Bitte versuchen Sie es erneut.', 'error');
            } finally {
                // Re-enable button
                if (verifyBtn) {
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = originalBtnText || 'Code best√§tigen';
                }
            }
        }
        
        // Resend verification code
        async function resendVerificationCode() {
            const password = document.getElementById('adminPassword')?.value;
            
            if (!password) {
                showMenuNotification('‚ùå Bitte geben Sie zuerst Ihr Passwort ein.', 'error');
                backToPasswordStep();
                return;
            }
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/auth/send-code')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification('‚úÖ Neuer Best√§tigungscode wurde gesendet.', 'success');
                } else {
                    showMenuNotification(`‚ùå ${data.message || 'Fehler beim Senden des Codes'}`, 'error');
                }
            } catch (error) {
                console.error('Error resending code:', error);
                showMenuNotification('‚ùå Fehler beim Senden des Codes.', 'error');
            }
        }
        
        // Back to password step
        function backToPasswordStep() {
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2').style.display = 'none';
            document.getElementById('adminVerificationCode').value = '';
            document.getElementById('adminPassword').focus();
        }

        // Handle admin logout (server-side)
        async function handleAdminLogout() {
            if (!confirm('M√∂chten Sie sich abmelden?')) {
                return;
            }
            
            try {
                // Localhost: g·ªçi tr·ª±c ti·∫øp router PHP ƒë·ªÉ tr√°nh ph·ª• thu·ªôc mod_rewrite
                const response = await fetch(`api/index.php?route=${encodeURIComponent('v1/session/end')}`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMenuNotification('‚úÖ Erfolgreich abgemeldet!', 'success');
                    await checkAdminLogin();
                } else {
                    showMenuNotification('‚ùå Fehler beim Abmelden.', 'error');
                }
            } catch (error) {
                console.error('Error during admin logout:', error);
                // Force logout on client side even if server request fails
                await checkAdminLogin();
            }
        }
        
        // Auto-check session every 2 minutes (to detect if logged in elsewhere)
        setInterval(async () => {
            await checkAdminLogin();
        }, 120000); // 2 minutes

        // Make functions globally available
        window.handleAdminLogin = handleAdminLogin;
        window.handleVerifyCode = handleVerifyCode;
        window.resendVerificationCode = resendVerificationCode;
        window.backToPasswordStep = backToPasswordStep;
        window.handleAdminLogout = handleAdminLogout;
        window.filterOrders = filterOrders;
        window.filterOrdersByStatus = filterOrdersByStatus;
        window.filterReservations = filterReservations;
        window.filterReservationsByStatus = filterReservationsByStatus;
        window.setQuickTime = setQuickTime;
        window.confirmWithScheduledTime = confirmWithScheduledTime;
        window.closeTimeScheduleModal = closeTimeScheduleModal;
        window.applyDateFilter = applyDateFilter;
        window.closeNewOrderNotification = closeNewOrderNotification;
        window.viewNewOrder = viewNewOrder;
        window.testNotificationSound = testNotificationSound;
        window.loadCustomers = loadCustomers;
        window.filterCustomers = filterCustomers;

        // Wait for scripts to load before initializing
        function waitForScripts() {
            return new Promise((resolve) => {
                // Check if Firebase and script.js are loaded
                const checkScripts = setInterval(() => {
                    if (typeof firebase !== 'undefined' && typeof window !== 'undefined' && window.db) {
                        // Check if required functions are available
                        const hasPrintBills = typeof showPrintBills === 'function' || typeof window.showPrintBills === 'function';
                        const hasEmailFunction = typeof sendCustomerConfirmationEmail === 'function' || typeof window.sendCustomerConfirmationEmail === 'function';
                        
                        if (hasPrintBills && hasEmailFunction) {
                            console.log('‚úÖ All scripts loaded including showPrintBills and sendCustomerConfirmationEmail');
                        } else {
                            if (!hasPrintBills) console.warn('‚ö†Ô∏è showPrintBills not yet available, will retry...');
                            if (!hasEmailFunction) console.warn('‚ö†Ô∏è sendCustomerConfirmationEmail not yet available, will retry...');
                        }
                        clearInterval(checkScripts);
                        resolve();
                    }
                }, 100);
                
                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkScripts);
                    console.log('Script loading timeout, continuing anyway...');
                    resolve(); // Continue even if scripts not loaded
                }, 5000);
            });
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìã Admin panel DOMContentLoaded');
            console.log('  - firebase:', typeof firebase !== 'undefined' ? 'loaded' : 'not loaded');
            console.log('  - window.db:', typeof window !== 'undefined' ? window.db : 'window undefined');
            console.log('  - window.FIREBASE_CONFIG:', typeof window !== 'undefined' ? window.FIREBASE_CONFIG : 'window undefined');
            
            // Show loading state
            const ordersList = document.getElementById('ordersList');
            const reservationsList = document.getElementById('reservationsList');
            if (ordersList) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon" style="animation: spin 1s linear infinite;">‚è≥</div>
                        <p>Daten werden geladen...</p>
                    </div>
                `;
            }
            if (reservationsList) {
                reservationsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon" style="animation: spin 1s linear infinite;">‚è≥</div>
                        <p>Daten werden geladen...</p>
                    </div>
                `;
            }
            
            // Wait for scripts to load
            await waitForScripts();
            
            // Double-check Firebase after waiting
            console.log('üìã After waitForScripts:');
            console.log('  - window.db:', typeof window !== 'undefined' ? window.db : 'window undefined');
            console.log('  - window.FIREBASE_CONFIG:', typeof window !== 'undefined' ? window.FIREBASE_CONFIG : 'window undefined');
            
            // If Firebase still not initialized, try to initialize manually
            if (typeof window !== 'undefined' && typeof firebase !== 'undefined' && !window.db) {
                console.log('‚ö†Ô∏è Firebase not initialized, trying to initialize manually...');
                try {
                    if (window.FIREBASE_CONFIG) {
                        let app;
                        try {
                            app = firebase.app();
                            console.log('‚úÖ Firebase app exists');
                        } catch (e) {
                            app = firebase.initializeApp(window.FIREBASE_CONFIG);
                            console.log('‚úÖ Firebase initialized manually');
                        }
                        window.db = firebase.firestore();
                        console.log('‚úÖ window.db set manually:', !!window.db);
                    }
                } catch (error) {
                    console.error('‚ùå Error initializing Firebase manually:', error);
                }
            }
            
            // Request notification permission
            requestNotificationPermission();
            
            // Check admin login (but don't block data loading)
            await checkAdminLogin();
            
            // Initial load (silent - don't show notifications for existing orders)
            // Load data even if not logged in (for viewing)
            try {
                await loadAllData(true);
            } catch (error) {
                console.error('Error loading data:', error);
                // Show error message
                const ordersList = document.getElementById('ordersList');
                if (ordersList) {
                    ordersList.innerHTML = `
                        <div class="empty-state" style="background: rgba(239,68,68,.1); border: 2px solid rgba(239,68,68,.3);">
                            <div class="empty-state-icon">‚ùå</div>
                            <h3>Fehler beim Laden der Daten</h3>
                            <p>${error.message || 'Daten konnten nicht geladen werden'}</p>
                            <button class="btn-action btn-view" onclick="loadAllData()" style="margin-top: 12px;">Erneut versuchen</button>
                        </div>
                    `;
                }
            }
            
            // Auto-refresh every 15 seconds (only if logged in) - check for new orders
            // Smart refresh: kh√¥ng l√†m gi√°n ƒëo·∫°n thao t√°c c·ªßa user
            setInterval(() => {
                if (localStorage.getItem('leo_admin_logged_in') !== 'true') {
                    return;
                }
                
                // Kh√¥ng refresh n·∫øu:
                // 1. User ƒëang t∆∞∆°ng t√°c (click, type) trong 2 gi√¢y g·∫ßn ƒë√¢y
                // 2. C√≥ modal ƒëang m·ªü
                // 3. Refresh b·ªã pause
                if (isUserInteracting || isModalOpen() || refreshPaused) {
                    console.log('‚è∏Ô∏è Refresh skipped - user is interacting or modal is open');
                    return;
                }
                
                    // Only refresh current tab's data, don't reload page
                    const activeTab = document.querySelector('.admin-tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.trim();
                        if (tabName === 'Bestellungen') {
                        loadOrders(true, true); // Silent mode + preserve scroll
                        } else if (tabName === 'Reservierungen') {
                        loadReservations(true); // Preserve scroll
                        } else if (tabName === 'Kunden') {
                        // loadCustomers(); // Skip customers tab refresh to avoid disruption
                        }
                    }
            }, 15000); // Check every 15 seconds for updates
        });
    </script>
</body>
</html>


