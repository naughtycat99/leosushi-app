<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Bestellungen - LEO SUSHI</title>
    <meta name="theme-color" content="#0b0b0c">
    <link rel="icon" href="assets/logo.png">
    <link rel="apple-touch-icon" href="assets/logo.png">
    <link rel="stylesheet" href="styles.css">
    <!-- Leaflet CSS for OpenStreetMap -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background: linear-gradient(180deg, #09090a, #0b0b0c 30%, #0b0b0c 70%, #0a0a0b);
            min-height: 100vh;
        }

        .orders-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 60px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .orders-wrapper {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .orders-sidebar {
                order: 2;
            }

            .orders-main {
                order: 1;
            }
        }

        /* Sidebar Navigation */
        .orders-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .orders-nav {
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.95), rgba(15, 15, 17, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 207, 142, 0.15);
            border-radius: 16px;
            padding: 24px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .orders-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .orders-nav-item:hover {
            background: rgba(229, 207, 142, 0.1);
            color: var(--gold);
            border-left-color: var(--gold);
        }

        .orders-nav-item.active {
            background: rgba(229, 207, 142, 0.15);
            color: var(--gold);
            border-left-color: var(--gold);
            font-weight: 600;
        }

        .orders-nav-item span:first-child {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .orders-main {
            min-height: 600px;
        }

        .orders-header {
            margin-bottom: 30px;
        }

        .orders-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--gold);
        }

        .orders-header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--gold);
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .back-link:hover {
            opacity: 0.8;
        }

        .orders-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            padding: 16px;
            background: rgba(18, 18, 20, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(229, 207, 142, 0.1);
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(229, 207, 142, 0.3);
        }

        .filter-btn.active {
            background: rgba(229, 207, 142, 0.15);
            border-color: var(--gold);
            color: var(--gold);
        }

        .order-card {
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.95), rgba(15, 15, 17, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 207, 142, 0.15);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .order-card:hover {
            border-color: rgba(229, 207, 142, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 28px rgba(0, 0, 0, 0.4);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .order-id {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--gold-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .order-date {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .order-date::before {
            content: 'üìÖ';
            font-size: 12px;
        }

        .order-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .order-status.confirmed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .order-status.completed {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .order-info-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .order-info-value {
            font-size: 15px;
            color: var(--text);
            font-weight: 600;
        }

        .order-items {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-items-title {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .order-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(229, 207, 142, 0.2);
        }

        .order-item-name {
            color: var(--text);
            font-weight: 500;
            flex: 1;
        }

        .order-item-qty {
            color: rgba(255, 255, 255, 0.5);
            margin: 0 12px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .order-item-price {
            color: var(--gold);
            font-weight: 700;
            font-size: 15px;
        }

        .order-total {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid rgba(229, 207, 142, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(229, 207, 142, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-left: -32px;
            margin-right: -32px;
            margin-bottom: -32px;
            padding-left: 32px;
            padding-right: 32px;
        }

        .order-total-label {
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-total-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--gold);
        }

        .order-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-review {
            background: linear-gradient(135deg, rgba(229, 207, 142, 0.15), rgba(229, 207, 142, 0.1));
            border: 1px solid rgba(229, 207, 142, 0.3);
            color: var(--gold);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-review:hover {
            background: linear-gradient(135deg, rgba(229, 207, 142, 0.25), rgba(229, 207, 142, 0.15));
            border-color: rgba(229, 207, 142, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 207, 142, 0.2);
        }

        .btn-review:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Review Modal */
        .review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .review-modal-content {
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.98), rgba(15, 15, 17, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(229, 207, 142, 0.3);
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .review-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .review-modal-header h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            margin: 0;
        }

        .review-modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .review-modal-close:hover {
            color: var(--gold);
        }

        .review-form-group {
            margin-bottom: 24px;
        }

        .review-form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .star-rating-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .star-rating-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s;
            line-height: 1;
        }

        .star-rating-btn:hover {
            transform: scale(1.2);
        }

        .review-comment {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(229, 207, 142, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .review-comment:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.08);
        }

        .review-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-review-submit {
            background: linear-gradient(135deg, var(--gold), var(--gold-2));
            border: none;
            color: #1a1a1a;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-review-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 207, 142, 0.4);
        }

        .btn-review-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-review-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-review-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: rgba(255, 255, 255, 0.5);
            background: linear-gradient(135deg, rgba(18, 18, 20, 0.5), rgba(15, 15, 17, 0.5));
            border: 1px solid rgba(229, 207, 142, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.4;
            filter: grayscale(0.5);
        }

        .empty-state h3 {
            font-size: 24px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 12px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 24px;
        }

        .empty-state a {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gold), var(--gold-2));
            color: #1a1a1a;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .empty-state a:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(229, 207, 142, 0.4);
        }

        .loading {
            text-align: center;
            padding: 100px 40px;
            color: rgba(255, 255, 255, 0.5);
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(229, 207, 142, 0.2);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Order Tracking Map Styles */
        .order-tracking-map-container {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(229, 207, 142, 0.2);
            height: 400px;
            background: rgba(255, 255, 255, 0.02);
        }

        .order-tracking-map {
            width: 100%;
            height: 100%;
        }

        .track-order-btn {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3b82f6;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .track-order-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .tracking-info {
            margin-top: 12px;
            padding: 12px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container nav">
            <a class="brand" href="/">
                <img src="assets/logo.png" alt="LEO SUSHI" class="brand-logo">
                <span class="brand-name">LEO SUSHI</span>
            </a>
            <nav id="primaryNav" class="menu" role="navigation" aria-label="Hauptnavigation">
                <a href="catalog" id="menuLink">Men√º</a>
                <a href="/#about">√úber uns</a>
                <a href="/#reviews">Bewertungen</a>
                <a href="/#contact">Kontakt</a>
                <a href="book-table" style="color: var(--gold); font-weight: 600;">Reservieren</a>
                <!-- User Menu (shown when logged in) -->
                <div class="user-menu-wrapper" id="userMenuWrapper" style="display: none;">
                    <button class="notification-toggle" id="notificationToggle" aria-label="Benachrichtigungen">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="user-menu">
                        <button class="user-menu-toggle" id="userMenuToggle" aria-label="Benutzermen√º">
                            <span class="user-avatar" id="userAvatar">üë§</span>
                            <span class="user-name" id="userName">Benutzer</span>
                            <span class="user-chevron">‚ñº</span>
                        </button>
                        <div class="user-menu-dropdown" id="userMenuDropdown">
                            <div class="user-info">
                                <div class="user-email" id="userEmail"></div>
                                <div class="user-status" id="userStatus"></div>
                            </div>
                            <a href="account" class="user-menu-item">
                                <span>üë§</span> Mein Profil
                            </a>
                            <a href="orders" class="user-menu-item">
                                <span>üì¶</span> Meine Bestellungen
                            </a>
                            <a href="rewards" class="user-menu-item">
                                <span>‚≠ê</span> Meine Punkte
                            </a>
                            <a href="#" class="user-menu-item" id="logoutBtn">
                                <span>üö™</span> Abmelden
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="orders-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="orders-sidebar">
            <nav class="orders-nav">
                <a href="account" class="orders-nav-item">
                    <span>üë§</span>
                    <span>Profil</span>
                </a>
                <a href="orders" class="orders-nav-item active">
                    <span>üì¶</span>
                    <span>Bestellungen</span>
                </a>
                <a href="rewards" class="orders-nav-item">
                    <span>‚≠ê</span>
                    <span>Punkte</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="orders-main">
            <div class="orders-header">
                <h1>Meine Bestellungen</h1>
                <p>√úbersicht aller Ihrer Bestellungen</p>
            </div>

            <div class="orders-filter">
                <button class="filter-btn active" data-status="all" onclick="filterOrders('all')">Alle</button>
                <button class="filter-btn" data-status="pending" onclick="filterOrders('pending')">Ausstehend</button>
                <button class="filter-btn" data-status="confirmed"
                    onclick="filterOrders('confirmed')">Best√§tigt</button>
                <button class="filter-btn" data-status="completed"
                    onclick="filterOrders('completed')">Abgeschlossen</button>
                <button class="filter-btn" data-status="cancelled"
                    onclick="filterOrders('cancelled')">Storniert</button>
            </div>

            <div id="loadingMessage" class="loading">
                <p>Lade Bestellungen...</p>
            </div>

            <div id="ordersList"></div>
        </main>
    </div>
    </div>

    <script>
        // API base URL is auto-detected by js/api.js from current location
        // Only override for localhost development
        // Check if running in Capacitor (iOS uses capacitor:// protocol, Android may use http://localhost but with X-Requested-With header)
        const isCapacitorInfo = window.location.protocol === 'capacitor:' || window.location.search.includes('mock-app');

        // Only override for localhost development if NOT in Capacitor
        if (!isCapacitorInfo && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
            window.API_BASE_URL = window.location.origin + (window.location.pathname.includes('/leosushi') ? '/leosushi/api' : '/api');
            window.API_PHP_BASE_URL = window.API_BASE_URL;
        }
        // Production: js/api.js will auto-detect HTTPS and correct path
    </script>
    <script src="js/api.js"></script>
    <script src="js/auth-mysql.js"></script>
    <script src="js/header-auth.js"></script>
    <script src="js/notifications.js"></script>
    <!-- Leaflet JS for OpenStreetMap -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/order-tracking.js"></script>

    <script>
        let currentUser = null;
        let allOrders = [];
        let currentFilter = 'all';

        // Format price
        function formatPrice(price) {
            if (typeof price === 'string') {
                price = price.replace(/[^\d,.-]/g, '').replace(',', '.');
            }
            const num = parseFloat(price) || 0;
            return num.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ausstehend',
                'confirmed': 'Best√§tigt',
                'completed': 'Abgeschlossen',
                'cancelled': 'Storniert'
            };
            return statusMap[status] || status;
        }

        // Load orders
        async function loadOrders() {
            const loadingMessage = document.getElementById('loadingMessage');
            const ordersList = document.getElementById('ordersList');

            try {
                // Check if user is logged in
                if (!window.getCurrentUser || typeof window.getCurrentUser !== 'function') {
                    window.location.href = '/';
                    return;
                }

                currentUser = await window.getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    window.location.href = '/';
                    return;
                }

                // Load orders from API
                // Auto-detect API URL if not set
                const apiBase = window.API_PHP_BASE_URL || (() => {
                    const protocol = window.location.protocol;
                    const host = window.location.host;
                    const path = window.location.pathname.includes('/leosushi') ? '/leosushi/api' : '/api';
                    return `${protocol}//${host}${path}`;
                })();
                const apiUrl = `${apiBase}/orders.php?action=list`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result && result.success && result.orders) {
                    // Filter orders by user email
                    allOrders = result.orders.filter(order => {
                        const orderEmail = order.delivery_address?.email ||
                            (typeof order.delivery_address === 'string' ? JSON.parse(order.delivery_address).email : null) ||
                            order.delivery?.address?.email ||
                            order.customer?.email || '';
                        return orderEmail && orderEmail.toLowerCase() === currentUser.email.toLowerCase();
                    });

                    // Sort by date (newest first)
                    allOrders.sort((a, b) => {
                        const dateA = new Date(a.date || a.created_at || a.createdAt || 0);
                        const dateB = new Date(b.date || b.created_at || b.createdAt || 0);
                        return dateB - dateA;
                    });

                    renderOrders();
                } else {
                    allOrders = [];
                    renderOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                loadingMessage.innerHTML = `
                    <p style="color: #ff6666;">Fehler beim Laden der Bestellungen. Bitte versuchen Sie es erneut.</p>
                `;
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        // Filter orders
        function filterOrders(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');

            renderOrders();
        }

        // Render orders
        function renderOrders() {
            const ordersList = document.getElementById('ordersList');

            // Filter orders
            let filteredOrders = allOrders;
            if (currentFilter !== 'all') {
                filteredOrders = allOrders.filter(order => order.status === currentFilter);
            }

            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>Keine Bestellungen gefunden</h3>
                        <p>Sie haben noch keine Bestellungen ${currentFilter !== 'all' ? 'mit diesem Status' : ''}.</p>
                        <a href="catalog">Jetzt bestellen ‚Üí</a>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = filteredOrders.map(order => {
                const orderId = order.order_id || order._id || 'N/A';
                const orderIdShort = orderId.toString().replace(/^(LEO-|ORD-)/, '').slice(-8);
                const status = order.status || 'pending';
                const date = order.date || order.created_at || order.createdAt || new Date().toISOString();

                // Parse items (could be JSON string or object)
                let items = [];
                if (order.items) {
                    if (typeof order.items === 'string') {
                        try {
                            items = JSON.parse(order.items);
                        } catch (e) {
                            items = [];
                        }
                    } else {
                        items = order.items;
                    }
                }

                // Parse summary (could be JSON string or object)
                let summary = {};
                if (order.summary) {
                    if (typeof order.summary === 'string') {
                        try {
                            summary = JSON.parse(order.summary);
                        } catch (e) {
                            summary = {};
                        }
                    } else {
                        summary = order.summary;
                    }
                }

                const total = summary.total || order.order_total || '0,00 ‚Ç¨';
                const serviceType = order.service_type === 'delivery' ? 'Lieferung' :
                    order.service_type === 'pickup' ? 'Abholung' : 'Reservierung';

                // Parse delivery_address (could be JSON string or object)
                let address = {};
                if (order.delivery_address) {
                    if (typeof order.delivery_address === 'string') {
                        try {
                            address = JSON.parse(order.delivery_address);
                        } catch (e) {
                            address = {};
                        }
                    } else {
                        address = order.delivery_address;
                    }
                } else if (order.delivery?.address) {
                    address = order.delivery.address;
                }

                const estimatedTime = order.estimated_time || order.estimatedTime || null;

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">Bestellung #${orderIdShort}</div>
                                <div class="order-date">${formatDate(date)}</div>
                            </div>
                            <span class="order-status ${status}">${getStatusText(status)}</span>
                        </div>
                        
                        <div class="order-info">
                            <div class="order-info-item">
                                <span class="order-info-label">üöö Service</span>
                                <span class="order-info-value">${serviceType}</span>
                            </div>
                            ${address.street ? `
                            <div class="order-info-item">
                                <span class="order-info-label">üìç Adresse</span>
                                <span class="order-info-value">${address.street}, ${address.postal} ${address.city}</span>
                            </div>
                            ` : ''}
                            ${estimatedTime ? `
                            <div class="order-info-item">
                                <span class="order-info-label">üïí Geplante Zeit</span>
                                <span class="order-info-value">${estimatedTime}</span>
                            </div>
                            ` : ''}
                        </div>

                        ${items.length > 0 ? `
                        <div class="order-items">
                            <div class="order-items-title">üçΩÔ∏è Bestellte Artikel (${items.length})</div>
                            ${items.map(item => `
                                <div class="order-item">
                                    <span class="order-item-name">${item.name || ''}</span>
                                    <span style="display: flex; align-items: center; gap: 12px;">
                                        <span class="order-item-qty">x${item.qty || item.quantity || 1}</span>
                                        <span class="order-item-price">${formatPrice(item.total || item.price || 0)}</span>
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        <div class="order-total">
                            <span class="order-total-label">Gesamt</span>
                            <span class="order-total-value">${formatPrice(total)}</span>
                        </div>
                        
                        ${(status === 'confirmed' || status === 'in_delivery') && address.street ? `
                        <div class="order-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button class="track-order-btn" onclick="toggleOrderTracking('${orderId}', ${JSON.stringify(order).replace(/"/g, '&quot;')})">
                                üó∫Ô∏è Bestellung verfolgen
                            </button>
                            <div id="trackingMap_${orderId}" class="order-tracking-map-container" style="display: none;">
                                <div id="map_${orderId}" class="order-tracking-map"></div>
                            </div>
                            <div id="trackingInfo_${orderId}" class="tracking-info" style="display: none;"></div>
                        </div>
                        ` : ''}
                        ${status === 'completed' ? `
                        <div class="order-actions" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <button class="btn-review" onclick="openReviewModal('${orderId}', '${orderIdShort}')" data-order-id="${orderId}">
                                ‚≠ê Bewertung abgeben
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Check which orders already have reviews
            checkExistingReviews();
        }

        // Check existing reviews for orders
        async function checkExistingReviews() {
            try {
                if (!window.api || !window.api.reviews) return;

                const response = await window.api.reviews.list(100, 'approved');
                if (response.success && response.reviews) {
                    const reviewedOrderIds = new Set(response.reviews.map(r => r.order_id).filter(Boolean));

                    // Hide review button for orders that already have reviews
                    document.querySelectorAll('.btn-review').forEach(btn => {
                        const orderId = btn.getAttribute('data-order-id');
                        if (reviewedOrderIds.has(orderId)) {
                            btn.textContent = '‚úì Bereits bewertet';
                            btn.disabled = true;
                            btn.style.opacity = '0.6';
                            btn.style.cursor = 'not-allowed';
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking existing reviews:', error);
            }
        }

        // Open review modal
        function openReviewModal(orderId, orderIdShort) {
            currentReviewOrderId = orderId;
            currentReviewOrderIdShort = orderIdShort;
            document.getElementById('reviewModal').style.display = 'flex';
            document.getElementById('reviewRating').value = '5';
            document.getElementById('reviewComment').value = '';
            updateStarDisplay(5);
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            currentReviewOrderId = null;
            currentReviewOrderIdShort = null;
        }

        // Update star display
        function updateStarDisplay(rating) {
            const stars = document.querySelectorAll('.star-rating-btn');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.textContent = '‚≠ê';
                    star.style.opacity = '1';
                } else {
                    star.textContent = '‚òÜ';
                    star.style.opacity = '0.4';
                }
            });
        }

        // Submit review
        async function submitReview() {
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value.trim();

            if (!rating || rating < 1 || rating > 5) {
                alert('Bitte w√§hlen Sie eine Bewertung von 1 bis 5 Sternen.');
                return;
            }

            if (!currentUser || !currentUser.id) {
                alert('Bitte melden Sie sich an, um eine Bewertung abzugeben.');
                return;
            }

            try {
                const submitBtn = document.getElementById('submitReviewBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Wird gesendet...';

                const reviewData = {
                    customer_id: currentUser.id,
                    order_id: currentReviewOrderId,
                    rating: rating,
                    comment: comment
                };

                if (window.api && window.api.reviews) {
                    const response = await window.api.reviews.create(reviewData);

                    if (response.success) {
                        alert('Vielen Dank f√ºr Ihre Bewertung! Sie wird nach der √úberpr√ºfung ver√∂ffentlicht.');
                        closeReviewModal();
                        loadOrders(); // Reload to update review status
                    } else {
                        alert('Fehler beim Senden der Bewertung: ' + (response.message || 'Unbekannter Fehler'));
                    }
                } else {
                    throw new Error('Reviews API nicht verf√ºgbar');
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                alert('Fehler beim Senden der Bewertung. Bitte versuchen Sie es sp√§ter erneut.');
            } finally {
                const submitBtn = document.getElementById('submitReviewBtn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Bewertung absenden';
            }
        }

        let currentReviewOrderId = null;
        let currentReviewOrderIdShort = null;
        let activeTrackingOrders = new Map(); // Track which orders have active tracking

        // Toggle order tracking map
        function toggleOrderTracking(orderId, orderData) {
            const mapContainer = document.getElementById(`trackingMap_${orderId}`);
            const trackingInfo = document.getElementById(`trackingInfo_${orderId}`);
            const btn = event.target;

            if (mapContainer.style.display === 'none') {
                // Show map
                mapContainer.style.display = 'block';
                btn.textContent = 'üó∫Ô∏è Tracking ausblenden';

                // Initialize map if not already initialized
                if (!activeTrackingOrders.has(orderId)) {
                    setTimeout(() => {
                        if (typeof window.initOrderTrackingMap === 'function') {
                            window.initOrderTrackingMap(`map_${orderId}`, orderData);
                            activeTrackingOrders.set(orderId, true);

                            // Start real-time tracking
                            if (typeof window.startOrderTracking === 'function') {
                                window.startOrderTracking(orderId, (updatedOrder) => {
                                    // Update tracking info
                                    if (trackingInfo) {
                                        const status = updatedOrder.status || 'confirmed';
                                        const statusText = {
                                            'pending': 'Ausstehend',
                                            'confirmed': 'Best√§tigt - Vorbereitung',
                                            'in_delivery': 'Unterwegs',
                                            'completed': 'Zugestellt',
                                            'cancelled': 'Storniert'
                                        }[status] || status;

                                        trackingInfo.innerHTML = `
                                            <strong>Status:</strong> ${statusText}<br>
                                            ${updatedOrder.estimated_time ? `<strong>Gesch√§tzte Zeit:</strong> ${updatedOrder.estimated_time}` : ''}
                                        `;
                                    }
                                });
                            }
                        }
                    }, 100);
                }
            } else {
                // Hide map
                mapContainer.style.display = 'none';
                btn.textContent = 'üó∫Ô∏è Bestellung verfolgen';

                // Stop tracking
                if (typeof window.stopOrderTracking === 'function') {
                    window.stopOrderTracking();
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });
    </script>

    <!-- Review Modal -->
    <div class="review-modal" id="reviewModal" onclick="if(event.target.id === 'reviewModal') closeReviewModal()">
        <div class="review-modal-content" onclick="event.stopPropagation()">
            <div class="review-modal-header">
                <h3>‚≠ê Bewertung abgeben</h3>
                <button class="review-modal-close" onclick="closeReviewModal()" aria-label="Schlie√üen">√ó</button>
            </div>

            <div class="review-form-group">
                <label>Ihre Bewertung</label>
                <div class="star-rating-container">
                    <button class="star-rating-btn"
                        onclick="document.getElementById('reviewRating').value = '1'; updateStarDisplay(1);">‚òÜ</button>
                    <button class="star-rating-btn"
                        onclick="document.getElementById('reviewRating').value = '2'; updateStarDisplay(2);">‚òÜ</button>
                    <button class="star-rating-btn"
                        onclick="document.getElementById('reviewRating').value = '3'; updateStarDisplay(3);">‚òÜ</button>
                    <button class="star-rating-btn"
                        onclick="document.getElementById('reviewRating').value = '4'; updateStarDisplay(4);">‚òÜ</button>
                    <button class="star-rating-btn"
                        onclick="document.getElementById('reviewRating').value = '5'; updateStarDisplay(5);">‚òÜ</button>
                </div>
                <input type="hidden" id="reviewRating" value="5">
                <small style="color: rgba(255,255,255,0.5); font-size: 12px;">Klicken Sie auf die Sterne, um Ihre
                    Bewertung auszuw√§hlen</small>
            </div>

            <div class="review-form-group">
                <label for="reviewComment">Ihr Kommentar (optional)</label>
                <textarea id="reviewComment" class="review-comment" placeholder="Teilen Sie uns Ihre Erfahrung mit..."
                    maxlength="500"></textarea>
                <small style="color: rgba(255,255,255,0.5); font-size: 12px; display: block; margin-top: 8px;">
                    <span id="reviewCommentCount">0</span> / 500 Zeichen
                </small>
            </div>

            <div class="review-modal-actions">
                <button class="btn-review-cancel" onclick="closeReviewModal()">Abbrechen</button>
                <button class="btn-review-submit" id="submitReviewBtn" onclick="submitReview()">Bewertung
                    absenden</button>
            </div>
        </div>
    </div>

    <script>
        // Update character count
        document.getElementById('reviewComment')?.addEventListener('input', function () {
            document.getElementById('reviewCommentCount').textContent = this.value.length;
        });

        // Initialize star display
        if (document.getElementById('reviewRating')) {
            updateStarDisplay(5);
        }
    </script>
</body>

</html>