<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwort zurücksetzen - LEO SUSHI</title>
    <meta name="description" content="Setzen Sie Ihr LEO SUSHI Passwort zurück">
    <meta name="theme-color" content="#0b0b0c">
    <link rel="icon" href="assets/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-luxe.css">
    <style>
        body { background: linear-gradient(135deg, #0b0b0c 0%, #1a1a1c 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; font-family: 'Inter', sans-serif; color: #fff; }
        .reset-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 40px; max-width: 480px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); backdrop-filter: blur(20px); }
        h1 { font-family: 'Playfair Display', serif; font-size: 28px; color: var(--gold); margin-bottom: 8px; }
        p { color: rgba(255,255,255,0.75); font-size: 14px; margin-bottom: 24px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; color: rgba(255,255,255,0.9); }
        input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 15px; }
        input:focus { outline: none; border-color: var(--gold); background: rgba(255,255,255,0.08); }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--gold), #d4af37); color: #0b0b0c; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .message { border-radius: 10px; padding: 12px 14px; font-size: 14px; margin-bottom: 18px; display: none; }
        .message.error { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; }
        .message.success { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #86efac; }
        .back-link { text-align: center; margin-top: 18px; font-size: 14px; }
        .back-link a { color: var(--gold); text-decoration: none; font-weight: 600; }
        .back-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="reset-card">
        <h1>Passwort zurücksetzen</h1>
        <p>Erstellen Sie ein neues Passwort für Ihr LEO SUSHI Konto.</p>
        <div class="message" id="resetMessage"></div>
        <form id="resetForm">
            <input type="hidden" id="resetEmail">
            <input type="hidden" id="resetToken">
            <div class="form-group">
                <label>Neues Passwort</label>
                <input type="password" id="newPassword" required minlength="6" placeholder="Mindestens 6 Zeichen">
            </div>
            <div class="form-group">
                <label>Passwort bestätigen</label>
                <input type="password" id="confirmNewPassword" required minlength="6" placeholder="Passwort erneut eingeben">
            </div>
            <button type="submit" class="btn" id="resetBtn">Passwort speichern</button>
        </form>
        <div class="back-link">
            <a href="menu.html?auth=login">Zurück zur Anmeldung</a>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const token = urlParams.get('token');
        const messageBox = document.getElementById('resetMessage');
        const resetBtn = document.getElementById('resetBtn');
        const resetEmailInput = document.getElementById('resetEmail');
        const resetTokenInput = document.getElementById('resetToken');

        if (!email || !token) {
            showMessage('Ungültiger oder fehlender Reset-Link.', true);
            document.getElementById('resetForm').style.display = 'none';
        } else {
            resetEmailInput.value = email;
            resetTokenInput.value = token;
        }

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (password.length < 6) {
                showMessage('Passwort muss mindestens 6 Zeichen lang sein.', true);
                return;
            }
            if (password !== confirmPassword) {
                showMessage('Passwörter stimmen nicht überein.', true);
                return;
            }

            resetBtn.disabled = true;
            resetBtn.textContent = 'Speichern...';

            try {
                const response = await fetch('api/auth.php?action=reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: resetEmailInput.value,
                        token: resetTokenInput.value,
                        password,
                        confirmPassword
                    })
                });
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'Fehler beim Zurücksetzen des Passworts.');
                }
                showMessage(result.message || 'Passwort wurde erfolgreich geändert.', false);
                document.getElementById('resetForm').style.display = 'none';
            } catch (error) {
                showMessage(error.message, true);
                resetBtn.disabled = false;
                resetBtn.textContent = 'Passwort speichern';
            }
        });

        function showMessage(text, isError) {
            messageBox.textContent = text;
            messageBox.className = 'message ' + (isError ? 'error' : 'success');
            messageBox.style.display = 'block';
        }
    </script>
</body>
</html>

