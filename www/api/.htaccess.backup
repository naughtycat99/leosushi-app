# API Security
<IfModule mod_headers.c>
    # CORS headers (adjust as needed)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
</IfModule>

# Protect sensitive API files
<FilesMatch "^(config|security-config|change-admin-password)\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# URL Rewriting - Hide API endpoints from logs
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Auto-detect base path - works for both /leosushi/ and root /
    # RewriteBase is commented to allow automatic detection
    # RewriteBase /leosushi/
    
    # Fallback: Route all api/v1/... requests to index.php if file doesn't exist
    # This ensures routing works even if specific rewrite rules fail
    # Note: This rule is in api/.htaccess, so the path is relative to api/
    # TEMPORARILY DISABLED - Let physical files be served directly
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteCond %{REQUEST_FILENAME} !-d
    # RewriteCond %{REQUEST_URI} ^/?(leosushi/)?api/v1/ [NC]
    # RewriteRule ^v1/(.*)$ index.php [L,QSA]
    
    # Obfuscated routes - Hide actual API files (only if physical files don't exist)
    # Note: These rules are in api/.htaccess, so paths are relative to api/ directory
    # Since we now have physical files at api/v1/..., these rules are mainly for backward compatibility
    # TEMPORARILY DISABLED - Let physical files be served directly
    
    # Admin authentication (only if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/session$ admin-auth.php?action=check [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/auth$ admin-auth.php?action=login [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/auth/send-code$ admin-auth.php?action=send-code [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/auth/verify-code$ admin-auth.php?action=verify-code [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/session/end$ admin-auth.php?action=logout [L,QSA]
    
    # Orders (only rewrite if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/orders$ orders.php?action=list [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/orders/create$ orders.php?action=create [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/orders/update$ orders.php?action=update-status [L,QSA]
    
    # Menu (only rewrite if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/menu$ menu.php?action=list [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/menu/new$ menu.php?action=create [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/menu/edit$ menu.php?action=update [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/menu/remove$ menu.php?action=delete [L,QSA]
    
    # Customers (only rewrite if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/customers$ customers.php?action=list [L,QSA]
    
    # Points (only rewrite if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/points/rules$ points.php?action=rules [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/points/redeem$ points.php?action=redeem [L,QSA]
    
    # Reservations (only rewrite if physical file doesn't exist)
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/reservations$ reservations.php?action=list [L,QSA]
    # RewriteCond %{REQUEST_FILENAME} !-f
    # RewriteRule ^v1/data/reservations/update$ reservations.php?action=update [L,QSA]
    
    # Block direct access to sensitive PHP files (force through obfuscated routes)
    # This prevents these files from appearing in access logs
    # Works for both /leosushi/ and root / paths
    RewriteCond %{THE_REQUEST} \s+/(leosushi/)?api/(admin-auth|config|security-config|change-admin-password|route-obfuscator|routes)\.php[\s?] [NC]
    RewriteRule ^ - [F,L]
    
    # Hide actual PHP files from logs - rewrite to obfuscated routes
    # This way logs will show /api/v1/... instead of /api/admin-auth.php
    RewriteCond %{THE_REQUEST} \s+/(leosushi/)?api/(orders|menu|customers|points|reservations)\.php[\s?] [NC]
    RewriteCond %{QUERY_STRING} action=([^&]+) [NC]
    RewriteRule ^api/(orders|menu|customers|points|reservations)\.php$ api/v1/data/$2?action=%1 [R=301,L]
    
    # Allow direct access to other API files (for backward compatibility)
    # But prefer using obfuscated routes
</IfModule>

# Disable directory listing
Options -Indexes

# Prevent access to .htaccess
<Files .htaccess>
    Order Allow,Deny
    Deny from all
</Files>
