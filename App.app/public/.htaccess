# Force HTTPS redirect (if not already HTTPS)
# NOTE: Only enable this AFTER SSL certificate is properly configured on the server
# Uncomment the block below once SSL is working
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteCond %{HTTP_HOST} !^localhost [NC]
#     RewriteCond %{HTTP_HOST} !^127\.0\.0\.1 [NC]
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "DENY"
    
    # XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Force HTTPS (HSTS) - only on HTTPS connections
    # NOTE: Only enable this AFTER SSL certificate is properly configured
    # Uncomment the line below once SSL is working
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
</IfModule>

# Disable directory browsing
Options -Indexes

# Protect sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Protect config files
<FilesMatch "^(config|security-config|admin-auth)\.php$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Ensure PHP files are executed (especially in api/ directories)
<IfModule mod_php7.c>
    <FilesMatch "\.php$">
        SetHandler application/x-httpd-php
    </FilesMatch>
</IfModule>
<IfModule mod_php.c>
    <FilesMatch "\.php$">
        SetHandler application/x-httpd-php
    </FilesMatch>
</IfModule>
# For PHP-FPM
<IfModule mod_proxy_fcgi.c>
    <FilesMatch "\.php$">
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>
</IfModule>
# Fallback - ensure PHP type is set
AddType application/x-httpd-php .php
AddHandler application/x-httpd-php .php

# URL Rewriting - Hide actual file names
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Set RewriteBase for subdirectory installation
    RewriteBase /leosushi/
    
    # Route ALL API v1 requests to api/index.php router FIRST
    # This MUST come before all other rules to ensure API routing works
    # Force routing even if physical files exist in api/v1/data/
    # Match REQUEST_URI (absolute path) to catch all api/v1/ requests
    # IMPORTANT: This must come BEFORE the rule that allows existing PHP files
    RewriteCond %{REQUEST_URI} ^/leosushi/api/v1/ [NC]
    RewriteCond %{REQUEST_URI} !api/index\.php [NC]
    # Rewrite to absolute path to avoid RewriteBase issues
    # Force routing even if file exists (don't check -f)
    RewriteRule ^api/v1/(.*)$ /leosushi/api/index.php?route=v1/$1 [L,QSA]
    
    # Hide HTML/PHP files behind obfuscated routes
    # Only rewrite if the requested file doesn't exist
    # Admin panel
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^dashboard$ admin.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^control$ admin.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^admin-panel$ admin.html [L]
    
    # User pages
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^account$ profile.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^my-profile$ profile.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^my-account$ profile.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^orders$ my-orders.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^my-orders$ my-orders.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^order-history$ my-orders.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^points$ points.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^loyalty$ points.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^rewards$ points.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^reservation$ reservation.html [L]
    
    # Book table - direct rewrite (most common route)
    RewriteRule ^book-table/?$ reservation.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^table-booking$ reservation.html [L]
    
    # Checkout - direct rewrite (most common route)
    RewriteRule ^checkout/?$ checkout.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^payment$ checkout.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^order$ checkout.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^menu$ menu.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^catalog$ menu.html [L]
    
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^dishes$ menu.html [L]
    
    # Block direct access to HTML/PHP files (force through obfuscated routes)
    # Allow access to index.html and assets
    # Works for both /leosushi/ and root / paths
    # DISABLED - Allow direct access to admin.html
    # RewriteCond %{THE_REQUEST} \s+/(leosushi/)?(admin|profile|my-orders|points|reservation|checkout|menu)\.(html|php)[\s?] [NC]
    # RewriteCond %{REQUEST_URI} !^/(leosushi/)?index\.html$ [NC]
    # RewriteCond %{REQUEST_URI} !^/(leosushi/)?assets/ [NC]
    # RewriteRule ^ - [F,L]
    
    # Prevent access to logs directory
    RewriteRule ^logs/ - [F,L]
    
    # Ensure existing API PHP files (non-v1) are executed (don't rewrite them)
    # IMPORTANT: This must come AFTER the api/v1/ routing rule above
    # Skip this rule for api/v1/ requests (already handled above)
    RewriteCond %{REQUEST_URI} ^/(leosushi/)?api/ [NC]
    RewriteCond %{REQUEST_URI} !api/v1/ [NC]
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} \.php$ [NC]
    RewriteRule ^ - [L]
</IfModule>

# Rate limiting (if mod_evasive is available)
<IfModule mod_evasive20.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

